<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MAXI JDC MARKET ‚Äî Commande</title>

  <style>
    :root{
      --bg0:#0a1929;
      --bg1:#112240;
      --card:#1a365d;
      --card2:#162447;
      --line:rgba(255,255,255,.15);
      --text:#f0f6fc;
      --muted:#8b949e;
      --accent:#00ff88;
      --accent2:#00d4ff;
      --danger:#ff6b6b;
      --warning:#ffcc00;
      --shadow: 0 10px 40px rgba(0,0,0,.5);
      --radius:12px;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 100%);
      min-height:100vh;
      line-height:1.6;
    }
    .wrap{max-width:1240px;margin:20px auto;padding:0 20px 40px;}
    .top{
      background: rgba(10, 25, 47, 0.9);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 5;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }
    .topRow{display:flex;gap:20px;align-items:center;flex-wrap:wrap;}
    .brand{display:flex;gap:15px;align-items:center;min-width:280px;}
    .logo{
      width:60px;height:60px;border-radius:12px;border:2px solid var(--accent);
      overflow:hidden;flex:0 0 auto;display:grid;place-items:center;background:#0a1929;
      padding: 5px;
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block;}
    .brandText h1{
      margin:0;font-size:24px;font-weight:700;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .brandText p{margin:5px 0 0;color:var(--muted);font-size:14px;}
    .search{flex:1 1 400px;display:flex;gap:10px;align-items:center;}
    .search input{
      flex:1;height:46px;border-radius:8px;border:2px solid var(--line);
      background: rgba(255,255,255,.08); color: var(--text);
      padding:0 20px; outline:none;font-size:14px;
      transition: all 0.3s ease;
    }
    .search input:focus{
      border-color: var(--accent);
      background: rgba(255,255,255,.12);
      box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
    }
    .btn{
      height:46px;padding:0 24px;border-radius:8px;border:2px solid var(--line);
      background: rgba(255,255,255,.1); color: var(--text);
      cursor:pointer;font-weight:600;font-size:14px;
      transition: all 0.3s ease;
    }
    .btn:hover{ 
      background: rgba(255,255,255,.15);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .btn.green{
      background: rgba(0, 255, 136, 0.15);
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn.green:hover{ 
      background: rgba(0, 255, 136, 0.25);
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
    }
    .pills{
      margin-top:15px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding:10px 0;
    }
    .pill{
      display:inline-flex;gap:8px;align-items:center;padding:8px 16px;border-radius:20px;
      border:1px solid var(--line);background: rgba(255,255,255,.08);
      color: var(--text);font-size:13px;white-space:nowrap;
    }
    .pill strong{font-weight:700;color:var(--accent);}
    .cartPill{
      margin-left:auto;cursor:pointer;border:2px solid var(--accent);
      background:rgba(0, 255, 136, 0.1);color:var(--accent);
      font-weight:600;
    }
    .cartPill:hover{ 
      background:rgba(0, 255, 136, 0.2);
      transform: translateY(-2px);
    }
    #cartTopCount{
      margin-left:8px;display:inline-grid;place-items:center;min-width:26px;height:26px;padding:0 8px;
      border-radius:50%;background:rgba(0,0,0,.5);border:2px solid var(--accent);
      font-weight:700;color:var(--accent);
    }
    .noteBar{
      margin-top:15px;padding:15px;border-radius:var(--radius);border:1px solid rgba(0, 255, 136, 0.3);
      background: rgba(0, 255, 136, 0.05);color:var(--text);font-size:13px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .noteBar .ok{color:var(--accent);font-weight:600;display:inline-flex;gap:8px;align-items:center;}
    .noteBar .sub{margin-left:auto;color:var(--muted);font-size:12px;}
    .grid{
      margin-top:20px;
      display:grid;
      grid-template-columns:300px 1fr;
      gap:20px;
      align-items:start;
    }
    .panel{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:16px 20px;border-bottom:1px solid var(--line);background: rgba(255,255,255,.05);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panelHeader h3{
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--accent);
    }
    .panelHeader .sub{
      color:var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.05);
      padding: 4px 10px;
      border-radius: 20px;
    }
    #cats{
      padding:15px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .catBtn{
      width:100%;text-align:left;border-radius:10px;border:2px solid var(--line);
      background: rgba(255,255,255,.05); color: var(--text);
      padding:15px; cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:15px;
      transition: all 0.3s ease;
    }
    .catBtn:hover{ 
      background: rgba(255,255,255,.1);
      border-color: var(--accent2);
      transform: translateX(5px);
    }
    .catBtn.active{
      border-color: var(--accent);
      background: rgba(0, 255, 136, 0.1);
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.1);
    }
    .catLeft{display:flex;flex-direction:column;gap:5px;min-width:0;flex:1;}
    .catTitle{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--text);
    }
    .catMeta{
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .catCount{
      flex:0 0 auto;
      color:var(--accent);
      font-weight:700;
      font-size:12px;
      border:2px solid var(--accent);
      background: rgba(0, 255, 136, 0.1);
      border-radius:20px;
      padding:5px 12px;
      min-width: 70px;
      text-align: center;
    }
    .content{padding:20px;}
    .contentHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:15px;
      padding:0 0 20px 0;
      border-bottom: 1px solid var(--line);
      margin-bottom: 20px;
    }
    .contentHeader h2{
      margin:0;
      font-size:20px;
      font-weight:700;
      color:var(--text);
    }
    .contentHeader .meta{
      margin:5px 0 0;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pager{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }
    .iconBtn{
      width:40px;height:40px;border-radius:8px;border:2px solid var(--line);
      background: rgba(255,255,255,.08); cursor:pointer;color:var(--text);font-weight:700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .iconBtn:hover{ 
      background: rgba(255,255,255,.15);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    #products{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:20px;
    }
    .card{
      border-radius:12px;
      border:2px solid var(--line);
      background: var(--card2);
      padding:20px;
      box-shadow:0 5px 20px rgba(0,0,0,.3);
      min-width:0;
      transition: all 0.3s ease;
    }
    .card:hover{
      border-color: var(--accent2);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.1);
    }
    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      min-width:0;
      margin-bottom: 10px;
    }
    .name{
      font-weight:700;
      font-size:14px;
      line-height:1.4;
      min-width:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      color: var(--text);
    }
    .price{
      flex:0 0 auto;
      font-weight:700;
      padding:8px 15px;
      border-radius:20px;
      border:2px solid var(--accent);
      background: rgba(0, 255, 136, 0.1);
      color:var(--accent);
      font-size:13px;
      white-space:nowrap;
    }
    .meta2{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .qtyRow{
      margin-top:20px;
      display:flex;
      gap:15px;
      align-items:center;
      justify-content:space-between;
    }
    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px;
      border-radius:20px;
      border:2px solid var(--line);
      background: rgba(0,0,0,.2);
    }
    .stepper button{
      width:32px;height:32px;border-radius:50%;border:2px solid var(--line);
      background: rgba(255,255,255,.1);color:var(--text);cursor:pointer;font-weight:700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .stepper button:hover{ 
      background: rgba(255,255,255,.2);
      border-color: var(--accent);
    }
    .stepper span{
      min-width:25px;
      text-align:center;
      font-weight:700;
      color:var(--text);
      font-size:14px;
    }
    .addBtn{
      height:40px;
      padding:0 20px;
      border-radius:20px;
      border:2px solid var(--accent);
      background: rgba(0, 255, 136, 0.1);
      color:var(--accent);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: all 0.3s ease;
    }
    .addBtn:hover{ 
      background: rgba(0, 255, 136, 0.25);
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
      transform: translateY(-2px);
    }
    .drawer{
      position:fixed;top:0;right:0;height:100%;width:450px;max-width:95vw;
      background: rgba(10, 25, 47, 0.95);border-left:2px solid var(--accent);
      box-shadow:-20px 0 60px rgba(0,0,0,.7);
      transform: translateX(100%);transition: transform .3s ease;z-index:20;
      display:flex;flex-direction:column;backdrop-filter: blur(20px);
    }
    .drawer.open{ transform: translateX(0); }
    .drawerHeader{
      padding:20px;
      border-bottom:2px solid var(--accent);
      background: rgba(0, 255, 136, 0.05);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawerHeader h3{
      margin:0;
      font-size:18px;
      color: var(--accent);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .drawerBody {
      flex: 1;
      overflow-y: auto;
      padding: 0 0 20px 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .section{
      border:2px solid var(--line);
      background: var(--card2);
      border-radius:12px;
      padding:20px;
      margin:0 20px;
    }
    .section h4{
      margin:0 0 15px;
      font-size:14px;
      color:var(--accent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .section .hint{
      color:var(--muted);
      font-size:11px;
      margin-top:10px;
      line-height:1.35;
    }
    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:15px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
      font-weight:600;
    }
    .field input, .field textarea, .field select{
      width:100%;
      border-radius:8px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:12px;
      outline:none;
      font-size:13px;
      transition: all 0.3s ease;
    }
    .field input:focus, .field textarea:focus, .field select:focus{
      border-color: var(--accent);
      background: rgba(255,255,255,.12);
    }
    .field textarea{
      min-height:80px;
      resize:vertical;
    }
    .miniBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:15px;
      align-items:center;
    }
    .mini{
      height:40px;
      padding:0 20px;
      border-radius:20px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.1);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .mini:hover{ 
      background: rgba(255,255,255,.2);
      transform: translateY(-2px);
    }
    .mini.green{
      background: rgba(0, 255, 136, 0.15);
      border-color: var(--accent);
      color:var(--accent);
    }
    .mini.green:hover{ 
      background: rgba(0, 255, 136, 0.3);
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
    }
    .mini.danger{
      background: rgba(255, 107, 107, 0.15);
      border-color: var(--danger);
      color:var(--danger);
    }
    .mini.danger:hover{ 
      background: rgba(255, 107, 107, 0.3);
    }
    .mini.warning{
      background: rgba(255, 204, 0, 0.15);
      border-color: var(--warning);
      color:var(--warning);
    }
    .mini.warning:hover{ 
      background: rgba(255, 204, 0, 0.3);
    }
    .pinRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:15px;
      padding-top:15px;
      border-top:1px dashed var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .cartList{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:15px;
      max-height: 350px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 8px;
      margin-right: -8px;
    }
    .cartList::-webkit-scrollbar {
      width: 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
    }
    .cartList::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin: 4px 0;
    }
    .cartList::-webkit-scrollbar-thumb {
      background: linear-gradient(to bottom, var(--accent), var(--accent2));
      border-radius: 10px;
      border: 3px solid rgba(10, 25, 47, 0.9);
      min-height: 40px;
    }
    .cartList::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(to bottom, #00ffaa, #00e0ff);
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }
    .cartItem{
      border:2px solid var(--line);
      background: rgba(0,0,0,.2);
      border-radius:12px;
      padding:15px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      min-height: 70px;
    }
    .cartItem .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:5px;
      flex:1;
    }
    .cartItem .left .t{
      font-weight:700;
      font-size:13px;
      line-height:1.3;
      color: var(--text);
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .cartItem .left .s{
      color:var(--muted);
      font-size:11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cartItem .right{
      display:flex;
      align-items:center;
      gap:12px;
      flex:0 0 auto;
    }
    .cartItem .lineTotal{
      font-weight:700;
      white-space:nowrap;
      font-size:13px;
      color:var(--accent);
      min-width: 80px;
      text-align: right;
    }
    .totals{
      margin-top:20px;
      border-top:2px solid var(--line);
      padding-top:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:14px;
    }
    .totals .trow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .totals .trow span{
      color:var(--muted);
    }
    .totals .trow strong{
      font-weight:700;
      color:var(--text);
    }
    .warn{
      margin-top:15px;
      padding:15px;
      border-radius:10px;
      border:1px dashed var(--line);
      background: rgba(0,0,0,.2);
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .warn.bad{
      border-color: rgba(255,107,107,.4);
      color:#ffb8b8;
      background: rgba(255,107,107,.1);
    }
    .warn.good{
      border-color: rgba(0,255,136,.4);
      color:#b8ffd9;
      background: rgba(0,255,136,.1);
    }
    .warn.info{
      border-color: rgba(0,212,255,.4);
      color:#b8eaff;
      background: rgba(0,212,255,.1);
    }
    .histToggle{
      width:100%;
      height:44px;
      border-radius:10px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 20px;
      transition: all 0.3s ease;
    }
    .histToggle:hover{
      background: rgba(255,255,255,.15);
    }
    .histBox{
      margin-top:15px;
      display:none;
      border:2px solid var(--line);
      background: rgba(0,0,0,.2);
      border-radius:12px;
      padding:20px;
      max-height: 300px;
      overflow-y: auto;
    }
    .histBox.open{ display:block; }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,.1);
      text-align:left;
    }
    th{
      color:var(--muted);
      font-weight:700;
      font-size:11px;
    }
    td strong{
      font-weight:700;
      color:var(--accent);
    }
    .drawerFooter{
      padding:20px;
      border-top:2px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background: var(--card);
      flex-shrink: 0;
    }
    #sendBtn {
      min-width: 120px;
      height: 44px;
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
    }
    #sendBtn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
    }
    #sendBtn:active:not(:disabled) {
      transform: translateY(0);
    }
    @keyframes pulseSuccess {
      0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(0, 255, 136, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
    }
    .sent-animation {
      animation: pulseSuccess 2s ease;
    }
    @keyframes cartPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .cartPill.pulse {
      animation: cartPulse 0.5s ease;
    }
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:30;
      padding:20px;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width:800px;
      max-width:95vw;
      border-radius:var(--radius);
      border:2px solid var(--accent);
      background: rgba(10, 25, 47, 0.95);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:2px solid var(--accent);
      background: rgba(0, 255, 136, 0.05);
    }
    .modalHead h3{
      margin:0;
      font-size:16px;
      color:var(--accent);
    }
    .modalBody{
      padding:20px;
    }
    .modalBody textarea{
      width:100%;
      min-height:250px;
      border-radius:10px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:15px;
      outline:none;
      font-size:13px;
      line-height:1.5;
      font-family: monospace;
    }
    .modalFoot{
      padding:20px;
      border-top:2px solid var(--line);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .admin{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.8);
      display:none;
      z-index:40;
      padding:20px;
      overflow:auto;
    }
    .admin.open{ display:block; }
    .adminBox{
      max-width:1000px;
      margin:20px auto;
      border-radius:var(--radius);
      border:2px solid var(--accent);
      background: rgba(10, 25, 47, 0.95);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .adminHead{
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:2px solid var(--accent);
      background: rgba(0, 255, 136, 0.05);
    }
    .adminHead h3{
      margin:0;
      font-size:16px;
      color:var(--accent);
    }
    .adminBody{
      padding:20px;
    }
    .adminBody pre{
      background: rgba(255,255,255,.08);
      border:2px solid var(--line);
      border-radius:10px;
      padding:15px;
      overflow:auto;
      max-height:500px;
      font-size:12px;
      color: var(--text);
      font-family: monospace;
    }
    .hintAdmin{
      margin-top:20px;
      padding:15px;
      border-radius:10px;
      border:1px solid rgba(0,255,136,0.2);
      background: rgba(0,255,136,0.05);
      color: var(--muted);
      font-size:11px;
      text-align:center;
    }
    .scroll-indicator {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 255, 136, 0.2);
      border: 2px solid var(--accent);
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 11px;
      color: var(--accent);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 2;
    }
    .scroll-indicator.visible {
      opacity: 1;
    }
    
    /* Image produit - CORRIG√â */
    .product-img{
      width:100%;
      height:160px;
      object-fit:contain;
      display:block;
      margin:8px auto;
      background:#fff;
      border-radius:8px;
      border: 1px solid var(--line);
    }
    
    /* Panneau photo admin */
    .photo-admin {
      margin-top: 20px;
      border: 2px dashed var(--accent);
      background: rgba(0, 255, 136, 0.05);
      border-radius: var(--radius);
      padding: 20px;
    }
    
    .photo-preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--line);
      margin: 10px 0;
      display: none;
    }
    
    .photo-preview.show {
      display: block;
    }
    
    .upload-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .upload-status.success {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    
    .upload-status.error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
    }
    
    .photo-exists {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: 10px;
    }
    
    .photo-exists.yes {
      background: rgba(0, 255, 136, 0.1);
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    
    .photo-exists.no {
      background: rgba(255, 107, 107, 0.1);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    
    @media (max-width: 1100px){
      .grid{ grid-template-columns:1fr }
      #products{ grid-template-columns:repeat(2, minmax(0, 1fr)) }
      .brand{ min-width:0; }
    }
    @media (max-width: 768px){
      #products{ grid-template-columns:1fr }
      .topRow{ flex-direction:column; align-items:stretch; }
      .search{ width:100%; }
      .drawer{ width:100vw; }
      .cartList { max-height: 300px; }
      .cartItem { flex-direction: column; align-items: flex-start; gap: 10px; }
      .cartItem .right { width: 100%; justify-content: space-between; }
    }
    @media (max-width: 480px){
      .pills{ flex-direction:column; align-items:flex-start; }
      .cartPill{ margin-left:0; }
      .row2{ grid-template-columns:1fr; }
      .section { margin: 0 10px; padding: 15px; }
      .cartList { max-height: 250px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET" onerror="this.style.display='none'">
          </div>
          <div class="brandText">
            <h1>MAXI JDC MARKET</h1>
            <p>Des prix mini ‚Äî Un MAXI choix</p>
          </div>
        </div>
        <div class="search">
          <input id="q" type="text" placeholder="üîç Rechercher un produit (nom, cat√©gorie, code)..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn green" id="globalBtn">Recherche globale</button>
        </div>
      </div>
      <div class="pills">
        <div class="pill">üìç Jardins de Carthage , derri√®re mosqu√©e Essalem</div>
        <div class="pill">üïí 7h ‚Äì 1h</div>
        <div class="pill"><strong>WhatsApp:</strong> 00216 25 600 978</div>
        <div class="pill cartPill" id="cartTopBtn" title="Ouvrir le panier">
          üõí Panier <span id="cartTopCount">0</span>
        </div>
      </div>
      <div class="noteBar">
        <span class="ok">‚úÖ Donn√©es charg√©es depuis <b>data/*.csv</b> ‚Äî une cat√©gorie = un fichier CSV.</span>
        <span class="sub">Conditions : minimum livraison <b>15 dt</b> ‚Ä¢ Livraison gratuite si total ‚â• <b>30 dt</b> ‚Ä¢ Sinon frais <b>5 dt</b> ‚Ä¢ Retrait magasin possible</span>
      </div>
    </div>
    <div class="grid">
      <div class="panel">
        <div class="panelHeader">
          <h3>Cat√©gories</h3>
          <div class="sub" id="status">Chargement‚Ä¶</div>
        </div>
        <div id="cats"></div>
      </div>
      <div class="panel">
        <div class="content">
          <div class="contentHeader">
            <div class="titleWrap">
              <h2 id="activeLabel">Produits</h2>
              <div class="meta" id="activeMeta">S√©lectionne une cat√©gorie.</div>
            </div>
            <div class="pager">
              <button class="iconBtn" id="prevBtn">‚Äπ</button>
              <span id="pageInfo">Page 1/1</span>
              <button class="iconBtn" id="nextBtn">‚Ä∫</button>
              <span id="countInfo">0 article(s)</span>
            </div>
          </div>
          <div id="products"></div>
          <div class="hintAdmin">Admin : Ctrl + Shift + A (ou ajoute #admin √† l'URL)</div>
        </div>
      </div>
    </div>
  </div>
  
  <aside class="drawer" id="drawer">
    <div class="drawerHeader">
      <h3>üõí Panier & Fiche client</h3>
      <button class="btn" id="closeDrawer">Fermer</button>
    </div>
    <div class="drawerBody">
      <div class="scroll-indicator" id="scrollIndicator">
        <span>‚ñº D√©filez pour voir plus d'articles</span>
      </div>
      
      <div class="section" id="clientBox">
        <h4><span>üë§ Fiche client (1 seule fois)</span><span class="sub" id="clientLockTxt"></span></h4>
        <div class="row2">
          <div class="field"><label>Nom</label><input id="cName" placeholder="Ex: Lotfi" /></div>
          <div class="field"><label>T√©l√©phone</label><input id="cTel" placeholder="Ex: 55xxxxxx" /></div>
        </div>
        <div class="field" style="margin-top:10px">
          <label>Adresse</label>
          <textarea id="cAddr" placeholder="Quartier, rue, rep√®re‚Ä¶"></textarea>
        </div>
        <div class="row2" style="margin-top:10px">
          <div class="field"><label>GPS (lat)</label><input id="cLat" placeholder="ex: 36.85" /></div>
          <div class="field"><label>GPS (lng)</label><input id="cLng" placeholder="ex: 10.30" /></div>
        </div>
        <div class="miniBtns">
          <button class="mini" id="gpsBtn">üìç Utiliser ma position</button>
          <button class="mini green" id="saveClientBtn">Enregistrer</button>
          <button class="mini" id="editClientBtn">Modifier</button>
        </div>
        <div class="hint">Astuce : apr√®s enregistrement, la fiche est verrouill√©e.</div>
        <div class="pinRow">
          <label style="display:flex;gap:8px;align-items:center;cursor:pointer">
            <input type="checkbox" id="pinCart"> √âpingler le panier (laisser ouvert)
          </label>
          <span>üí° Pratique pour voir le total.</span>
        </div>
      </div>
      
      <div class="section">
        <h4><span>üß∫ Articles</span><span class="sub" id="cartMiniInfo">0 article(s)</span></h4>
        <div class="cartList" id="cartList"></div>
        <div class="totals">
          <div class="trow"><span>Sous-total</span><strong id="subTotal">0,00 dt</strong></div>
          <div class="trow"><span>Frais livraison</span><strong id="shipFee">0,00 dt</strong></div>
          <div class="trow"><span>Total</span><strong id="cartTotal">0,00 dt</strong></div>
        </div>
        <div class="warn" id="ruleBox"></div>
        <button class="histToggle" id="histToggleBtn">
          <span>üßæ Historique client</span><span id="histCount">0</span>
        </button>
        <div class="histBox" id="histBox">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
            <div style="color:var(--muted);font-size:12px">Commandes trouv√©es pour ce t√©l√©phone</div>
            <button class="mini danger" id="clearMyHistoryBtn">Effacer</button>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>Date</th><th>Total</th><th>Articles</th></tr></thead>
              <tbody id="histTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- SECTION UPLOAD PHOTOS - CORRIG√âE -->
      <div class="section photo-admin" id="photoAdmin" style="display:none">
        <h4><span>üì∏ Upload Photo d'Article</span><span class="sub">Conserve le nom de l'article</span></h4>
        
        <div class="field">
          <label for="uploadCode">Code Article *</label>
          <input type="text" id="uploadCode" placeholder="Ex: 2999">
        </div>
        
        <div class="field">
          <label for="uploadName">Nom de l'Article *</label>
          <input type="text" id="uploadName" placeholder="Ex: Pizza 4 Fromages Surgel√©e">
        </div>
        
        <div class="row2">
          <div class="field">
            <label for="uploadCategory">Cat√©gorie *</label>
            <select id="uploadCategory">
              <option value="">S√©lectionner</option>
              <option value="produits_surgeles" selected>Produits Surgel√©s</option>
              <option value="cafe">Caf√©</option>
              <option value="jus_boissons">Jus & Boissons</option>
              <option value="chips_snacks">Chips et Snacks</option>
              <option value="chocolats_biscuits">Chocolats et Biscuits</option>
              <option value="conserves">Conserves</option>
              <option value="pates">P√¢tes</option>
              <option value="epicerie_salee">√âpicerie Sal√©e</option>
              <option value="epicerie_sucree">√âpicerie Sucr√©e</option>
              <option value="hygiene_soins">Hygi√®ne & Soins</option>
              <option value="hygiene_entretien">Hygi√®ne et Entretien</option>
              <option value="lait_oeufs_produits_frais">Lait, ≈íufs & Produits frais</option>
              <option value="fromage_charcuterie">Fromage & Charcuterie</option>
              <option value="fruits_legumes">Fruits et L√©gumes</option>
              <option value="fruits_secs_noix">Fruits Secs et Noix</option>
              <option value="boulangerie_patisserie">Boulangerie & P√¢tisserie</option>
              <option value="cuisine_monde">Cuisine du Monde</option>
              <option value="eaux">Eaux</option>
              <option value="bebe_maman">B√©b√© et Maman</option>
              <option value="animaux_compagnie">Animaux de Compagnie</option>
              <option value="vipa_selections">VIPA S√©lections</option>
            </select>
          </div>
          
          <div class="field">
            <label for="uploadPrice">Prix</label>
            <input type="number" id="uploadPrice" step="0.01" placeholder="Ex: 12.50">
          </div>
        </div>
        
        <div class="field">
          <label for="uploadFile">Photo *</label>
          <input type="file" id="uploadFile" accept="image/*">
          <img id="uploadPreview" class="photo-preview" alt="Aper√ßu">
        </div>
        
        <div class="miniBtns">
          <button class="mini" onclick="findArticleForUpload()">üîç Chercher l'article</button>
          <button class="mini green" onclick="uploadPhoto()">üì§ Uploader la photo</button>
        </div>
        
        <div id="uploadStatus" class="upload-status"></div>
        
        <div class="hint">
          <strong>‚ö†Ô∏è IMPORTANT :</strong><br>
          1. Le nom de l'article est conserv√© dans le CSV<br>
          2. La photo est renomm√©e automatiquement (code.jpg)<br>
          3. Les donn√©es sont sauvegard√©es dans images/products/
        </div>
      </div>
    </div>
    
    <div class="drawerFooter">
      <button class="mini danger" id="clearCartBtn">Vider panier</button>
      <button class="mini warning" onclick="togglePhotoUpload()">üì∏ Upload Photo</button>
      <button class="mini green" id="sendBtn">üöÄ Envoyer</button>
    </div>
  </aside>
  
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>‚úÖ Commande enregistr√©e ‚Äî R√©sum√©</h3>
        <button class="btn" id="closeModal">Fermer</button>
      </div>
      <div class="modalBody"><textarea id="orderText" readonly></textarea></div>
      <div class="modalFoot">
        <button class="mini" id="copyBtn">üìã Copier</button>
        <button class="mini" id="downloadBtn">üíæ T√©l√©charger (.txt)</button>
        <button class="mini green" id="whatsappBtn">üì± Envoyer par WhatsApp</button>
      </div>
    </div>
  </div>
  
  <div class="admin" id="admin">
    <div class="adminBox">
      <div class="adminHead">
        <h3>üõ†Ô∏è Admin ‚Äî commandes & historique</h3>
        <button class="btn" id="closeAdmin">Fermer</button>
      </div>
      <div class="adminBody">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
          <button class="mini" id="exportBtn">Exporter JSON</button>
          <button class="mini danger" id="clearAllBtn">Effacer tout l'historique</button>
          <button class="mini warning" onclick="togglePhotoUploadSection()">üì∏ Gestion photos</button>
        </div>
        <pre id="adminDump">‚Äî</pre>
      </div>
    </div>
  </div>

<script>
/* CONFIG */
const MIN_ORDER = 15;
const FREE_SHIPPING = 30;
const SHIPPING_FEE = 5;

/* CAT√âGORIES */
const CATEGORIES = [
  { key:"animaux_compagnie", label:"Animaux de Compagnie", file:"data/animaux_compagnie.csv" },
  { key:"bebe_maman", label:"B√©b√© et Maman", file:"data/bebe_maman.csv" },
  { key:"boulangerie_patisserie", label:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
  { key:"cafe", label:"Caf√©", file:"data/cafe.csv" },
  { key:"chips_snacks", label:"Chips et Snacks", file:"data/chips_snacks.csv" },
  { key:"chocolats_biscuits", label:"Chocolats et Biscuits", file:"data/chocolats_biscuits.csv" },
  { key:"conserves", label:"Conserves", file:"data/conserves.csv" },
  { key:"cuisine_monde", label:"Cuisine du Monde", file:"data/cuisine_monde.csv" },
  { key:"eaux", label:"Eaux", file:"data/eaux.csv" },
  { key:"epicerie_salee", label:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
  { key:"epicerie_sucree", label:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
  { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
  { key:"fruits_legumes", label:"Fruits et L√©gumes", file:"data/fruits_legumes.csv" },
  { key:"fruits_secs_noix", label:"Fruits Secs et Noix", file:"data/fruits_secs_noix.csv" },
  { key:"hygiene_entretien", label:"Hygi√®ne et Entretien", file:"data/hygiene_entretien.csv" },
  { key:"hygiene_soins", label:"Hygi√®ne & Soins", file:"data/hygiene_soins.csv" },
  { key:"jus_boissons", label:"Jus & Boissons", file:"data/jus_boissons.csv" },
  { key:"lait_oeufs_produits_frais", label:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
  { key:"pates", label:"P√¢tes", file:"data/pates.csv" },
  { key:"produits_surgeles", label:"Produits Surgel√©s", file:"data/produits_surgeles.csv" },
  { key:"vipa_selections", label:"VIPA S√©lections", file:"data/vipa_selections.csv" }
];

/* HELPERS */
const $ = (id)=>document.getElementById(id);
const fmtDT = (n)=>Number(n||0).toFixed(2).replace(".", ",") + " dt";
const nowStr = ()=> new Date().toLocaleString("fr-FR");

// CORRECTION : Ne pas supprimer les caract√®res importants du nom
function safeKey(s){ 
  return String(s||"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^\w\-_]+/g,"");
}

function dlText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

/* STATE */
const state = {
  dataByCat: new Map(),
  activeCat: "cafe",
  global:false,
  q:"",
  page:1,
  perPage:9,
  qtyPick:{},
  cart:{},
  client:null,
  pinCart:false,
};

function loadLocal(){
  try{ state.cart = JSON.parse(localStorage.getItem("maxi_cart_v1")||"{}") || {}; }catch(e){ state.cart = {}; }
  try{ const c = JSON.parse(localStorage.getItem("maxi_client_v1")||"null"); if(c) state.client = c; }catch(e){}
  try{ state.pinCart = localStorage.getItem("maxi_pin_cart")==="1"; }catch(e){}
}
function saveCart(){ localStorage.setItem("maxi_cart_v1", JSON.stringify(state.cart)); }
function saveClient(){ localStorage.setItem("maxi_client_v1", JSON.stringify(state.client||null)); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem("maxi_orders_v1")||"[]"); }catch(e){ return []; } }
function saveHistory(arr){ localStorage.setItem("maxi_orders_v1", JSON.stringify(arr||[])); }

/* CSV PARSER CORRIG√â - CONSERVE LE NOM */
function parseCSV(text){
  console.log("Parsing CSV...");
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows = [];
  
  for(let i = 0; i < lines.length; i++){
    const line = lines[i];
    
    // Skip headers
    if(line.includes("CODE_ARTICLE") && line.includes("ARTICLES") && line.includes("PRIX")) continue;
    if(line.startsWith(";") || line.startsWith("//")) continue;
    
    // Format: CODE\tNOM\tPRIX
    let parts = line.split("\t");
    if(parts.length < 3) parts = line.split(";");
    
    // CORRECTION : Conserver le nom original sans trop nettoyer
    parts = parts.map(p => String(p||"").trim());
    
    if(parts.length >= 3){
      const code = parts[0];
      const name = parts[1]; // CONSERVER LE NOM ORIGINAL
      let priceRaw = parts[2];
      
      // Nettoyer seulement le prix
      priceRaw = priceRaw.replace(",", ".").replace(/[^0-9.]/g,"");
      const price = Number(priceRaw) || 0;
      
      if(code && name && price > 0){
        rows.push({ 
          code: code,
          name: name, // NOM CONSERV√â
          price: price 
        });
      }
    }
  }
  
  console.log(`Parsed ${rows.length} items`);
  return rows;
}

/* CART */
function cartCount(){ return Object.values(state.cart).reduce((a,it)=>a + (it.qty||0), 0); }
function cartTotal(){ return Object.values(state.cart).reduce((a,it)=>a + (Number(it.price)||0) * (it.qty||0), 0); }
function shippingFee(){
  const total = cartTotal();
  if(total < MIN_ORDER) return null;
  if(total >= FREE_SHIPPING) return 0;
  return SHIPPING_FEE;
}
function grandTotal(){
  const fee = shippingFee();
  if(fee === null) return null;
  return cartTotal() + fee;
}

/* UI */
function buildCats(){
  const box = $("cats");
  box.innerHTML = "";
  
  for(const c of CATEGORIES){
    const btn = document.createElement("button");
    btn.className = "catBtn" + (state.activeCat===c.key ? " active" : "");
    btn.onclick = ()=>{
      state.activeCat = c.key;
      state.global = false;
      state.page = 1;
      buildCats();
      render();
    };

    const left = document.createElement("div");
    left.className = "catLeft";
    left.innerHTML = `<div class="catTitle">${c.label}</div><div class="catMeta">${c.file}</div>`;

    const count = document.createElement("div");
    count.className = "catCount";
    const items = state.dataByCat.get(c.key) || [];
    count.textContent = items.length + " article(s)";

    btn.appendChild(left);
    btn.appendChild(count);
    box.appendChild(btn);
  }
}

function getActiveCat(){ 
  return CATEGORIES.find(x=>x.key===state.activeCat) || CATEGORIES[0]; 
}

function getVisibleItems(){
  let items = [];
  
  if(state.global){
    for(const c of CATEGORIES){
      const arr = state.dataByCat.get(c.key) || [];
      items.push(...arr.map(it=>({...it, catKey:c.key, catLabel:c.label})));
    }
  } else {
    const c = getActiveCat();
    const arr = state.dataByCat.get(c.key) || [];
    items = arr.map(it=>({...it, catKey:c.key, catLabel:c.label}));
  }

  const q = String(state.q||"").trim().toLowerCase();
  if(q){
    items = items.filter(it =>
      (it.name||"").toLowerCase().includes(q) ||
      (it.code||"").toLowerCase().includes(q) ||
      (it.catLabel||"").toLowerCase().includes(q)
    );
  }
  
  items.sort((a,b)=>String(a.name).localeCompare(String(b.name), "fr"));
  return items;
}

function render(){
  const active = getActiveCat();
  $("activeLabel").textContent = state.global ? "Recherche globale" : active.label;
  $("activeMeta").textContent = state.global
    ? "Toutes cat√©gories ‚Äî r√©sultats filtr√©s"
    : `${active.file}`;

  const items = getVisibleItems();
  const totalPages = Math.max(1, Math.ceil(items.length / state.perPage));
  if(state.page > totalPages) state.page = totalPages;

  const start = (state.page-1)*state.perPage;
  const pageItems = items.slice(start, start + state.perPage);

  $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
  $("countInfo").textContent = `${items.length} article(s)`;

  const box = $("products");
  box.innerHTML = "";

  if(pageItems.length === 0){
    box.innerHTML = `<div class="warn" style="grid-column:1/-1;text-align:center;padding:40px;">
      ${items.length === 0 ? 'Aucun article trouv√©' : 'Aucun article sur cette page'}
    </div>`;
  } else {
    for(const it of pageItems){
      const pid = safeKey(`${it.catKey}_${it.code}_${it.name}`);
      if(state.qtyPick[pid] == null) state.qtyPick[pid] = 0;

      const card = document.createElement("div");
      card.className = "card";

      // V√©rifier si la photo existe
      const imgExtensions = ['jpg', 'jpeg', 'png', 'gif'];
      let imgSrc = "";
      let imgFound = false;
      
      for (const ext of imgExtensions) {
        const testSrc = `images/products/${it.code}.${ext}`;
        imgSrc = testSrc;
        break;
      }

      card.innerHTML = `
        <div class="cardTop">
          <img src="${imgSrc}"
               class="product-img"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiMxMTIyNDAiLz48cGF0aCBkPSJNNzUgNzVMMTI1IDEyNU0xMjUgNzVMNzUgMTI1IiBzdHJva2U9IiM4Qjk0OUUiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';this.style.backgroundColor='var(--bg1)'"
               alt="${it.name}"
               data-code="${it.code}">
          <div class="name">${it.name}</div>
          <div class="price">${fmtDT(it.price)}</div>
        </div>
        <div class="meta2">
          <div>Code: ${it.code} ‚Ä¢ ${it.catLabel}</div>
          <div style="font-size:10px;color:${imgFound?'var(--accent)':'var(--muted)'}">
            ${imgFound ? '‚úÖ Photo disponible' : 'üì∑ Photo manquante'}
          </div>
        </div>
        <div class="qtyRow">
          <div class="stepper">
            <button data-act="minus">‚àí</button>
            <span class="qv">${state.qtyPick[pid]||0}</span>
            <button data-act="plus">+</button>
          </div>
          <button class="addBtn">üß∫ Ajouter</button>
        </div>
      `;

      card.querySelector('[data-act="minus"]').onclick = ()=>{
        state.qtyPick[pid] = Math.max(0, (state.qtyPick[pid]||0)-1);
        render();
      };
      card.querySelector('[data-act="plus"]').onclick = ()=>{
        state.qtyPick[pid] = (state.qtyPick[pid]||0)+1;
        render();
      };
      
      // CORRECTION : BIEN CONSERVER LE NOM DANS LE PANIER
      card.querySelector(".addBtn").onclick = ()=>{
        const q = state.qtyPick[pid]||0;
        if(q<=0) return;
        
        if(state.cart[pid]) {
          state.cart[pid].qty += q;
        } else {
          // IMPORTANT : Conserver toutes les informations, y compris le NOM
          state.cart[pid] = { 
            pid, 
            name: it.name, // NOM CONSERV√â
            code: it.code, 
            price: it.price, 
            catLabel: it.catLabel, 
            qty: q 
          };
        }
        
        state.qtyPick[pid] = 0;
        saveCart();
        refreshCartUI(true);
        
        const cartBtn = $("cartTopBtn");
        cartBtn.classList.add("pulse");
        setTimeout(() => cartBtn.classList.remove("pulse"), 500);
      };

      box.appendChild(card);
    }
  }

  refreshCartUI(false);
}

function openDrawer(){ $("drawer").classList.add("open"); }
function closeDrawer(){ if(state.pinCart) return; $("drawer").classList.remove("open"); }

function refreshCartUI(maybeOpen){
  $("cartTopCount").textContent = cartCount();
  $("cartMiniInfo").textContent = cartCount() + " article(s)";

  const list = $("cartList");
  list.innerHTML = "";
  const keys = Object.keys(state.cart);

  if(!keys.length){
    const e = document.createElement("div");
    e.className = "warn";
    e.textContent = "Panier vide. Ajoute des articles üôÇ";
    list.appendChild(e);
  }else{
    for(const pid of keys){
      const it = state.cart[pid];
      const row = document.createElement("div");
      row.className = "cartItem";

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `<div class="t">${it.name}</div><div class="s">Code: ${it.code} ‚Ä¢ ${it.catLabel} ‚Ä¢ ${fmtDT(it.price)}</div>`;

      const right = document.createElement("div");
      right.className = "right";

      const step = document.createElement("div");
      step.className = "stepper";

      const minus = document.createElement("button");
      minus.textContent = "‚àí";
      minus.onclick = ()=>{
        it.qty = Math.max(0, (it.qty||0)-1);
        if(it.qty===0) delete state.cart[pid];
        saveCart();
        refreshCartUI(false);
      };

      const val = document.createElement("span");
      val.textContent = it.qty||0;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.onclick = ()=>{
        it.qty = (it.qty||0)+1;
        saveCart();
        refreshCartUI(false);
      };

      step.appendChild(minus); step.appendChild(val); step.appendChild(plus);

      const lineTotal = document.createElement("div");
      lineTotal.className = "lineTotal";
      lineTotal.textContent = fmtDT((Number(it.price)||0) * (it.qty||0));

      right.appendChild(step);
      right.appendChild(lineTotal);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    }
  }

  $("subTotal").textContent = fmtDT(cartTotal());
  const fee = shippingFee();
  $("shipFee").textContent = fee===null ? "‚Äî" : fmtDT(fee);

  const g = grandTotal();
  if(g===null){
    $("cartTotal").textContent = "Minimum commande 15 dt";
    $("cartTotal").style.color = "var(--danger)";
  }else{
    $("cartTotal").textContent = fmtDT(g);
    $("cartTotal").style.color = "var(--accent)";
  }

  const rule = $("ruleBox");
  const t = cartTotal();
  if(t <= 0){
    rule.className = "warn"; rule.textContent = "Ajoute des articles pour commencer.";
  }else if(t < MIN_ORDER){
    rule.className = "warn bad";
    rule.textContent = `‚ö†Ô∏è Minimum commande: ${MIN_ORDER} dt. Il manque ${fmtDT(MIN_ORDER - t)} (hors frais).`;
  }else if(t >= FREE_SHIPPING){
    rule.className = "warn good";
    rule.textContent = `‚úÖ Livraison gratuite (total ‚â• ${FREE_SHIPPING} dt).`;
  }else{
    rule.className = "warn";
    rule.textContent = `‚ÑπÔ∏è Frais livraison: ${SHIPPING_FEE} dt (gratuite √† partir de ${FREE_SHIPPING} dt).`;
  }

  if(state.pinCart || maybeOpen) openDrawer();
}

/* LOAD DATA */
async function loadAll(){
  console.log("=== D√âBUT CHARGEMENT DES CAT√âGORIES ===");
  $("status").textContent = "Chargement‚Ä¶";
  
  let totalProducts = 0;
  
  for(const c of CATEGORIES){
    console.log(`Chargement: ${c.label} -> ${c.file}`);
    try{
      const r = await fetch(c.file, {cache:"no-store"});
      console.log(`  Statut: ${r.status} ${r.statusText}`);
      
      if(!r.ok) {
        console.error(`  ‚ùå Erreur HTTP: ${r.status} ${r.statusText}`);
        state.dataByCat.set(c.key, []);
        continue;
      }
      
      const text = await r.text();
      console.log(`  Taille: ${text.length} caract√®res`);
      
      const items = parseCSV(text);
      console.log(`  ‚úÖ ${items.length} articles charg√©s`);
      state.dataByCat.set(c.key, items);
      totalProducts += items.length;
      
    }catch(e){
      console.error(`  ‚ùå Exception: ${e.message}`);
      state.dataByCat.set(c.key, []);
    }
  }
  
  console.log("=== FIN CHARGEMENT ===");
  console.log(`Total produits charg√©s: ${totalProducts}`);
  
  $("status").textContent = `‚úÖ ${totalProducts} articles`;
  buildCats();
  render();
}

/* UPLOAD PHOTO FUNCTIONS - CORRIG√âES */
function togglePhotoUpload() {
  const photoAdmin = $("photoAdmin");
  photoAdmin.style.display = photoAdmin.style.display === "none" ? "block" : "none";
  if (photoAdmin.style.display === "block") {
    openDrawer();
  }
}

function togglePhotoUploadSection() {
  togglePhotoUpload();
  $("admin").classList.remove("open");
}

// Aper√ßu de l'image upload√©e
$("uploadFile").addEventListener("change", function(e) {
  const preview = $("uploadPreview");
  const file = e.target.files[0];
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.classList.add("show");
    }
    reader.readAsDataURL(file);
  }
});

async function findArticleForUpload() {
  const code = $("uploadCode").value.trim();
  if (!code) {
    showUploadStatus("error", "‚ùå Veuillez entrer un code article");
    return;
  }
  
  // Chercher dans toutes les cat√©gories
  for (const [catKey, items] of state.dataByCat.entries()) {
    const article = items.find(it => it.code === code);
    if (article) {
      $("uploadName").value = article.name;
      
      // Trouver la cat√©gorie
      const category = CATEGORIES.find(c => c.key === catKey);
      if (category) {
        $("uploadCategory").value = category.key;
      }
      
      $("uploadPrice").value = article.price;
      showUploadStatus("success", `‚úÖ Article trouv√©: ${article.name}`);
      return;
    }
  }
  
  showUploadStatus("info", "‚ÑπÔ∏è Article non trouv√©. Vous pouvez le cr√©er.");
}

async function uploadPhoto() {
  const code = $("uploadCode").value.trim();
  const name = $("uploadName").value.trim();
  const category = $("uploadCategory").value;
  const price = $("uploadPrice").value;
  const fileInput = $("uploadFile");
  
  // Validation
  if (!code || !name || !category || !fileInput.files[0]) {
    showUploadStatus("error", "‚ùå Tous les champs sont obligatoires (code, nom, cat√©gorie, photo)");
    return;
  }
  
  const file = fileInput.files[0];
  
  // Cr√©er FormData avec TOUTES les donn√©es
  const formData = new FormData();
  formData.append('article_code', code);
  formData.append('article_name', name); // NOM CONSERV√â
  formData.append('category', category);
  if (price) formData.append('price', price);
  formData.append('photo', file);
  
  showUploadStatus("info", "‚è≥ Upload en cours...");
  
  try {
    const response = await fetch('upload-article-photo.php', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      showUploadStatus("success", 
        `‚úÖ ${result.message}<br>
         üì∏ Photo: ${result.filename}<br>
         üì¶ Article: ${result.article_name}<br>
         üî¢ Code: ${result.article_code}<br>
         üìÅ Cat√©gorie: ${result.category}`);
      
      // R√©initialiser le formulaire
      $("uploadCode").value = "";
      $("uploadName").value = "";
      $("uploadPrice").value = "";
      $("uploadFile").value = "";
      $("uploadPreview").classList.remove("show");
      
      // Recharger les donn√©es
      setTimeout(() => {
        loadAll().then(() => {
          showUploadStatus("success", "‚úÖ Donn√©es recharg√©es avec la nouvelle photo!");
        });
      }, 1000);
      
    } else {
      showUploadStatus("error", `‚ùå ${result.message}`);
    }
  } catch (error) {
    showUploadStatus("error", `‚ùå Erreur r√©seau: ${error.message}`);
  }
}

function showUploadStatus(type, message) {
  const status = $("uploadStatus");
  status.className = `upload-status ${type}`;
  status.innerHTML = message;
  status.style.display = "block";
}

/* INIT */
loadLocal();
$("pinCart").checked = state.pinCart;
if(state.pinCart) openDrawer();

// Charger les donn√©es
loadAll().then(()=>{
  console.log("Application charg√©e !");
  refreshCartUI(false);
});

/* EVENT LISTENERS */
$("clearBtn").onclick = ()=>{ $("q").value=""; state.q=""; state.page=1; render(); };
$("globalBtn").onclick = ()=>{ state.global=true; state.page=1; render(); };
$("q").addEventListener("input", ()=>{ state.q=$("q").value; state.page=1; render(); });
$("prevBtn").onclick = ()=>{ state.page=Math.max(1,state.page-1); render(); };
$("nextBtn").onclick = ()=>{
  const total = getVisibleItems().length;
  const totalPages = Math.max(1, Math.ceil(total/state.perPage));
  state.page=Math.min(totalPages,state.page+1);
  render();
};
$("cartTopBtn").onclick = openDrawer;
$("closeDrawer").onclick = closeDrawer;
$("pinCart").addEventListener("change", ()=>{
  state.pinCart = $("pinCart").checked;
  localStorage.setItem("maxi_pin_cart", state.pinCart ? "1":"0");
  if(state.pinCart) openDrawer();
});

/* FONCTIONS CLIENT */
$("saveClientBtn").onclick = function(){
  const name = $("cName").value.trim();
  const tel = $("cTel").value.trim();
  const addr = $("cAddr").value.trim();
  const lat = $("cLat").value.trim();
  const lng = $("cLng").value.trim();
  
  if(!name || !tel || !addr){
    alert("Veuillez remplir au moins Nom, T√©l√©phone et Adresse");
    return;
  }
  
  state.client = { name, tel, addr, lat, lng, savedAt: new Date().toISOString() };
  saveClient();
  alert("‚úÖ Fiche client enregistr√©e !");
};

$("clearCartBtn").onclick = function(){
  if(confirm("Vider tout le panier ?")){
    state.cart = {};
    saveCart();
    refreshCartUI(false);
  }
};

$("sendBtn").onclick = function(){
  if(cartCount() === 0){
    alert("Panier vide !");
    return;
  }
  
  if(!state.client){
    alert("Veuillez d'abord enregistrer la fiche client");
    return;
  }
  
  const g = grandTotal();
  if(g === null){
    alert(`Minimum commande: ${MIN_ORDER} dt`);
    return;
  }
  
  // Cr√©er le r√©sum√©
  let summary = `=== COMMANDE MAXI JDC MARKET ===\n`;
  summary += `Date: ${new Date().toLocaleString('fr-FR')}\n`;
  summary += `Client: ${state.client.name}\n`;
  summary += `T√©l: ${state.client.tel}\n`;
  summary += `Adresse: ${state.client.addr}\n`;
  if(state.client.lat && state.client.lng){
    summary += `GPS: ${state.client.lat}, ${state.client.lng}\n`;
  }
  summary += `\n=== ARTICLES ===\n`;
  
  Object.values(state.cart).forEach(item => {
    summary += `‚Ä¢ ${item.name} (x${item.qty}) = ${fmtDT(item.price * item.qty)}\n`;
  });
  
  summary += `\n=== TOTAL ===\n`;
  summary += `Sous-total: ${fmtDT(cartTotal())}\n`;
  summary += `Livraison: ${shippingFee() === 0 ? 'GRATUITE' : fmtDT(shippingFee())}\n`;
  summary += `TOTAL: ${fmtDT(g)}\n`;
  
  // Sauvegarder dans l'historique
  const history = loadHistory();
  history.unshift({
    date: new Date().toISOString(),
    client: state.client.name,
    tel: state.client.tel,
    total: g,
    items: Object.values(state.cart).map(i => ({name: i.name, qty: i.qty, price: i.price}))
  });
  saveHistory(history);
  
  // Afficher le modal
  $("orderText").value = summary;
  $("modalBack").classList.add("open");
  
  // Ajouter l'animation
  $("sendBtn").classList.add("sent-animation");
  setTimeout(() => $("sendBtn").classList.remove("sent-animation"), 2000);
};

$("closeModal").onclick = function(){
  $("modalBack").classList.remove("open");
};

$("copyBtn").onclick = function(){
  $("orderText").select();
  document.execCommand("copy");
  alert("‚úÖ Commande copi√©e dans le presse-papier !");
};

$("downloadBtn").onclick = function(){
  const text = $("orderText").value;
  const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
  const filename = `commande_${state.client.name}_${date}.txt`;
  dlText(filename, text);
};

$("whatsappBtn").onclick = function(){
  const text = encodeURIComponent($("orderText").value);
  window.open(`https://wa.me/21625600978?text=${text}`, '_blank');
};

/* GESTION HISTORIQUE */
$("histToggleBtn").onclick = function(){
  $("histBox").classList.toggle("open");
  
  if($("histBox").classList.contains("open")){
    const history = loadHistory();
    $("histCount").textContent = history.length;
    
    const tbody = $("histTbody");
    tbody.innerHTML = "";
    
    if(history.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:var(--muted);padding:20px;">Aucune commande historique</td></tr>`;
    } else {
      history.slice(0, 10).forEach(order => {
        const tr = document.createElement("tr");
        const date = new Date(order.date).toLocaleDateString('fr-FR');
        const total = fmtDT(order.total);
        const itemsCount = order.items.reduce((sum, item) => sum + item.qty, 0);
        
        tr.innerHTML = `
          <td>${date}</td>
          <td><strong>${total}</strong></td>
          <td>${itemsCount} article(s)</td>
        `;
        tbody.appendChild(tr);
      });
    }
  }
};

$("clearMyHistoryBtn").onclick = function(){
  if(confirm("Effacer tout l'historique de commandes ?")){
    saveHistory([]);
    $("histTbody").innerHTML = `<tr><td colspan="3" style="text-align:center;color:var(--muted);padding:20px;">Aucune commande historique</td></tr>`;
    $("histCount").textContent = "0";
  }
};

/* ADMIN */
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a') {
    e.preventDefault();
    $("admin").classList.toggle("open");
  }
});

if (window.location.hash === '#admin') {
  $("admin").classList.add("open");
}

$("closeAdmin").onclick = function(){
  $("admin").classList.remove("open");
};

$("exportBtn").onclick = function(){
  const history = loadHistory();
  const data = {
    exportedAt: new Date().toISOString(),
    totalOrders: history.length,
    orders: history
  };
  const json = JSON.stringify(data, null, 2);
  dlText(`maxi-orders-${new Date().toISOString().slice(0,10)}.json`, json);
};

$("clearAllBtn").onclick = function(){
  if(confirm("Effacer TOUT l'historique des commandes ? Cette action est irr√©versible.")){
    saveHistory([]);
    alert("‚úÖ Historique effac√© !");
    $("adminDump").textContent = "Historique vide.";
  }
};

function updateAdminDump() {
  const history = loadHistory();
  $("adminDump").textContent = JSON.stringify(history, null, 2);
}

updateAdminDump();
</script>

<!-- FICHIER PHP D'UPLOAD √Ä CR√âER (upload-article-photo.php) -->
<script>
// Contenu du fichier PHP √† cr√©er s√©par√©ment
const phpUploadCode = `<?php
// upload-article-photo.php - CORRIG√â pour conserver le nom de l'article
header('Content-Type: application/json');

// Dossier des photos
$uploadDir = 'images/products/';

// Cr√©er le dossier s'il n'existe pas
if (!file_exists($uploadDir)) {
    mkdir($uploadDir, 0777, true);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // R√âCUP√âRER TOUTES LES DONN√âES
    $article_code = $_POST['article_code'] ?? '';
    $article_name = $_POST['article_name'] ?? ''; // NOM DE L'ARTICLE
    $category = $_POST['category'] ?? '';
    $price = $_POST['price'] ?? '0.00';
    
    // VALIDATION IMPORTANTE
    if (empty($article_code) || empty($article_name) || empty($category)) {
        echo json_encode([
            'success' => false,
            'message' => 'ERREUR: Code, nom ou cat√©gorie manquant!'
        ]);
        exit;
    }
    
    // V√©rifier le fichier
    if (!isset($_FILES['photo']) || $_FILES['photo']['error'] !== UPLOAD_ERR_OK) {
        echo json_encode([
            'success' => false,
            'message' => 'ERREUR: Aucun fichier upload√©.'
        ]);
        exit;
    }
    
    $file = $_FILES['photo'];
    
    // V√©rifier le type
    $allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
    if (!in_array($file['type'], $allowedTypes)) {
        echo json_encode([
            'success' => false,
            'message' => 'ERREUR: Type non autoris√©. Utilisez JPG, PNG ou GIF.'
        ]);
        exit;
    }
    
    // D√©terminer l'extension
    $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
    $validExtensions = ['jpg', 'jpeg', 'png', 'gif'];
    
    if (!in_array($extension, $validExtensions)) {
        echo json_encode([
            'success' => false,
            'message' => 'ERREUR: Extension non valide.'
        ]);
        exit;
    }
    
    // NOUVEAU NOM (code + extension)
    $newFilename = $article_code . '.' . $extension;
    $destination = $uploadDir . $newFilename;
    
    // 1. METTRE √Ä JOUR LE CSV (CONSERVER LE NOM)
    updateCSV($article_code, $article_name, $price, $category);
    
    // 2. D√âPLACER LE FICHIER
    if (move_uploaded_file($file['tmp_name'], $destination)) {
        echo json_encode([
            'success' => true,
            'message' => '‚úÖ Photo upload√©e avec succ√®s!',
            'filename' => $newFilename,
            'article_name' => $article_name, // NOM RETOURN√â
            'article_code' => $article_code,
            'category' => $category
        ]);
    } else {
        echo json_encode([
            'success' => false,
            'message' => 'ERREUR: Impossible de d√©placer le fichier.'
        ]);
    }
}

// FONCTION POUR METTRE √Ä JOUR LE CSV
function updateCSV($code, $name, $price, $category) {
    $csvFile = "data/" . $category . ".csv";
    
    if (!file_exists($csvFile)) {
        // Cr√©er le fichier s'il n'existe pas
        file_put_contents($csvFile, "CODE_ARTICLE\\tARTICLES\\tPRIX\\n");
    }
    
    $lines = file($csvFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $updatedLines = [];
    $found = false;
    
    foreach ($lines as $line) {
        // Skip header
        if (strpos($line, "CODE_ARTICLE") !== false) {
            $updatedLines[] = $line;
            continue;
        }
        
        $parts = explode("\\t", $line);
        
        if (count($parts) >= 2) {
            $currentCode = trim($parts[0]);
            
            if ($currentCode == $code) {
                // METTRE √Ä JOUR LA LIGNE EXISTANTE
                $parts[1] = $name; // CONSERVER LE NOM
                if (count($parts) >= 3) {
                    $parts[2] = $price;
                }
                $found = true;
            }
            
            $updatedLines[] = implode("\\t", $parts);
        }
    }
    
    // Si non trouv√©, ajouter une nouvelle ligne
    if (!$found) {
        $updatedLines[] = $code . "\\t" . $name . "\\t" . $price;
    }
    
    // Sauvegarder
    file_put_contents($csvFile, implode("\\n", $updatedLines));
    
    return true;
}
?>`;

// Pour cr√©er le fichier PHP, d√©commentez la ligne suivante:
// console.log("Copiez ce code dans upload-article-photo.php:\n\n" + phpUploadCode);
</script>
</body>
</html>
