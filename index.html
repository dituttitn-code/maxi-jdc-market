<!-- ===================== PANIER + FICHE CLIENT + ADMIN (BLOC UNIQUE) ===================== -->
<style>
/* Bouton Panier visible d√®s ouverture (HAUT DROITE) */
.cart-fab{
  position:fixed;
  right:16px;
  top:16px;
  left:auto;
  bottom:auto;
  z-index:99999;

  padding:10px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
  background: rgba(17,24,38,.95);
  color:#fff;
  cursor:pointer;
  font-weight:900;
  box-shadow: 0 16px 40px rgba(0,0,0,.35);
}
.cart-badge{
  display:inline-block; min-width:20px; height:20px; line-height:20px;
  text-align:center; border-radius:999px; margin-left:8px;
  background:#d4af37; color:#111826; font-size:12px; padding:0 6px;
  font-weight:900;
}

/* Drawer panier (cach√© par d√©faut) */
.cart-drawer{
  position:fixed; top:0; right:0; height:100vh; width:min(420px, 92vw);
  background:#0f1522;
  border-left:1px solid rgba(255,255,255,.12);
  z-index:99998;
  transform:translateX(110%);     /* ‚úÖ cach√© par d√©faut */
  transition:.25s ease;
  display:flex; flex-direction:column;
}
.cart-drawer.open{ transform:translateX(0); }

.cart-header{
  padding:14px;
  border-bottom:1px solid rgba(255,255,255,.12);
  display:flex; justify-content:space-between; align-items:center;
}
.cart-close{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:#fff; border-radius:12px; padding:8px 10px; cursor:pointer;
  font-weight:900;
}
.cart-body{ padding:12px 14px; overflow:auto; flex:1; }
.cart-item{
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px; padding:10px; margin-bottom:10px;
  background: rgba(255,255,255,.03);
}
.cart-row{ display:flex; justify-content:space-between; gap:10px; }
.cart-name{ font-weight:900; }
.cart-meta{ opacity:.75; font-size:12px; margin-top:4px; }
.qty-controls{ display:flex; gap:6px; align-items:center; margin-top:8px; }
.qty-btn{
  width:32px; height:32px; border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:#fff; cursor:pointer; font-weight:900;
}
.qty{ min-width:28px; text-align:center; font-weight:900; }

.cart-footer{
  border-top:1px solid rgba(255,255,255,.12);
  padding:12px 14px; display:flex; flex-direction:column; gap:10px;
}
.cart-total{ display:flex; justify-content:space-between; font-weight:900; font-size:16px; }
.cart-actions{ display:flex; gap:10px; flex-wrap:wrap; }
.cart-hint{ font-size:12px; opacity:.8; }

.btn{
  padding:10px 12px; border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:#fff; cursor:pointer; font-weight:900;
}
.btn-gold{ background:#d4af37; color:#111826; border-color:#d4af37; }

/* Modals cach√©s par d√©faut */
.modal{
  position:fixed; inset:0; z-index:999999;
  background: rgba(0,0,0,.55);
  display:none; padding:18px;         /* ‚úÖ cach√© par d√©faut */
}
.modal.open{ display:flex; align-items:center; justify-content:center; }

.modal-card{
  width:min(520px, 95vw);
  background:#0f1522;
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow: 0 16px 60px rgba(0,0,0,.55);
  overflow:hidden;
}
.modal-head{
  padding:14px;
  border-bottom:1px solid rgba(255,255,255,.12);
  display:flex; align-items:center; justify-content:space-between;
}
.modal-body{ padding:14px; display:flex; flex-direction:column; gap:12px; }
.field span{ display:block; font-size:12px; opacity:.8; margin-bottom:6px; }
.field input, .field select, .field textarea{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:#fff;
}
.modal-actions{ display:flex; justify-content:flex-end; margin-top:6px; }
.tiny{ font-size:12px; opacity:.75; }

/* (Optionnel) style bouton ‚ÄúAjouter au panier‚Äù si tu l‚Äôutilises dans les cartes produits */
.add-cart-btn{
  margin-top:10px; width:100%;
  padding:10px 12px; border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color:#fff; cursor:pointer; font-weight:900;
}
</style>

<!-- Bouton Panier (visible d√®s ouverture) -->
<button id="cartFab" class="cart-fab" type="button" title="Ouvrir le panier">
  üõí Panier <span id="cartBadge" class="cart-badge">0</span>
</button>

<!-- Drawer Panier -->
<aside id="cartDrawer" class="cart-drawer" aria-hidden="true">
  <div class="cart-header">
    <h3>üõí Votre panier</h3>
    <button id="cartClose" class="cart-close" type="button">Fermer ‚úñ</button>
  </div>

  <div id="cartItems" class="cart-body"></div>

  <div class="cart-footer">
    <div class="cart-total">
      <span>Total</span>
      <span id="cartTotal">0 dt</span>
    </div>

    <div class="cart-actions">
      <button id="cartClear" class="btn" type="button">Vider</button>
      <button id="openCheckout" class="btn btn-gold" type="button">Valider commande</button>
    </div>

    <div class="cart-hint">Minimum livraison : <b>15 dt</b></div>
  </div>
</aside>

<!-- Modal Fiche Client (cach√© au d√©marrage) -->
<div id="checkoutModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h3>üßæ Informations client</h3>
      <button id="closeCheckout" class="cart-close" type="button">Fermer ‚úñ</button>
    </div>

    <div class="modal-body">
      <label class="field">
        <span>Nom & Pr√©nom *</span>
        <input id="cName" type="text" placeholder="Ex: Lotfi Khelifi" />
      </label>

      <label class="field">
        <span>T√©l√©phone *</span>
        <input id="cPhone" type="tel" placeholder="Ex: 25 600 978" />
      </label>

      <label class="field">
        <span>Mode *</span>
        <select id="cMode">
          <option value="Livraison">Livraison</option>
          <option value="Retrait magasin">Retrait magasin</option>
        </select>
      </label>

      <label class="field" id="addressField">
        <span>Adresse livraison *</span>
        <input id="cAddress" type="text" placeholder="Ex: Jardins de Carthage, derri√®re mosqu√©e Essalem" />
      </label>

      <label class="field">
        <span>Note (optionnel)</span>
        <textarea id="cNote" rows="3" placeholder="Ex: Interphone, √©tage, heure souhait√©e..."></textarea>
      </label>

      <div class="modal-actions">
        <button id="sendWhatsApp" class="btn btn-gold" type="button">Envoyer sur WhatsApp</button>
      </div>

      <div class="tiny">* Champs obligatoires. (Aucun point fid√©lit√© ici.)</div>
    </div>
  </div>
</div>

<!-- Admin cach√© (ouvre seulement avec #admin + PIN) -->
<div id="adminPanel" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <h3>üîí Admin (cach√©)</h3>
      <button id="closeAdmin" class="cart-close" type="button">Fermer ‚úñ</button>
    </div>

    <div class="modal-body">
      <div class="tiny">Pour l‚Äôouvrir : ajoute <b>#admin</b> √† la fin du lien (PIN demand√©).</div>

      <label class="field">
        <span>Code article</span>
        <input id="aCode" type="text" placeholder="Ex: 4124" />
      </label>

      <label class="field">
        <span>Nouveau prix (dt)</span>
        <input id="aPrice" type="number" step="0.001" placeholder="Ex: 6.5" />
      </label>

      <div class="modal-actions" style="gap:10px">
        <button id="saveOverride" class="btn btn-gold" type="button">Enregistrer prix</button>
        <button id="clearOverrides" class="btn" type="button">Effacer tous les prix admin</button>
      </div>

      <div class="tiny">Prix admin enregistr√©s dans ce navigateur (localStorage).</div>
    </div>
  </div>
</div>

<script>
/* ===================== LOGIQUE PANIER + FICHE CLIENT + ADMIN ===================== */
const WHATSAPP_NUMBER = "21625600978";
const MIN_ORDER_DT = 15;

const CART_KEY = "maxi_jdc_cart_v3";
const ADMIN_OVERRIDES_KEY = "maxi_jdc_price_overrides_v1";

function priceToNumber(p){
  if (p == null) return 0;
  const s = String(p).replace(",", ".").replace(/[^\d.]/g, "");
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}
function fmtDT(n){
  const v = Math.round(n * 1000) / 1000;
  return String(v).replace(".", ",") + " dt";
}
function loadJSON(k, fallback){
  try{ return JSON.parse(localStorage.getItem(k)) ?? fallback; }catch(e){ return fallback; }
}
function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

let CART = loadJSON(CART_KEY, {});
let PRICE_OVERRIDES = loadJSON(ADMIN_OVERRIDES_KEY, {});

// UI refs
const cartFab = document.getElementById("cartFab");
const cartBadge = document.getElementById("cartBadge");
const cartDrawer = document.getElementById("cartDrawer");
const cartClose = document.getElementById("cartClose");
const cartItems = document.getElementById("cartItems");
const cartTotalEl = document.getElementById("cartTotal");
const cartClear = document.getElementById("cartClear");
const openCheckout = document.getElementById("openCheckout");

const checkoutModal = document.getElementById("checkoutModal");
const closeCheckout = document.getElementById("closeCheckout");
const sendWhatsAppBtn = document.getElementById("sendWhatsApp");
const cName = document.getElementById("cName");
const cPhone = document.getElementById("cPhone");
const cMode = document.getElementById("cMode");
const addressField = document.getElementById("addressField");
const cAddress = document.getElementById("cAddress");
const cNote = document.getElementById("cNote");

const adminPanel = document.getElementById("adminPanel");
const closeAdmin = document.getElementById("closeAdmin");
const aCode = document.getElementById("aCode");
const aPrice = document.getElementById("aPrice");
const saveOverride = document.getElementById("saveOverride");
const clearOverrides = document.getElementById("clearOverrides");

function openCart(){ cartDrawer.classList.add("open"); cartDrawer.setAttribute("aria-hidden","false"); }
function closeCart(){ cartDrawer.classList.remove("open"); cartDrawer.setAttribute("aria-hidden","true"); }

function openModal(el){ el.classList.add("open"); el.setAttribute("aria-hidden","false"); }
function closeModal(el){ el.classList.remove("open"); el.setAttribute("aria-hidden","true"); }

function cartCount(){ return Object.values(CART).reduce((s,it)=>s+(it.qty||0),0); }
function cartTotal(){ return Object.values(CART).reduce((s,it)=>s+(priceToNumber(it.price)*(it.qty||0)),0); }

function renderCart(){
  cartBadge.textContent = cartCount();
  const items = Object.values(CART);

  if (!items.length){
    cartItems.innerHTML = `<div style="opacity:.75">Panier vide.</div>`;
  } else {
    cartItems.innerHTML = items.map(it=>{
      const line = priceToNumber(it.price) * it.qty;
      return `
        <div class="cart-item">
          <div class="cart-row">
            <div>
              <div class="cart-name">${it.name}</div>
              <div class="cart-meta">Code: ${it.code} ‚Ä¢ Prix: ${fmtDT(priceToNumber(it.price))}</div>
            </div>
            <div style="font-weight:900;color:#d4af37">${fmtDT(line)}</div>
          </div>
          <div class="qty-controls">
            <button class="qty-btn" type="button" onclick="cartDec('${it.code}')">‚àí</button>
            <div class="qty">${it.qty}</div>
            <button class="qty-btn" type="button" onclick="cartInc('${it.code}')">+</button>
          </div>
        </div>
      `;
    }).join("");
  }

  cartTotalEl.textContent = fmtDT(cartTotal());
}

window.addToCart = function(code, name, price){
  code = String(code || "").trim();
  if (!code) return;

  const override = PRICE_OVERRIDES[code];
  const finalPrice = (override != null) ? priceToNumber(override) : priceToNumber(price);

  if (!CART[code]) CART[code] = { code, name: String(name||"Article"), price: finalPrice, qty: 0 };
  CART[code].qty += 1;

  saveJSON(CART_KEY, CART);
  renderCart();
  openCart();
};
window.cartInc = function(code){
  if (!CART[code]) return;
  CART[code].qty += 1;
  saveJSON(CART_KEY, CART);
  renderCart();
};
window.cartDec = function(code){
  if (!CART[code]) return;
  CART[code].qty -= 1;
  if (CART[code].qty <= 0) delete CART[code];
  saveJSON(CART_KEY, CART);
  renderCart();
};
function clearCart(){
  CART = {};
  saveJSON(CART_KEY, CART);
  renderCart();
}

function updateAddressVisibility(){
  const isDelivery = cMode.value === "Livraison";
  addressField.style.display = isDelivery ? "" : "none";
}
cMode.addEventListener("change", updateAddressVisibility);

function validateClient(){
  const name = (cName.value || "").trim();
  const phone = (cPhone.value || "").trim();
  const mode = cMode.value;
  const addr = (cAddress.value || "").trim();

  if (!name) return "Nom & Pr√©nom obligatoire.";
  if (!phone) return "T√©l√©phone obligatoire.";
  if (cartCount() === 0) return "Panier vide.";

  const total = cartTotal();
  if (total < MIN_ORDER_DT) return `Minimum livraison : ${MIN_ORDER_DT} dt. Total actuel : ${fmtDT(total)}.`;

  if (mode === "Livraison" && !addr) return "Adresse obligatoire pour livraison.";
  return null;
}

function buildWhatsAppMessage(){
  const items = Object.values(CART);
  const total = cartTotal();

  const name = (cName.value || "").trim();
  const phone = (cPhone.value || "").trim();
  const mode = cMode.value;
  const addr = (cAddress.value || "").trim();
  const note = (cNote.value || "").trim();

  let msg = `Bonjour MAXI JDC MARKET üëã\nNouvelle commande\n\n`;
  msg += `Client: ${name}\nT√©l√©phone: ${phone}\nMode: ${mode}\n`;
  if (mode === "Livraison") msg += `Adresse: ${addr}\n`;
  if (note) msg += `Note: ${note}\n`;
  msg += `\n--- Articles ---\n`;

  items.forEach(it=>{
    const line = priceToNumber(it.price) * it.qty;
    msg += `‚Ä¢ ${it.name} (Code ${it.code}) x${it.qty} = ${fmtDT(line)}\n`;
  });

  msg += `\nTotal: ${fmtDT(total)}\nMerci.\n`;
  return encodeURIComponent(msg);
}

function sendWhatsApp(){
  const err = validateClient();
  if (err) { alert(err); return; }
  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${buildWhatsAppMessage()}`, "_blank");
}

/* Admin cach√© : ouvre seulement via #admin + PIN */
function openAdminIfHash(){
  if (location.hash !== "#admin") return;
  const pin = prompt("Code admin (PIN) :");
  if (pin !== "2025") { alert("Code incorrect."); location.hash = ""; return; }
  openModal(adminPanel);
}
window.addEventListener("hashchange", openAdminIfHash);

saveOverride.addEventListener("click", ()=>{
  const code = (aCode.value||"").trim();
  const price = (aPrice.value||"").trim();
  if (!code || !price) { alert("Code + prix requis."); return; }
  PRICE_OVERRIDES[code] = priceToNumber(price);
  saveJSON(ADMIN_OVERRIDES_KEY, PRICE_OVERRIDES);
  alert("Prix admin enregistr√© ‚úÖ");
});
clearOverrides.addEventListener("click", ()=>{
  if (!confirm("Effacer tous les prix admin ?")) return;
  PRICE_OVERRIDES = {};
  saveJSON(ADMIN_OVERRIDES_KEY, PRICE_OVERRIDES);
  alert("OK ‚úÖ");
});

/* Events UI */
cartFab.addEventListener("click", ()=>{ renderCart(); openCart(); });
cartClose.addEventListener("click", closeCart);
cartClear.addEventListener("click", clearCart);

openCheckout.addEventListener("click", ()=>{
  if (cartCount() === 0) { alert("Panier vide."); return; }
  updateAddressVisibility();
  openModal(checkoutModal);
});
closeCheckout.addEventListener("click", ()=> closeModal(checkoutModal));
sendWhatsAppBtn.addEventListener("click", sendWhatsApp);

closeAdmin.addEventListener("click", ()=>{ closeModal(adminPanel); location.hash=""; });

/* Init */
renderCart();
updateAddressVisibility();
openAdminIfHash();
</script>
<!-- =================== FIN BLOC UNIQUE =================== -->
