<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MAXI JDC MARKET ‚Äî Commande</title>

  <style>
    :root{
      --bg0:#061014;
      --bg1:#0b1a20;
      --card:#0f232b;
      --card2:#0c1c22;
      --line:rgba(255,255,255,.10);

      --text:#eaf3f7;
      --muted:#a9c0cb;

      --accent:#22c55e;
      --accent2:#2dd4bf;
      --danger:#ff6b6b;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 70% -10%, rgba(45,212,191,.20), transparent 55%),
        radial-gradient(900px 500px at 10% 0%, rgba(34,197,94,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1240px;margin:24px auto;padding:0 14px 28px;}
    .top{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: 22px;
      padding: 16px;
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 5;
      backdrop-filter: blur(10px);
    }
    .topRow{display:flex;gap:14px;align-items:center;flex-wrap:wrap;}
    .brand{display:flex;gap:12px;align-items:center;min-width:260px;}
    .logo{
      width:56px;height:56px;border-radius:14px;border:1px solid var(--line);
      overflow:hidden;flex:0 0 auto;display:grid;place-items:center;background:#111;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block;}
    .brandText h1{margin:0;font-size:22px;letter-spacing:.4px;line-height:1.1;}
    .brandText p{margin:4px 0 0;color:var(--muted);font-size:12.5px;}

    .search{flex:1 1 360px;display:flex;gap:10px;align-items:center;}
    .search input{
      flex:1;height:44px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.06); color: var(--text);
      padding:0 14px; outline:none;
    }
    .btn{
      height:44px;padding:0 14px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.08); color: var(--text);
      cursor:pointer;font-weight:700;
    }
    .btn:hover{ background: rgba(255,255,255,.12); }
    .btn.green{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
    }
    .btn.green:hover{ background: rgba(34,197,94,.26); }

    .pills{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{
      display:inline-flex;gap:8px;align-items:center;padding:7px 12px;border-radius:999px;
      border:1px solid var(--line);background: rgba(255,255,255,.06);
      color: var(--text);font-size:12.5px;white-space:nowrap;
    }
    .pill strong{font-weight:900;}
    .cartPill{
      margin-left:auto;cursor:pointer;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
    }
    .cartPill:hover{ background:rgba(255,255,255,.12); }
    #cartTopCount{
      margin-left:8px;display:inline-grid;place-items:center;min-width:28px;height:22px;padding:0 8px;
      border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);font-weight:900;
    }
    .noteBar{
      margin-top:12px;padding:10px 12px;border-radius:14px;border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);color:var(--muted);font-size:12.5px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .noteBar .ok{color:#a7f3d0;font-weight:800;display:inline-flex;gap:8px;align-items:center;}
    .noteBar .sub{margin-left:auto;color:var(--muted);}

    .grid{margin-top:16px;display:grid;grid-template-columns:320px 1fr;gap:14px;align-items:start;}
    .panel{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:12px 14px;border-bottom:1px solid var(--line);background: rgba(255,255,255,.03);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panelHeader h3{margin:0;font-size:15px;letter-spacing:.2px;}
    .panelHeader .sub{color:var(--muted);font-size:12px;}

    #cats{padding:12px;display:flex;flex-direction:column;gap:10px;}
    .catBtn{
      width:100%;text-align:left;border-radius:14px;border:1px solid var(--line);
      background: rgba(255,255,255,.05); color: var(--text);
      padding:10px 12px; cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .catBtn:hover{ background: rgba(255,255,255,.09); }
    .catBtn.active{
      outline:1px solid rgba(45,212,191,.35);
      border-color: rgba(45,212,191,.35);
      background: rgba(45,212,191,.10);
    }
    .catLeft{display:flex;flex-direction:column;gap:4px;min-width:0;}
    .catTitle{font-weight:900;font-size:13.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .catMeta{color:var(--muted);font-size:11.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .catCount{
      flex:0 0 auto;color:var(--text);font-weight:900;font-size:12px;border:1px solid var(--line);
      background: rgba(0,0,0,.22);border-radius:999px;padding:5px 9px;
    }

    .content{padding:12px;}
    .contentHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 4px 12px;}
    .contentHeader h2{margin:0;font-size:15px;letter-spacing:.2px;}
    .contentHeader .meta{margin:2px 0 0;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;color:var(--muted);font-size:12px;white-space:nowrap;}
    .iconBtn{
      width:34px;height:34px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.06); cursor:pointer;color:var(--text);font-weight:900;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }

    #products{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;}
    .card{
      border-radius:16px;border:1px solid var(--line);background: rgba(255,255,255,.05);
      padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);min-width:0;
    }
    .cardTop{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;min-width:0;}
    .name{
      font-weight:900;font-size:12.5px;line-height:1.25;min-width:0;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .price{
      flex:0 0 auto;font-weight:900;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(45,212,191,.35);background: rgba(45,212,191,.14);
      color:#d9fffb;font-size:12px;white-space:nowrap;margin-left:6px;
    }
    .meta2{margin-top:6px;color:var(--muted);font-size:11.5px;display:flex;flex-direction:column;gap:2px;}
    .qtyRow{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .stepper{
      display:flex;align-items:center;gap:6px;padding:6px;border-radius:999px;border:1px solid var(--line);
      background: rgba(0,0,0,.20);
    }
    .stepper button{
      width:28px;height:28px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.07);color:var(--text);cursor:pointer;font-weight:900;
    }
    .stepper button:hover{ background: rgba(255,255,255,.11); }
    .stepper span{min-width:20px;text-align:center;font-weight:900;color:var(--text);font-size:12.5px;}
    .addBtn{
      height:34px;padding:0 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);color:var(--text);cursor:pointer;font-weight:900;
      display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .addBtn:hover{ background: rgba(255,255,255,.12); }

    .drawer{
      position:fixed;top:0;right:0;height:100%;width:420px;max-width:92vw;
      background: rgba(7,14,18,.92);border-left:1px solid var(--line);
      box-shadow:-20px 0 70px rgba(0,0,0,.65);
      transform: translateX(100%);transition: transform .22s ease;z-index:20;
      display:flex;flex-direction:column;backdrop-filter: blur(14px);
    }
    .drawer.open{ transform: translateX(0); }
    .drawerHeader{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .drawerHeader h3{margin:0;font-size:15px;display:flex;gap:8px;align-items:center;}
    .drawerBody{padding:12px 14px 14px;overflow:auto;flex:1;}
    .section{border:1px solid var(--line);background: rgba(255,255,255,.05);border-radius:16px;padding:12px;margin-bottom:12px;}
    .section h4{margin:0 0 10px;font-size:13px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .section .hint{color:var(--muted);font-size:11.5px;margin-top:6px;line-height:1.35;}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .field label{display:block;font-size:11.5px;color:var(--muted);margin-bottom:5px;font-weight:700;}
    .field input,.field textarea{
      width:100%;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.07);color: var(--text);
      padding:10px 10px;outline:none;font-size:13px;
    }
    .field textarea{min-height:66px;resize:vertical;}
    .miniBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center;}
    .mini{
      height:36px;padding:0 12px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.07);color: var(--text);
      cursor:pointer;font-weight:900;font-size:12.5px;
      transition: all 0.2s ease;
    }
    .mini:hover{ background: rgba(255,255,255,.11); }
    .mini:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(255,255,255,.04) !important;
      border-color: rgba(255,255,255,.08) !important;
    }
    .mini.green{background: rgba(34,197,94,.20);border-color: rgba(34,197,94,.35);}
    .mini.green:hover{ background: rgba(34,197,94,.28); }
    .mini.green:disabled {
      background: rgba(34,197,94,.10) !important;
      border-color: rgba(34,197,94,.20) !important;
    }
    .mini.danger{background: rgba(255,107,107,.16);border-color: rgba(255,107,107,.35);}
    .mini.danger:hover{ background: rgba(255,107,107,.24); }
    .pinRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px;padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.14);color:var(--muted);font-size:12.5px;
    }
    .cartList{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .cartItem{
      border:1px solid var(--line);background: rgba(0,0,0,.18);border-radius:14px;padding:10px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .cartItem .left{min-width:0;display:flex;flex-direction:column;gap:2px;}
    .cartItem .left .t{
      font-weight:900;font-size:12.5px;line-height:1.2;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .cartItem .left .s{color:var(--muted);font-size:11.5px;}
    .cartItem .right{display:flex;align-items:center;gap:8px;flex:0 0 auto;}
    .cartItem .lineTotal{font-weight:900;white-space:nowrap;font-size:12px;color:#d9fffb;}
    .totals{margin-top:10px;border-top:1px solid var(--line);padding-top:10px;display:flex;flex-direction:column;gap:6px;font-size:13px;}
    .totals .trow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .totals .trow span{color:var(--muted);}
    .totals .trow strong{font-weight:900;}
    .warn{margin-top:10px;padding:10px;border-radius:14px;border:1px dashed rgba(255,255,255,.16);background: rgba(0,0,0,.18);color:var(--muted);font-size:12.5px;line-height:1.35;}
    .warn.bad{ border-color: rgba(255,107,107,.35); color:#ffd0d0; }
    .warn.good{ border-color: rgba(34,197,94,.35); color:#d7ffe7; }

    .histToggle{
      width:100%;height:38px;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.06);color: var(--text);cursor:pointer;font-weight:900;
      display:flex;align-items:center;justify-content:space-between;padding:0 12px;
    }
    .histToggle:hover{ background: rgba(255,255,255,.10); }
    .histBox{
      margin-top:10px;display:none;border:1px solid var(--line);background: rgba(0,0,0,.18);
      border-radius:14px;padding:10px;
    }
    .histBox.open{ display:block; }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left;}
    th{color:var(--muted);font-weight:900;font-size:11.5px;}
    td strong{font-weight:900;}

    .drawerFooter{
      padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:10px;align-items:center;
      justify-content:space-between;background: rgba(0,0,0,.25);
    }

    #sendBtn {
      min-width: 120px;
      height: 40px;
      font-size: 13.5px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
    }

    #sendBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.35);
    }

    #sendBtn:active:not(:disabled) {
      transform: translateY(0);
    }

    /* Animation de succ√®s */
    @keyframes pulseSuccess {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    .sent-animation {
      animation: pulseSuccess 1.5s ease;
    }

    .modalBack{position:fixed;inset:0;background: rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:30;padding:16px;}
    .modalBack.open{ display:flex; }
    .modal{width:820px;max-width:96vw;border-radius:18px;border:1px solid var(--line);background: rgba(7,14,18,.96);box-shadow: var(--shadow);overflow:hidden;}
    .modalHead{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--line);}
    .modalHead h3{margin:0;font-size:14px;}
    .modalBody{padding:12px 14px;}
    .modalBody textarea{
      width:100%;min-height:220px;border-radius:14px;border:1px solid var(--line);
      background: rgba(255,255,255,.06);color: var(--text);padding:10px;outline:none;font-size:12.5px;line-height:1.35;
    }
    .modalFoot{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}

    .admin{position:fixed;inset:0;background: rgba(0,0,0,.60);display:none;z-index:40;padding:16px;overflow:auto;}
    .admin.open{ display:block; }
    .adminBox{max-width:980px;margin:20px auto;border-radius:18px;border:1px solid var(--line);background: rgba(7,14,18,.96);box-shadow: var(--shadow);overflow:hidden;}
    .adminHead{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--line);}
    .adminHead h3{margin:0;font-size:14px;}
    .adminBody{padding:12px 14px;}
    .adminBody pre{
      background: rgba(255,255,255,.06);border:1px solid var(--line);border-radius:14px;
      padding:10px;overflow:auto;max-height:520px;font-size:12px;color: var(--text);
    }

    .hintAdmin{margin-top:10px;color: rgba(255,255,255,.35);font-size:11px;text-align:center;}
    @media (max-width: 1020px){.grid{grid-template-columns:1fr} #products{grid-template-columns:repeat(2,minmax(0,1fr))} .brand{min-width:0}}
    @media (max-width: 620px){#products{grid-template-columns:1fr} .drawer{width:94vw}}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo" title="MAXI JDC MARKET">
            <!-- IMPORTANT: chemin relatif (sans /) -->
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET">
          </div>
          <div class="brandText">
            <h1>MAXI JDC MARKET</h1>
            <p>Des prix mini ‚Äî Un MAXI choix</p>
          </div>
        </div>

        <div class="search">
          <input id="q" type="text" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn green" id="globalBtn">Recherche globale</button>
        </div>
      </div>

      <div class="pills">
        <div class="pill">üìç Jardins de Carthage , derri√®re mosqu√©e Essalem</div>
        <div class="pill">üïí 7h ‚Äì 1h</div>
        <div class="pill"><strong>WhatsApp:</strong> 00216 25 600 978</div>

        <div class="pill cartPill" id="cartTopBtn" title="Ouvrir le panier">
          üõí Panier <span id="cartTopCount">0</span>
        </div>
      </div>

      <div class="noteBar">
        <span class="ok">‚úÖ Donn√©es charg√©es depuis <b>data/*.csv</b> ‚Äî une cat√©gorie = un fichier CSV.</span>
        <span class="sub">Conditions : minimum livraison <b>15 dt</b> ¬∑ Livraison gratuite si total ‚â• <b>30 dt</b> ¬∑ Sinon frais <b>5 dt</b> ¬∑ Retrait magasin possible</span>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="panelHeader">
          <h3>Cat√©gories</h3>
          <div class="sub" id="status">Chargement‚Ä¶</div>
        </div>
        <div id="cats"></div>
      </div>

      <div class="panel">
        <div class="content">
          <div class="contentHeader">
            <div class="titleWrap">
              <h2 id="activeLabel">Produits</h2>
              <div class="meta" id="activeMeta">S√©lectionne une cat√©gorie.</div>
            </div>
            <div class="pager">
              <button class="iconBtn" id="prevBtn">‚Äπ</button>
              <span id="pageInfo">Page 1/1</span>
              <button class="iconBtn" id="nextBtn">‚Ä∫</button>
              <span id="countInfo">0 article(s)</span>
            </div>
          </div>

          <div id="products"></div>

          <div class="hintAdmin">Admin : Ctrl + Shift + A (ou ajoute #admin √† l'URL)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer Panier -->
  <aside class="drawer" id="drawer">
    <div class="drawerHeader">
      <h3>üõí Panier & Fiche client</h3>
      <button class="btn" id="closeDrawer">Fermer</button>
    </div>

    <div class="drawerBody">
      <div class="section" id="clientBox">
        <h4><span>üë§ Fiche client (1 seule fois)</span><span class="sub" id="clientLockTxt"></span></h4>

        <div class="row2">
          <div class="field"><label>Nom</label><input id="cName" placeholder="Ex: Lotfi" /></div>
          <div class="field"><label>T√©l√©phone</label><input id="cTel" placeholder="Ex: 55xxxxxx" /></div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Adresse</label>
          <textarea id="cAddr" placeholder="Quartier, rue, rep√®re‚Ä¶"></textarea>
        </div>

        <div class="row2" style="margin-top:10px">
          <div class="field"><label>GPS (lat)</label><input id="cLat" placeholder="ex: 36.85" /></div>
          <div class="field"><label>GPS (lng)</label><input id="cLng" placeholder="ex: 10.30" /></div>
        </div>

        <div class="miniBtns">
          <button class="mini" id="gpsBtn">üìç Utiliser ma position</button>
          <button class="mini green" id="saveClientBtn">Enregistrer</button>
          <button class="mini" id="editClientBtn">Modifier</button>
        </div>

        <div class="hint">Astuce : apr√®s enregistrement, la fiche est verrouill√©e.</div>

        <div class="pinRow">
          <label style="display:flex;gap:8px;align-items:center;cursor:pointer">
            <input type="checkbox" id="pinCart"> √âpingler le panier (laisser ouvert)
          </label>
          <span>üí° Pratique pour voir le total.</span>
        </div>
      </div>

      <div class="section">
        <h4><span>üß∫ Articles</span><span class="sub" id="cartMiniInfo">0 article(s)</span></h4>
        <div class="cartList" id="cartList"></div>

        <div class="totals">
          <div class="trow"><span>Sous-total</span><strong id="subTotal">0,00 dt</strong></div>
          <div class="trow"><span>Frais livraison</span><strong id="shipFee">0,00 dt</strong></div>
          <div class="trow"><span>Total</span><strong id="cartTotal">0,00 dt</strong></div>
        </div>

        <div class="warn" id="ruleBox"></div>

        <button class="histToggle" id="histToggleBtn">
          <span>üßæ Historique client</span><span id="histCount">0</span>
        </button>
        <div class="histBox" id="histBox">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
            <div style="color:var(--muted);font-size:12px">Commandes trouv√©es pour ce t√©l√©phone</div>
            <button class="mini danger" id="clearMyHistoryBtn">Effacer</button>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>Date</th><th>Total</th><th>Articles</th></tr></thead>
              <tbody id="histTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="drawerFooter">
      <button class="mini danger" id="clearCartBtn">Vider panier</button>
      <button class="mini green" id="sendBtn">üöÄ Envoyer</button>
    </div>
  </aside>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>‚úÖ Commande enregistr√©e ‚Äî R√©sum√©</h3>
        <button class="btn" id="closeModal">Fermer</button>
      </div>
      <div class="modalBody"><textarea id="orderText" readonly></textarea></div>
      <div class="modalFoot">
        <button class="mini" id="copyBtn">üìã Copier</button>
        <button class="mini" id="downloadBtn">üíæ T√©l√©charger (.txt)</button>
        <button class="mini green" id="whatsappBtn">üì± Envoyer par WhatsApp</button>
      </div>
    </div>
  </div>

  <div class="admin" id="admin">
    <div class="adminBox">
      <div class="adminHead">
        <h3>üõ†Ô∏è Admin ‚Äî commandes & historique</h3>
        <button class="btn" id="closeAdmin">Fermer</button>
      </div>
      <div class="adminBody">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
          <button class="mini" id="exportBtn">Exporter JSON</button>
          <button class="mini danger" id="clearAllBtn">Effacer tout l'historique</button>
        </div>
        <pre id="adminDump">‚Äî</pre>
      </div>
    </div>
  </div>

<script>
/* CONFIG */
const MIN_ORDER = 15;
const FREE_SHIPPING = 30;
const SHIPPING_FEE = 5;

/* IMPORTANT ‚úÖ chemins relatifs (sans /) */
const CATEGORIES = [
  { key:"hygiene_soins", label:"Hygi√®ne & Soins", file:"data/hygiene_soins.csv" },
  { key: "eaux", label: "Eaux", file: "data/eaux.csv" },  // NOUVELLE CAT√âGORIE
  { key:"fruits_legumes", label:"Fruits & L√©gumes", file:"data/fruits_legumes.csv" },
  { key:"lait_oeufs_produits_frais", label:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
  { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
  { key:"boulangerie_patisserie", label:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
  { key:"epicerie_salee", label:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
  { key:"epicerie_sucree", label:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
  { key:"pates", label:"P√¢tes", file:"data/pates.csv" },
  { key:"conserves", label:"Conserves", file:"data/conserves.csv" },
];

/* HELPERS */
const $ = (id)=>document.getElementById(id);
const fmtDT = (n)=>Number(n||0).toFixed(2).replace(".", ",") + " dt";
const nowStr = ()=> new Date().toLocaleString("fr-FR");
function safeKey(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^\w\-]+/g,""); }
function dlText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

/* STATE */
const state = {
  dataByCat: new Map(),
  activeCat: CATEGORIES[0].key,
  global:false,
  q:"",
  page:1,
  perPage:9,
  qtyPick:{},
  cart:{},
  client:null,
  pinCart:false,
};

function loadLocal(){
  try{ state.cart = JSON.parse(localStorage.getItem("maxi_cart_v1")||"{}") || {}; }catch(e){ state.cart = {}; }
  try{ const c = JSON.parse(localStorage.getItem("maxi_client_v1")||"null"); if(c) state.client = c; }catch(e){}
  try{ state.pinCart = localStorage.getItem("maxi_pin_cart")==="1"; }catch(e){}
}
function saveCart(){ localStorage.setItem("maxi_cart_v1", JSON.stringify(state.cart)); }
function saveClient(){ localStorage.setItem("maxi_client_v1", JSON.stringify(state.client||null)); }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem("maxi_orders_v1")||"[]"); }catch(e){ return []; } }
function saveHistory(arr){ localStorage.setItem("maxi_orders_v1", JSON.stringify(arr||[])); }

/* CSV PARSER */
function parseCSV(text){
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows = [];
  for(const line of lines){
    let parts = line.split("\t");
    if(parts.length < 3) parts = line.split(";");
    if(parts.length < 3) parts = line.split(",");

    parts = parts.map(p => String(p||"").trim()).filter(p => p!=="" );
    if(parts.length < 3) continue;

    const code = parts[0];
    const name = parts[1];
    if(!code || !name) continue;

    const low = String(name).trim().toLowerCase();
    if(["designation","d√©signation","libelle","libell√©"].includes(low)) continue;

    let priceRaw = parts[2];
    for(let i=2;i<parts.length;i++){
      if(/[0-9]/.test(parts[i])){ priceRaw = parts[i]; break; }
    }
    const price = Number(String(priceRaw).replace(",", ".").replace(/[^0-9.]/g,"")) || 0;

    rows.push({ code:String(code).trim(), name:String(name).trim(), price });
  }
  return rows;
}

/* CART */
function cartCount(){ return Object.values(state.cart).reduce((a,it)=>a + (it.qty||0), 0); }
function cartTotal(){ return Object.values(state.cart).reduce((a,it)=>a + (Number(it.price)||0) * (it.qty||0), 0); }
function shippingFee(){
  const total = cartTotal();
  if(total < MIN_ORDER) return null;
  if(total >= FREE_SHIPPING) return 0;
  return SHIPPING_FEE;
}
function grandTotal(){
  const fee = shippingFee();
  if(fee === null) return null;
  return cartTotal() + fee;
}

/* UI */
function buildCats(){
  const box = $("cats");
  box.innerHTML = "";
  for(const c of CATEGORIES){
    const btn = document.createElement("button");
    btn.className = "catBtn" + (state.activeCat===c.key ? " active" : "");
    btn.onclick = ()=>{
      state.activeCat = c.key;
      state.global = false;
      state.page = 1;
      buildCats();
      render();
    };

    const left = document.createElement("div");
    left.className = "catLeft";
    left.innerHTML = `<div class="catTitle">${c.label}</div><div class="catMeta">CSV: ${c.file}</div>`;

    const count = document.createElement("div");
    count.className = "catCount";
    const items = state.dataByCat.get(c.key) || [];
    count.textContent = items.length + " article(s)";

    btn.appendChild(left);
    btn.appendChild(count);
    box.appendChild(btn);
  }
}
function getActiveCat(){ return CATEGORIES.find(x=>x.key===state.activeCat) || CATEGORIES[0]; }

function getVisibleItems(){
  let items = [];
  if(state.global){
    for(const c of CATEGORIES){
      const arr = state.dataByCat.get(c.key) || [];
      items.push(...arr.map(it=>({...it, catKey:c.key, catLabel:c.label})));
    }
  }else{
    const c = getActiveCat();
    const arr = state.dataByCat.get(c.key) || [];
    items = arr.map(it=>({...it, catKey:c.key, catLabel:c.label}));
  }

  const q = String(state.q||"").trim().toLowerCase();
  if(q){
    items = items.filter(it =>
      (it.name||"").toLowerCase().includes(q) ||
      (it.code||"").toLowerCase().includes(q) ||
      (it.catLabel||"").toLowerCase().includes(q)
    );
  }
  items.sort((a,b)=>String(a.name).localeCompare(String(b.name), "fr"));
  return items;
}

function render(){
  const active = getActiveCat();
  $("activeLabel").textContent = state.global ? "Recherche globale" : active.label;
  $("activeMeta").textContent = state.global
    ? "Toutes cat√©gories ‚Äî r√©sultats filtr√©s"
    : `Source: ${active.file} ¬∑ Mise √† jour rapide (prix + nouveaux articles)`;

  const items = getVisibleItems();
  const totalPages = Math.max(1, Math.ceil(items.length / state.perPage));
  if(state.page > totalPages) state.page = totalPages;

  const start = (state.page-1)*state.perPage;
  const pageItems = items.slice(start, start + state.perPage);

  $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
  $("countInfo").textContent = `${items.length} article(s)`;

  const box = $("products");
  box.innerHTML = "";

  for(const it of pageItems){
    const pid = safeKey(`${it.catKey}_${it.code}_${it.name}`);
    if(state.qtyPick[pid] == null) state.qtyPick[pid] = 0;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="cardTop">
        <div class="name"></div>
        <div class="price">${fmtDT(it.price)}</div>
      </div>
      <div class="meta2">
        <div>Code: ${it.code} ¬∑ ${it.catLabel}</div>
      </div>
      <div class="qtyRow">
        <div class="stepper">
          <button data-act="minus">‚àí</button>
          <span class="qv">${state.qtyPick[pid]||0}</span>
          <button data-act="plus">+</button>
        </div>
        <button class="addBtn">üß∫ Ajouter</button>
      </div>
    `;
    card.querySelector(".name").textContent = it.name;

    card.querySelector('[data-act="minus"]').onclick = ()=>{
      state.qtyPick[pid] = Math.max(0, (state.qtyPick[pid]||0)-1);
      render();
    };
    card.querySelector('[data-act="plus"]').onclick = ()=>{
      state.qtyPick[pid] = (state.qtyPick[pid]||0)+1;
      render();
    };
    card.querySelector(".addBtn").onclick = ()=>{
      const q = state.qtyPick[pid]||0;
      if(q<=0) return;
      if(state.cart[pid]) state.cart[pid].qty += q;
      else state.cart[pid] = { pid, name:it.name, code:it.code, price:it.price, catLabel:it.catLabel, qty:q };
      state.qtyPick[pid] = 0;
      saveCart();
      refreshCartUI(true);
    };

    box.appendChild(card);
  }

  refreshCartUI(false);
}

function openDrawer(){ $("drawer").classList.add("open"); }
function closeDrawer(){ if(state.pinCart) return; $("drawer").classList.remove("open"); }

function getClientTel(){
  const t = ($("cTel").value||"").trim();
  return t || (state.client?.tel || "");
}
function refreshClientHistoryTable(){
  const tel = getClientTel();
  const tbody = $("histTbody");
  tbody.innerHTML = "";
  const all = loadHistory();
  const rows = all.filter(o => String(o.client?.tel||"") === String(tel||""));
  $("histCount").textContent = rows.length;
  for(const o of rows.slice().reverse()){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${o.date}</td><td><strong>${fmtDT(o.total)}</strong></td><td>${o.itemsCount}</td>`;
    tbody.appendChild(tr);
  }
}

function refreshCartUI(maybeOpen){
  $("cartTopCount").textContent = cartCount();
  $("cartMiniInfo").textContent = cartCount() + " article(s)";

  const list = $("cartList");
  list.innerHTML = "";
  const keys = Object.keys(state.cart);

  if(!keys.length){
    const e = document.createElement("div");
    e.className = "warn";
    e.textContent = "Panier vide. Ajoute des articles üôÇ";
    list.appendChild(e);
  }else{
    for(const pid of keys){
      const it = state.cart[pid];
      const row = document.createElement("div");
      row.className = "cartItem";

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `<div class="t"></div><div class="s">Code: ${it.code} ¬∑ ${it.catLabel} ¬∑ ${fmtDT(it.price)}</div>`;
      left.querySelector(".t").textContent = it.name;

      const right = document.createElement("div");
      right.className = "right";

      const step = document.createElement("div");
      step.className = "stepper";

      const minus = document.createElement("button");
      minus.textContent = "‚àí";
      minus.onclick = ()=>{
        it.qty = Math.max(0, (it.qty||0)-1);
        if(it.qty===0) delete state.cart[pid];
        saveCart();
        refreshCartUI(false);
      };

      const val = document.createElement("span");
      val.textContent = it.qty||0;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.onclick = ()=>{
        it.qty = (it.qty||0)+1;
        saveCart();
        refreshCartUI(false);
      };

      step.appendChild(minus); step.appendChild(val); step.appendChild(plus);

      const lineTotal = document.createElement("div");
      lineTotal.className = "lineTotal";
      lineTotal.textContent = fmtDT((Number(it.price)||0) * (it.qty||0));

      right.appendChild(step);
      right.appendChild(lineTotal);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    }
  }

  $("subTotal").textContent = fmtDT(cartTotal());
  const fee = shippingFee();
  $("shipFee").textContent = fee===null ? "‚Äî" : fmtDT(fee);

  const g = grandTotal();
  if(g===null){
    $("cartTotal").textContent = "Minimum commande 15 dt";
    $("cartTotal").style.color = "var(--danger)";
  }else{
    $("cartTotal").textContent = fmtDT(g);
    $("cartTotal").style.color = "";
  }

  const rule = $("ruleBox");
  const t = cartTotal();
  if(t <= 0){
    rule.className = "warn"; rule.textContent = "Ajoute des articles pour commencer.";
  }else if(t < MIN_ORDER){
    rule.className = "warn bad";
    rule.textContent = `‚ö†Ô∏è Minimum commande: ${MIN_ORDER} dt. Il manque ${fmtDT(MIN_ORDER - t)} (hors frais).`;
  }else if(t >= FREE_SHIPPING){
    rule.className = "warn good";
    rule.textContent = `‚úÖ Livraison gratuite (total ‚â• ${FREE_SHIPPING} dt).`;
  }else{
    rule.className = "warn";
    rule.textContent = `‚ÑπÔ∏è Frais livraison: ${SHIPPING_FEE} dt (gratuite √† partir de ${FREE_SHIPPING} dt).`;
  }

  // Mise √† jour de l'√©tat du bouton Envoyer
  const sendBtn = $("sendBtn");
  const clientOK = ensureClientOK();
  
  if(g === null || !clientOK) {
    sendBtn.disabled = true;
    sendBtn.title = !clientOK ? "Enregistrez la fiche client d'abord" : "Minimum commande 15 dt";
  } else {
    sendBtn.disabled = false;
    sendBtn.title = "Envoyer la commande";
  }

  refreshClientHistoryTable();
  if(state.pinCart || maybeOpen) openDrawer();
}

/* Client */
function applyClientUI(){
  const c = state.client;
  const locked = !!(c && c.locked);
  $("cName").value = c?.name || "";
  $("cTel").value = c?.tel || "";
  $("cAddr").value = c?.addr || "";
  $("cLat").value = c?.lat || "";
  $("cLng").value = c?.lng || "";

  for(const id of ["cName","cTel","cAddr","cLat","cLng"]){ $(id).disabled = locked; }
  $("saveClientBtn").disabled = locked;
  $("gpsBtn").disabled = locked;
  $("clientLockTxt").textContent = locked ? "Fiche enregistr√©e (verrouill√©e)" : "";
}
function readClientFromForm(){
  return {
    name: $("cName").value.trim(),
    tel: $("cTel").value.trim(),
    addr: $("cAddr").value.trim(),
    lat: $("cLat").value.trim(),
    lng: $("cLng").value.trim(),
    locked: true
  };
}
function ensureClientOK(){
  const c = state.client;
  return !!(c && c.locked && c.name && c.tel);
}

/* Order text */
function buildOrderText(order){
  const c = order.client || {};
  let txt = "";
  txt += `üõí Commande MAXI JDC MARKET\n`;
  txt += `Date: ${order.date}\n`;
  txt += `Commande ID: ${order.id}\n\n`;
  txt += `Client:\n- Nom: ${c.name}\n- Tel: ${c.tel}\n- Adresse: ${c.addr}\n`;
  if(c.lat && c.lng) txt += `- GPS: ${c.lat}, ${c.lng}\n`;
  txt += `\nArticles:\n`;
  for(const it of order.items){
    txt += `- ${it.qty} √ó ${it.name} (${fmtDT(it.price)}) = ${fmtDT(it.qty*it.price)}\n`;
  }
  txt += `\nSous-total: ${fmtDT(order.subtotal)}\nFrais livraison: ${fmtDT(order.fee)}\nTOTAL: ${fmtDT(order.total)}\n`;
  return txt;
}

function formatForWhatsApp(text) {
  const lines = text.split('\n');
  const emojiMap = {
    'Date:': 'üìÖ',
    'Commande ID:': 'üÜî',
    'Client:': 'üë§',
    'Nom:': 'üë®',
    'Tel:': 'üì±',
    'Adresse:': 'üìç',
    'GPS:': 'üó∫Ô∏è',
    'Articles:': 'üõçÔ∏è',
    'Sous-total:': 'üí∞',
    'Frais livraison:': 'üöö',
    'TOTAL:': 'üíµ'
  };
  
  return lines.map(line => {
    for (const [key, emoji] of Object.entries(emojiMap)) {
      if (line.startsWith(key)) {
        return emoji + ' ' + line;
      }
    }
    return line;
  }).join('\n');
}

/* Admin */
function openAdmin(){
  const pass = prompt("Mot de passe Admin ?");
  if(pass !== "1234"){ alert("Mot de passe incorrect."); return; }
  $("admin").classList.add("open");
  $("adminDump").textContent = JSON.stringify(loadHistory(), null, 2);
}

/* EVENTS */
$("clearBtn").onclick = ()=>{ $("q").value=""; state.q=""; state.page=1; $("q").blur(); render(); };
$("globalBtn").onclick = ()=>{ state.global=true; state.page=1; render(); };
$("q").addEventListener("input", ()=>{ state.q=$("q").value; state.page=1; render(); });
$("prevBtn").onclick = ()=>{ state.page=Math.max(1,state.page-1); render(); };
$("nextBtn").onclick = ()=>{
  const total = getVisibleItems().length;
  const totalPages = Math.max(1, Math.ceil(total/state.perPage));
  state.page=Math.min(totalPages,state.page+1);
  render();
};

$("cartTopBtn").onclick = openDrawer;
$("closeDrawer").onclick = closeDrawer;

$("pinCart").addEventListener("change", ()=>{
  state.pinCart = $("pinCart").checked;
  localStorage.setItem("maxi_pin_cart", state.pinCart ? "1":"0");
  if(state.pinCart) openDrawer();
});

$("saveClientBtn").onclick = ()=>{
  const c = readClientFromForm();
  if(!c.name || !c.tel){ alert("Veuillez remplir Nom + T√©l√©phone."); return; }
  state.client = c; saveClient(); applyClientUI(); refreshClientHistoryTable();
  alert("‚úÖ Fiche client enregistr√©e");
};
$("editClientBtn").onclick = ()=>{
  if(!state.client) state.client = {name:"",tel:"",addr:"",lat:"",lng:"",locked:false};
  state.client.locked = false; saveClient(); applyClientUI();
};
$("gpsBtn").onclick = ()=>{
  if(!navigator.geolocation){ alert("GPS non disponible."); return; }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{ $("cLat").value = pos.coords.latitude.toFixed(6); $("cLng").value = pos.coords.longitude.toFixed(6); },
    ()=>alert("Permission GPS refus√©e ?"),
    {enableHighAccuracy:true, timeout:12000}
  );
};

$("clearCartBtn").onclick = ()=>{
  if(!confirm("Vider le panier ?")) return;
  state.cart = {}; saveCart(); refreshCartUI(false);
};

$("sendBtn").onclick = async ()=>{
  const sendBtn = $("sendBtn");
  const originalText = sendBtn.textContent;
  
  // Validation
  const g = grandTotal();
  if (g === null) {
    alert("‚ùå Minimum commande 15 dt.");
    return;
  }
  
  if (!ensureClientOK()) {
    alert("üìù Veuillez enregistrer la fiche client avant d'envoyer.");
    openDrawer();
    return;
  }
  
  const items = Object.values(state.cart).filter(x => x.qty > 0);
  if (!items.length) {
    alert("üß∫ Panier vide.");
    return;
  }
  
  // Confirmation
  const totalItems = items.reduce((a, x) => a + x.qty, 0);
  const confirmMsg = `CONFIRMER L'ENVOI\n\n` +
    `üì¶ ${totalItems} article(s)\n` +
    `üí∞ Total: ${fmtDT(g)}\n` +
    `üë§ ${state.client.name}\n` +
    `üì± ${state.client.tel}\n\n` +
    `La commande sera enregistr√©e.`;
  
  if (!confirm(confirmMsg)) return;
  
  // Animation d'envoi
  sendBtn.disabled = true;
  sendBtn.innerHTML = "‚è≥ Traitement...";
  sendBtn.classList.add("sent-animation");
  
  try {
    // Attente pour l'UX
    await new Promise(resolve => setTimeout(resolve, 600));
    
    // Cr√©ation de la commande
    const order = {
      id: "MJDC-" + Date.now().toString().slice(-8),
      date: nowStr(),
      client: { ...state.client },
      items: items.map(it => ({
        pid: it.pid,
        code: it.code,
        name: it.name,
        price: Number(it.price) || 0,
        qty: it.qty || 0,
        catLabel: it.catLabel
      })),
      itemsCount: totalItems,
      subtotal: cartTotal(),
      fee: shippingFee() ?? 0,
      total: g
    };
    
    // Sauvegarde
    const all = loadHistory();
    all.push(order);
    saveHistory(all);
    
    // Affichage du r√©sum√©
    $("orderText").value = buildOrderText(order);
    $("modalBack").classList.add("open");
    
    // Vidage du panier
    state.cart = {};
    saveCart();
    refreshCartUI(false);
    
    // Restauration du bouton
    setTimeout(() => {
      sendBtn.innerHTML = "‚úÖ Envoy√©";
      setTimeout(() => {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        sendBtn.classList.remove("sent-animation");
      }, 1500);
    }, 300);
    
  } catch (error) {
    console.error("Erreur envoi:", error);
    sendBtn.innerHTML = "‚ùå Erreur";
    setTimeout(() => {
      sendBtn.innerHTML = originalText;
      sendBtn.disabled = false;
      sendBtn.classList.remove("sent-animation");
    }, 2000);
    alert("Une erreur est survenue lors de l'envoi.");
  }
};

$("closeModal").onclick = ()=> $("modalBack").classList.remove("open");
$("copyBtn").onclick = async ()=>{
  try{ await navigator.clipboard.writeText($("orderText").value); alert("‚úÖ Copi√© dans le presse-papier"); }
  catch(e){ alert("Copie impossible. Copie manuellement."); }
};
$("downloadBtn").onclick = ()=> dlText("commande-maxi-jdc.txt", $("orderText").value);
$("whatsappBtn").onclick = () => {
  const text = $("orderText").value;
  const formattedText = formatForWhatsApp(text);
  const whatsappNumber = "21625600978"; // Votre num√©ro
  const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(formattedText)}`;
  window.open(url, '_blank');
};

$("histToggleBtn").onclick = ()=> $("histBox").classList.toggle("open");
$("clearMyHistoryBtn").onclick = ()=>{
  const tel = getClientTel();
  if(!tel){ alert("Saisis le t√©l√©phone."); return; }
  if(!confirm("Effacer l'historique pour ce t√©l√©phone ?")) return;
  const all = loadHistory();
  saveHistory(all.filter(o => String(o.client?.tel||"") !== String(tel)));
  refreshClientHistoryTable();
  alert("‚úÖ Historique effac√©");
};

document.addEventListener("keydown", (e)=>{
  if(e.ctrlKey && e.shiftKey && (e.key==="A" || e.key==="a")) openAdmin();
});
if(location.hash.includes("admin")) setTimeout(()=>openAdmin(), 300);

$("closeAdmin").onclick = ()=> $("admin").classList.remove("open");
$("exportBtn").onclick = ()=> dlText("maxi_jdc_orders.json", JSON.stringify(loadHistory(), null, 2));
$("clearAllBtn").onclick = ()=>{
  if(!confirm("Effacer tout l'historique ?")) return;
  saveHistory([]); $("adminDump").textContent = "[]"; refreshClientHistoryTable();
  alert("‚úÖ Historique global effac√©");
};

/* LOAD DATA */
async function loadAll(){
  $("status").textContent = "Chargement‚Ä¶";
  for(const c of CATEGORIES){
    try{
      const r = await fetch(c.file, {cache:"no-store"});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const text = await r.text();
      const items = parseCSV(text);
      state.dataByCat.set(c.key, items);
    }catch(e){
      console.warn("Erreur CSV", c.file, e);
      state.dataByCat.set(c.key, []);
    }
  }
  $("status").textContent = "OK";
  buildCats();
  render();
}

loadLocal();
applyClientUI();
$("pinCart").checked = state.pinCart;
if(state.pinCart) openDrawer();
loadAll().then(()=>refreshCartUI(false));
</script>
</body>
</html>

