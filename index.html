<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Livraison</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --card:#121214;
      --soft:#1b1b1e;
      --text:#f3f3f5;
      --muted:#a8a8b3;
      --accent:#00c853;
      --accent-soft:rgba(0,200,83,.25);
      --border:#2a2a2f;
      --radius:18px;
      --radius-sm:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #1a1a1f 0%, var(--bg) 55%);
      color:var(--text);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:14px 12px 48px}

    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg, rgba(11,11,12,.95) 0%, rgba(11,11,12,.78) 75%, rgba(11,11,12,.0) 100%);
      backdrop-filter: blur(8px);
      padding:10px 0 14px;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(18,18,20,.72);
      border-radius:22px;
      padding:10px 12px;
    }

    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:#111;
      overflow:hidden;
      display:grid;place-items:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:15px;letter-spacing:.6px}
    .slogan{margin:2px 0 0;color:var(--muted);font-size:12px}

    .header-actions{display:flex;align-items:center;gap:10px}
    .header-info{display:flex;flex-direction:column;gap:3px;font-size:12px;color:var(--muted)}
    .header-info strong{color:var(--text)}
    .header-qr{display:flex;align-items:center;gap:8px}
    .qr-mini{
      width:44px;height:44px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;background:#fff;
    }
    .qr-mini img{width:100%;height:100%;object-fit:cover}

    .cart-button{
      display:flex;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.85);
      padding:8px 10px;border-radius:999px;
      cursor:pointer;user-select:none;
      min-width:140px;justify-content:space-between;
    }
    .cart-total-mini{font-size:12px;color:var(--muted)}
    .cart-count-badge{
      min-width:22px;height:22px;border-radius:999px;
      background:var(--accent);color:#021a0c;
      display:grid;place-items:center;
      font-weight:800;font-size:12px;
    }

    .section-title{
      margin:18px 0 10px;
      font-size:16px;
      color:var(--text);
    }

    .categories-list{
      display:flex;flex-wrap:wrap;gap:8px;
      margin-bottom:12px;
    }
    .category-pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,16,18,.7);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .category-pill.active{
      background:var(--accent-soft);
      border-color:rgba(0,200,83,.45);
      color:#eafff2;
      font-weight:700;
    }

    .search-bar{
      display:flex;gap:8px;align-items:center;
      margin:10px 0 12px;
    }
    .search-bar input{
      flex:1;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(18,18,20,.8);
      color:var(--text);
      outline:none;
    }
    .search-bar button{
      border:none;
      background:var(--accent);
      color:#021a0c;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
    }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(190px, 1fr));
      gap:10px;
    }

    .product-card{
      border-radius:var(--radius-sm);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(18,18,20,.92);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:320px;
    }

    /* ‚úÖ FIX IMAGE: pas coup√©e, centr√©e, m√™me taille */
    .product-img{
      width:100%;
      height:140px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#0b0b0c;
      object-fit:contain;     /* IMPORTANT */
      object-position:center; /* IMPORTANT */
      display:block;
      padding:6px;            /* un petit air autour */
    }

    .product-header{
      display:flex;justify-content:space-between;gap:8px;align-items:flex-start;
    }
    .product-name{font-weight:800;font-size:13px;line-height:1.15}
    .product-meta{font-size:12px;color:var(--muted);margin-top:2px}
    .product-price{
      font-weight:900;
      font-size:14px;
      text-align:right;
      white-space:nowrap;
    }

    .product-actions{
      margin-top:auto;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
    }

    .qty-control{
      display:inline-flex;align-items:center;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background:rgba(16,16,18,.75);
    }
    .qty-control button{
      border:none;background:transparent;color:var(--text);
      padding:6px 10px;font-size:16px;cursor:pointer;
    }
    .qty-control span{padding:0 10px;color:var(--text);min-width:22px;text-align:center}

    .btn-add{
      flex:1;
      border:none;
      background:var(--accent);
      color:#021a0c;
      font-weight:900;
      padding:10px 10px;
      border-radius:999px;
      cursor:pointer;
      line-height:1.1;
    }

    .small-text{font-size:12px;color:var(--muted)}
    #loading{padding:12px;color:var(--muted)}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET">
          </div>
          <div>
            <h1>MAXI JDC MARKET</h1>
            <div class="slogan">Des prix mini ‚Äì Un MAXI choix</div>
          </div>
        </div>

        <div class="header-actions">
          <div class="header-info">
            <div>üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</div>
            <div>‚è∞ 7h ‚Äì 1h du matin</div>
            <div>üì± WhatsApp : <strong>00216 25 600 978</strong></div>
          </div>

          <div class="header-qr">
            <div class="qr-mini" title="QR site">
              <img src="qr-maxi-jdc-site.jpg" alt="QR MAXI JDC MARKET">
            </div>
          </div>

          <div class="cart-button" id="open-cart">
            <div>
              <div style="font-weight:800">üß∫ Panier</div>
              <div class="cart-total-mini"><span id="mini-cart-total">0,000</span> dt</div>
            </div>
            <div class="cart-count-badge" id="mini-cart-count">0</div>
          </div>
        </div>
      </div>

      <h3 class="section-title">Cat√©gories</h3>
      <div class="categories-list" id="categories-container"></div>

      <div class="search-bar">
        <input id="search" placeholder="Rechercher un produit‚Ä¶" />
        <button id="clear-search" type="button">X</button>
      </div>

      <h3 class="section-title">Produits</h3>
      <div id="loading">Chargement des produits‚Ä¶</div>
      <div class="products-grid" id="products-container"></div>
    </div>
  </header>

  <script>
    // =========================
    // CONFIG
    // =========================
    const PRODUCTS_JSON_URL = "products.json";
    const PLACEHOLDER = "placeholder.jpg";

    // ‚úÖ corrections codes (ce que tu m‚Äôas envoy√©)
    const CATEGORY_OVERRIDES_BY_CODE = {
      "2481": "Hygi√®ne et entretien",
      "3143": "Hygi√®ne et entretien",
      "2482": "Hygi√®ne et entretien",
      "4497": "Hygi√®ne et entretien",
      "4484": "√âpicerie sal√©e",
      "4485": "√âpicerie sal√©e",
      "2999": "Surgel√©s",
      "2639": "Surgel√©s",
      "1335": "Fruits secs & Graines",
      "4322": "Boissons"
    };

    // ‚úÖ r√®gles (si d‚Äôautres erreurs similaires arrivent)
    function smartCategoryFix(name, currentCat){
      const n = (name || "").toUpperCase();

      // Produits nettoyage
      if (/(JUDY|LILAS|LESSIVE|LAVANT|SOL|SURFACES|JEL LAVANT|LIQUIDE VAISSELLE)/.test(n)) return "Hygi√®ne et entretien";

      // Salades / conserves sal√©es
      if (/(SALADE|MECHWIA|HARISSA|THONA|MAKROUNA|CONSERVE|SAUCE|TOMATE)/.test(n)) return "√âpicerie sal√©e";

      // Glaces / bouza / frozen
      if (/(GLACE|BOUZA|LONDON DAIRY|ICE|CORNET)/.test(n)) return "Surgel√©s";

      return currentCat;
    }

    // ‚úÖ Chemin image automatique :
    // Si image = placeholder.jpg ‚Üí on essaye images/products/<CODE>.jpg puis images/<CODE>.jpg
    function resolveImagePath(product){
      const code = String(product.code || product.CODE_ARTICLE || product.id || "").trim();

      const raw = String(product.image || product.imageUrl || product.IMAGE_URL || "").trim();

      // Si l‚Äôutilisateur a mis un chemin complet (ex: images/products/4731.jpg), on le garde
      if (raw && raw !== PLACEHOLDER && raw !== "images/products/" + PLACEHOLDER && raw !== "images/" + PLACEHOLDER){
        // si raw ne contient pas "/", on suppose que c‚Äôest un nom de fichier dans images/products/
        if (!raw.includes("/")) return "images/products/" + raw;
        return raw;
      }

      // Sinon on g√©n√®re automatiquement depuis le code
      if (code){
        return "images/products/" + code + ".jpg";
      }

      // fallback
      return "images/products/" + PLACEHOLDER;
    }

    // fallback si l‚Äôimage n‚Äôexiste pas ‚Üí essayer images/<code>.jpg puis placeholder
    function attachImageFallback(imgEl, product){
      const code = String(product.code || product.CODE_ARTICLE || product.id || "").trim();
      let tried = 0;

      imgEl.addEventListener("error", () => {
        tried++;
        if (tried === 1 && code) {
          imgEl.src = "images/" + code + ".jpg"; // au cas o√π tu as mis les images direct dans /images/
          return;
        }
        imgEl.src = "images/products/" + PLACEHOLDER;
      });
    }

    // =========================
    // APP STATE
    // =========================
    let ALL = [];
    let activeCategory = "Tout";
    let searchTerm = "";

    // =========================
    // UI HELPERS
    // =========================
    function fmtDt(n){
      const x = Number(n || 0);
      return x.toFixed(3).replace(".", ",");
    }

    function normalizeCategory(c){
      const s = String(c || "Divers").trim();
      if (!s) return "Divers";
      return s;
    }

    function buildCategories(products){
      const set = new Set(["Tout"]);
      products.forEach(p => set.add(normalizeCategory(p.category)));
      return Array.from(set);
    }

    function renderCategories(cats){
      const wrap = document.getElementById("categories-container");
      wrap.innerHTML = "";
      cats.forEach(cat => {
        const b = document.createElement("button");
        b.className = "category-pill" + (cat === activeCategory ? " active" : "");
        b.textContent = cat;
        b.onclick = () => {
          activeCategory = cat;
          render();
        };
        wrap.appendChild(b);
      });
    }

    function productMatches(p){
      const catOk = (activeCategory === "Tout") || (p.category === activeCategory);
      if (!catOk) return false;

      if (!searchTerm) return true;
      const q = searchTerm.toLowerCase().trim();
      const hay = (p.name + " " + p.category + " " + (p.code||"")).toLowerCase();
      return hay.includes(q);
    }

    function render(){
      // categories active style refresh
      renderCategories(buildCategories(ALL.filter(p => true)));

      const list = ALL.filter(productMatches);
      const grid = document.getElementById("products-container");
      grid.innerHTML = "";

      list.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";

        const img = document.createElement("img");
        img.className = "product-img";
        img.alt = p.name || "Produit";
        img.src = resolveImagePath(p);
        attachImageFallback(img, p);

        const header = document.createElement("div");
        header.className = "product-header";

        const left = document.createElement("div");
        const name = document.createElement("div");
        name.className = "product-name";
        name.textContent = p.name;

        const meta = document.createElement("div");
        meta.className = "product-meta";
        meta.textContent = `${p.category} ‚Ä¢ ${p.code || ""}`.trim();

        left.appendChild(name);
        left.appendChild(meta);

        const price = document.createElement("div");
        price.className = "product-price";
        price.innerHTML = `${fmtDt(p.price)} dt<br/><span class="small-text">/ ${p.unit || "pi√®ce"}</span>`;

        header.appendChild(left);
        header.appendChild(price);

        const actions = document.createElement("div");
        actions.className = "product-actions";

        const qty = document.createElement("div");
        qty.className = "qty-control";
        const minus = document.createElement("button");
        minus.textContent = "‚àí";
        const qspan = document.createElement("span");
        qspan.textContent = "1";
        const plus = document.createElement("button");
        plus.textContent = "+";

        minus.onclick = () => qspan.textContent = String(Math.max(1, Number(qspan.textContent)-1));
        plus.onclick  = () => qspan.textContent = String(Number(qspan.textContent)+1);

        qty.appendChild(minus);
        qty.appendChild(qspan);
        qty.appendChild(plus);

        const add = document.createElement("button");
        add.className = "btn-add";
        add.textContent = "Ajouter au panier";
        add.onclick = () => {
          alert(`‚úÖ Ajout√© : ${p.name} (x${qspan.textContent})`);
          // ici tu peux connecter ton panier actuel si tu veux
        };

        actions.appendChild(qty);
        actions.appendChild(add);

        card.appendChild(img);
        card.appendChild(header);
        card.appendChild(actions);

        grid.appendChild(card);
      });

      document.getElementById("loading").style.display = "none";
    }

    // =========================
    // LOAD
    // =========================
    async function init(){
      const res = await fetch(PRODUCTS_JSON_URL, { cache:"no-store" });
      const data = await res.json();

      // support 2 formats: [..] ou {categories:[..], products:[..]}
      const items = Array.isArray(data) ? data : (data.products || []);

      ALL = items.map((r) => {
        const code = String(r.code || r.CODE_ARTICLE || r.id || "").trim();
        const name = String(r.name || r.DESIGNATION || "").trim();
        let category = normalizeCategory(r.category || "Divers");

        // 1) override par code
        if (CATEGORY_OVERRIDES_BY_CODE[code]) category = CATEGORY_OVERRIDES_BY_CODE[code];

        // 2) correction automatique par mots-cl√©s
        category = smartCategoryFix(name, category);

        return {
          code,
          name,
          category,
          price: Number(r.price || r.PRX || r.PRIX || 0),
          unit: String(r.unit || "pi√®ce"),
          image: String(r.image || PLACEHOLDER)
        };
      });

      // UI
      renderCategories(buildCategories(ALL));
      render();
    }

    // Search
    document.getElementById("search").addEventListener("input", (e)=>{
      searchTerm = e.target.value || "";
      render();
    });
    document.getElementById("clear-search").onclick = ()=>{
      document.getElementById("search").value = "";
      searchTerm = "";
      render();
    };

    init().catch(err=>{
      console.error(err);
      document.getElementById("loading").textContent = "Erreur de chargement (products.json).";
    });
  </script>
</body>
</html>
