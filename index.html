<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äì Vente en ligne</title>

  <style>
    :root{
      --bg:#070708;
      --panel:#101012;
      --card:#141417;
      --soft:#1c1c21;
      --text:#f3f3f6;
      --muted:#a9a9b6;
      --border:rgba(255,255,255,.10);
      --accent:#00c853;
      --accentSoft:rgba(0,200,83,.22);
      --danger:#ff5252;
      --radius:18px;
      --radiusSm:14px;
      --shadow:0 14px 35px rgba(0,0,0,.55);
      --maxW:1100px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 900px at 10% -10%, #1a1a22 0%, var(--bg) 55%),
        radial-gradient(900px 700px at 90% 0%, rgba(0,200,83,.10) 0%, transparent 60%);
      color:var(--text);
    }
    a{color:inherit}

    .wrap{max-width:var(--maxW);margin:0 auto;padding:12px 12px 40px}

    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(7,7,8,.95) 0%, rgba(7,7,8,.78) 75%, rgba(7,7,8,0) 100%);
      backdrop-filter:blur(10px);
      padding:10px 0 12px;
    }

    .topbar{
      border:1px solid rgba(255,255,255,.07);
      background:rgba(16,16,18,.78);
      border-radius:24px;
      padding:10px 12px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:999px;overflow:hidden;
      border:1px solid rgba(255,255,255,.12);background:#111;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:15px;letter-spacing:.6px}
    .slogan{margin:2px 0 0;font-size:12px;color:var(--muted)}

    .headerRight{display:flex;gap:10px;align-items:center}
    .headerInfo{display:flex;flex-direction:column;gap:2px;font-size:12px;color:var(--muted)}
    .headerInfo strong{color:var(--text)}

    .qr-mini{
      width:44px;height:44px;border-radius:12px;overflow:hidden;background:#fff;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      flex:0 0 auto;
    }
    .qr-mini img{width:100%;height:100%;object-fit:cover}

    .cartBtn{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:9px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(20,20,22,.9);
      cursor:pointer;user-select:none;
      min-width:150px;
    }
    .cartMiniTotal{font-size:12px;color:var(--muted)}
    .cartBadge{
      min-width:22px;height:22px;border-radius:999px;
      background:var(--accent);color:#041a0c;
      font-weight:900;font-size:12px;
      display:grid;place-items:center;
    }

    .hero{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.07);
      background:rgba(16,16,18,.70);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:12px;
    }
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
    .hero h2{margin:0 0 6px;font-size:18px}
    .hero p{margin:0;color:var(--muted);font-size:12px;line-height:1.45}

    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .chip{
      font-size:11px;color:#e8e8ef;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(12,12,14,.65);
      padding:5px 9px;border-radius:999px;
    }

    .rules{
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(12,12,14,.65);
      padding:10px 12px;
      font-size:12px;
      line-height:1.5;
      color:var(--muted);
    }
    .rules strong{color:var(--text)}

    .sectionTitle{margin:18px 0 10px;font-size:16px}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}

    .card{
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.07);
      background:rgba(16,16,18,.78);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .card h3{margin:0 0 8px;font-size:15px}
    .sub{color:var(--muted);font-size:12px;margin:0 0 10px}

    /* Cart */
    .cartItems{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,10,12,.6);
      border-radius:14px;
      padding:10px;
      max-height:260px;
      overflow:auto;
    }
    .cartEmpty{color:var(--muted);font-size:12px;text-align:center;padding:16px 8px}
    .cartItem{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:8px;
      align-items:center;
      padding:8px 0;
      border-bottom:1px dashed rgba(255,255,255,.10);
      font-size:12px;
    }
    .cartItem:last-child{border-bottom:none}
    .cartName{font-weight:650}
    .cartQty{text-align:center;color:var(--muted)}
    .cartTotal{text-align:right;font-weight:900}
    .cartRemove{
      width:28px;height:28px;border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      cursor:pointer;
      color:#ffd1d1;
      background:rgba(255,82,82,.08);
    }

    .summary{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:10px;padding-top:10px;
      border-top:1px solid rgba(255,255,255,.10);
      font-size:13px;
    }
    .summary .label{color:var(--muted)}
    .summary .val{font-weight:950;font-size:16px}

    /* Form */
    .form{display:flex;flex-direction:column;gap:8px}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:12px;color:var(--muted)}
    input,select{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,10,12,.60);
      color:var(--text);
      outline:none;
    }
    input:focus,select:focus{
      border-color:rgba(0,200,83,.55);
      box-shadow:0 0 0 2px rgba(0,200,83,.18);
    }
    .gpsRow{display:flex;gap:8px;align-items:center}
    .gpsBtn{
      padding:8px 10px;border-radius:999px;
      border:1px dashed rgba(0,200,83,.60);
      background:rgba(0,200,83,.10);
      color:#bff7d6;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }
    .gpsVal{font-size:11px;color:var(--muted);word-break:break-all;flex:1}

    .btn{
      border:none;border-radius:999px;
      padding:11px 12px;
      background:var(--accent);
      color:#041a0c;font-weight:950;
      cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .note{font-size:11px;color:var(--muted);line-height:1.45}

    /* Catalog */
    .catalogTop{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      margin-top:16px;
    }
    .search{
      display:flex;gap:8px;align-items:center;
      flex: 1 1 380px;
    }
    .search input{flex:1}
    .clearBtn{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(20,20,22,.75);
      color:var(--text);cursor:pointer;
      font-weight:900;
    }

    .cats{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .cat{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,10,12,.55);
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }
    .cat.active{
      background:var(--accentSoft);
      border-color:rgba(0,200,83,.55);
      color:#eafff2;
      font-weight:900;
    }

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(190px, 1fr));
      gap:10px;
    }

    .pCard{
      border-radius:var(--radiusSm);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(16,16,18,.82);
      padding:10px;
      display:flex;flex-direction:column;gap:8px;
      min-height:330px;
    }

    /* ‚úÖ PHOTO FIX: jamais coup√©e */
    .pImg{
      width:100%;
      height:140px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(7,7,8,.65);
      object-fit:contain;      /* IMPORTANT */
      object-position:center;  /* IMPORTANT */
      display:block;
      padding:6px;
    }

    .pHead{display:flex;gap:8px;justify-content:space-between;align-items:flex-start}
    .pName{font-weight:950;font-size:13px;line-height:1.15}
    .pMeta{font-size:11px;color:var(--muted);margin-top:4px}
    .pPrice{font-weight:950;font-size:14px;text-align:right;white-space:nowrap}
    .pUnit{font-size:11px;color:var(--muted);font-weight:650}

    .pActions{margin-top:auto;display:flex;gap:8px;align-items:center}
    .qty{
      display:inline-flex;align-items:center;overflow:hidden;
      border-radius:999px;border:1px solid rgba(255,255,255,.10);
      background:rgba(10,10,12,.55);
    }
    .qty button{
      border:none;background:transparent;color:var(--text);
      padding:7px 10px;font-size:16px;cursor:pointer;
    }
    .qty span{min-width:26px;text-align:center;font-weight:900}

    /* Pagination */
    .pager{
      margin-top:14px;
      display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;
    }
    .pageBtn{
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,16,18,.78);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .pageBtn.active{
      background:var(--accentSoft);
      border-color:rgba(0,200,83,.55);
      color:#eafff2;
    }
    .pageBtn:disabled{opacity:.5;cursor:not-allowed}

    /* Admin */
    .adminWrap{margin-top:14px}
    .adminPanel{display:none;margin-top:10px}
    .orderBox{
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 0;
      font-size:12px;
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,10,12,.55);
      color:var(--muted);
      font-size:11px;
    }

    /* QR modal */
    .modal{
      position:fixed;inset:0;display:none;z-index:999;
      background:rgba(0,0,0,.65);
      align-items:center;justify-content:center;
      padding:16px;
    }
    .modalContent{
      width:min(420px, 94vw);
      border-radius:18px;
      background:rgba(16,16,18,.95);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow);
      padding:12px;
      text-align:center;
    }
    .modalContent img{
      width:100%;
      max-width:320px;
      border-radius:14px;
      background:#fff;
      padding:10px;
    }
    .modalClose{
      margin-top:10px;
      width:100%;
    }

    footer{
      margin-top:18px;
      text-align:center;
      color:var(--muted);
      font-size:11px;
      padding:14px 12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET">
        </div>
        <div>
          <h1>MAXI JDC MARKET</h1>
          <div class="slogan">Des prix mini ‚Äì Un MAXI choix</div>
        </div>
      </div>

      <div class="headerRight">
        <div class="headerInfo">
          <div>üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</div>
          <div>‚è∞ 7h ‚Äì 1h du matin</div>
          <div>üì± WhatsApp : <strong>00216 25 600 978</strong></div>
        </div>

        <div class="qr-mini" id="qrMini" title="Cliquer pour agrandir">
          <img src="qr-maxi-jdc-site.jpg" alt="QR site MAXI JDC MARKET">
        </div>

        <div class="cartBtn" id="openCartBtn">
          <div>
            <div style="font-weight:950">üß∫ Panier</div>
            <div class="cartMiniTotal"><span id="miniTotal">0,000</span> dt</div>
          </div>
          <div class="cartBadge" id="miniCount">0</div>
        </div>
      </div>
    </div>

    <div class="hero">
      <div>
        <h2>Commandez en ligne</h2>
        <p>Ajoutez vos produits au panier puis envoyez la commande directement sur WhatsApp. Recherche sur tous les articles + pagination.</p>
        <div class="chips">
          <span class="chip">üîé Recherche globale</span>
          <span class="chip">üì¶ Panier WhatsApp</span>
          <span class="chip">üöö Livraison auto</span>
          <span class="chip">üßæ Admin commandes</span>
        </div>
      </div>

      <div class="rules">
        <strong>Conditions de livraison :</strong><br>
        ‚Ä¢ Montant minimum livraison : <strong>15 dt</strong><br>
        ‚Ä¢ Si total produits ‚â• <strong>30 dt</strong> ‚Üí <strong>Livraison gratuite</strong><br>
        ‚Ä¢ Sinon ‚Üí <strong>Frais = 5 dt</strong><br>
        ‚Ä¢ Retrait magasin possible<br>
        ‚Ä¢ Paiement : Esp√®ces (livraison) / Carte (magasin)
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="row" id="cartSection">
    <section class="card">
      <h3>üõí Panier</h3>
      <p class="sub">Ajoutez des produits puis envoyez la commande sur WhatsApp.</p>

      <div class="cartItems" id="cartItems">
        <div class="cartEmpty">Aucun article dans le panier.</div>
      </div>

      <div class="summary">
        <div class="label"><span id="cartCountLabel">0 article</span> ‚Äî Total produits</div>
        <div class="val"><span id="cartTotal">0,000</span> dt</div>
      </div>
      <div class="note" style="margin-top:6px">
        Les frais de livraison (0 ou 5 dt) sont ajout√©s automatiquement selon les r√®gles.
      </div>
    </section>

    <section class="card">
      <h3>üë§ Informations client</h3>
      <p class="sub">Obligatoire pour livraison. (GPS optionnel)</p>

      <form class="form" onsubmit="event.preventDefault(); sendOrder();">
        <div class="field">
          <label>Nom & pr√©nom</label>
          <input id="cName" placeholder="Ex : Lotfi Khelifi" required>
        </div>

        <div class="field">
          <label>T√©l√©phone</label>
          <input id="cPhone" placeholder="Ex : 55 123 456" required>
        </div>

        <div class="field">
          <label>Adresse compl√®te</label>
          <input id="cAddr" placeholder="Immeuble, rue, √©tage, porte‚Ä¶" required>
        </div>

        <div class="field">
          <label>Type de commande</label>
          <select id="orderType" required>
            <option value="Livraison √† domicile" selected>Livraison √† domicile</option>
            <option value="Retrait en magasin">Retrait en magasin</option>
          </select>
        </div>

        <div class="field">
          <label>Mode de paiement</label>
          <select id="payMethod" required>
            <option value="Esp√®ces √† la livraison" selected>Esp√®ces √† la livraison</option>
            <option value="Carte bancaire en magasin">Carte bancaire en magasin</option>
          </select>
        </div>

        <div class="field">
          <label>Localisation GPS (optionnel)</label>
          <div class="gpsRow">
            <button type="button" class="gpsBtn" onclick="getLocation()">üìç R√©cup√©rer ma position</button>
            <div class="gpsVal" id="gpsVal">Aucune position.</div>
          </div>
        </div>

        <button class="btn" type="submit" id="sendBtn">Envoyer la commande sur WhatsApp üì≤</button>
        <div class="note">
          Num√©ro MAXI JDC MARKET : <strong>00216 25 600 978</strong><br>
          Minimum livraison : <strong>15 dt</strong>
        </div>
      </form>
    </section>
  </div>

  <section class="card adminWrap">
    <h3>üîê Espace admin (magasin)</h3>
    <p class="sub">Voir commandes enregistr√©es (localStorage) + changer statut.</p>

    <div class="field">
      <label>Code acc√®s admin</label>
      <input id="adminCode" type="password" placeholder="Code admin (MAXI2024)">
    </div>
    <button class="btn" type="button" onclick="openAdmin()" style="margin-top:8px">Ouvrir admin</button>

    <div class="adminPanel" id="adminPanel">
      <div class="note" style="margin-top:10px">
        Code admin actuel : <strong>MAXI2024</strong> (modifiable dans le code).
      </div>
      <div id="adminOrders"></div>
    </div>
  </section>

  <div class="catalogTop">
    <div class="search">
      <input id="search" placeholder="Rechercher un produit (nom, cat√©gorie, code)‚Ä¶">
      <button class="clearBtn" type="button" id="clearSearch">X</button>
    </div>
    <div class="note" id="countInfo" style="text-align:right;min-width:220px"></div>
  </div>

  <div class="cats" id="cats"></div>

  <div class="grid" id="grid"></div>
  <div class="pager" id="pager"></div>

  <footer>
    MAXI JDC MARKET ‚Äî Jardins de Carthage ‚Ä¢ WhatsApp 00216 25 600 978
  </footer>
</main>

<!-- QR MODAL -->
<div class="modal" id="qrModal">
  <div class="modalContent">
    <div style="font-weight:950;margin-bottom:10px">QR Code (site)</div>
    <img src="qr-maxi-jdc-site.jpg" alt="QR agrandi">
    <button class="btn modalClose" type="button" onclick="closeQr()">Fermer</button>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const PRODUCTS_JSON_URL = "data/products.json"; // IMPORTANT
  const WHATSAPP_NUMBER = "21625600978"; // sans +, sans espaces (wa.me)
  const ADMIN_CODE = "MAXI2024";

  const MIN_DELIVERY = 15;
  const FREE_DELIVERY_FROM = 30;
  const DELIVERY_FEE = 5;

  const PLACEHOLDER = "placeholder.jpg";
  const ORDER_KEY = "maxiOrdersV1";
  const COUNTER_KEY = "maxiOrderCounter";

  const ORDER_STATUSES = ["En attente","En cours de pr√©paration","Pr√™t √† livrer","Livr√©"];

  // Corrections (exemples envoy√©s)
  const CATEGORY_OVERRIDES_BY_CODE = {
    "2481": "Hygi√®ne et entretien",
    "3143": "Hygi√®ne et entretien",
    "2482": "Hygi√®ne et entretien",
    "4497": "Hygi√®ne et entretien",
    "4484": "√âpicerie sal√©e",
    "4485": "√âpicerie sal√©e",
    "2999": "Surgel√©s",
    "2639": "Surgel√©s",
    "1335": "Fruits secs & Graines",
    "4322": "Boissons",
    "4202": "Hygi√®ne et entretien" // LILAS SOL ET SURFACE POMME 1L (pas Fruits)
  };

  function smartCategoryFix(name, current){
    const n = (name||"").toUpperCase();

    // Nettoyage
    if (/(JUDY|LILAS|LESSIVE|LAVANT|SOL|SURFACES|JEL LAVANT|LIQUIDE VAISSELLE|NETTOYANT)/.test(n))
      return "Hygi√®ne et entretien";

    // Conserves sal√©es / salades
    if (/(SALADE|MECHWIA|HARISSA|THONA|CONSERVE|SAUCE|TOMATE|MAKROUNA)/.test(n))
      return "√âpicerie sal√©e";

    // Glaces / bouza / frozen
    if (/(GLACE|BOUZA|LONDON DAIRY|ICE|CORNET|SORBET)/.test(n))
      return "Surgel√©s";

    return current;
  }

  // =========================
  // STATE
  // =========================
  let ALL = [];
  let CATEGORIES = [];
  let activeCat = "Tout";
  let searchTerm = "";
  let page = 1;
  const PAGE_SIZE = 24;

  const cart = {};
  let customerLocation = "";

  // =========================
  // UTILS
  // =========================
  function fmt(n){
    return Number(n||0).toFixed(3).replace(".", ",");
  }
  function normCat(c){
    const s = String(c||"").trim();
    return s ? s : "Divers";
  }
  function codeOf(p){
    return String(p.code || p.CODE_ARTICLE || p.id || "").trim();
  }

  function resolveImage(p){
    const raw = String(p.image||"").trim();
    const code = codeOf(p);

    // si image d√©j√† donn√©e en chemin complet
    if (raw && raw !== PLACEHOLDER) {
      // si juste "4731.jpg" -> on suppose images/products/
      if (!raw.includes("/")) return "images/products/" + raw;
      return raw;
    }

    // sinon automatique via code
    if (code) return "images/products/" + code + ".jpg";
    return "images/products/" + PLACEHOLDER;
  }

  function attachImgFallback(img, p){
    const code = codeOf(p);
    let tried = 0;
    img.addEventListener("error", () => {
      tried++;
      if (tried === 1 && code){
        img.src = "images/" + code + ".jpg"; // au cas o√π tu as mis dans /images/
        return;
      }
      img.src = "images/products/" + PLACEHOLDER;
    });
  }

  function loadOrders(){
    const json = localStorage.getItem(ORDER_KEY);
    return json ? JSON.parse(json) : [];
  }
  function saveOrders(arr){
    localStorage.setItem(ORDER_KEY, JSON.stringify(arr));
  }
  function createOrderId(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    const counter = Number(localStorage.getItem(COUNTER_KEY)||"0")+1;
    localStorage.setItem(COUNTER_KEY, String(counter));
    return `MAXI-${y}${m}${d}-${counter}`;
  }

  // =========================
  // CATALOG FILTER
  // =========================
  function matches(p){
    const catOk = (activeCat === "Tout") || (p.category === activeCat);
    if (!catOk) return false;
    if (!searchTerm) return true;

    const q = searchTerm.toLowerCase().trim();
    const hay = (p.name + " " + p.category + " " + codeOf(p)).toLowerCase();
    return hay.includes(q);
  }

  function filteredList(){
    return ALL.filter(matches);
  }

  // =========================
  // RENDER UI
  // =========================
  function renderCategories(){
    const el = document.getElementById("cats");
    el.innerHTML = "";

    const btnAll = document.createElement("button");
    btnAll.className = "cat" + (activeCat==="Tout" ? " active" : "");
    btnAll.textContent = "Tout";
    btnAll.onclick = () => { activeCat="Tout"; page=1; renderAll(); };
    el.appendChild(btnAll);

    CATEGORIES.forEach(cat => {
      const b = document.createElement("button");
      b.className = "cat" + (activeCat===cat ? " active" : "");
      b.textContent = cat;
      b.onclick = () => { activeCat=cat; page=1; renderAll(); };
      el.appendChild(b);
    });
  }

  function renderGrid(){
    const list = filteredList();
    const total = list.length;

    const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (page > maxPage) page = maxPage;

    const start = (page-1)*PAGE_SIZE;
    const pageItems = list.slice(start, start + PAGE_SIZE);

    document.getElementById("countInfo").textContent =
      `${total} article(s) ‚Ä¢ Page ${page}/${maxPage}`;

    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    pageItems.forEach(p => {
      const card = document.createElement("div");
      card.className = "pCard";

      const img = document.createElement("img");
      img.className = "pImg";
      img.alt = p.name || "Produit";
      img.src = resolveImage(p);
      attachImgFallback(img, p);

      const head = document.createElement("div");
      head.className = "pHead";

      const left = document.createElement("div");
      const name = document.createElement("div");
      name.className = "pName";
      name.textContent = p.name;

      const meta = document.createElement("div");
      meta.className = "pMeta";
      meta.textContent = `${p.category} ‚Ä¢ ${codeOf(p)}`.trim();

      left.appendChild(name);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "pPrice";
      right.innerHTML = `${fmt(p.price)} dt<br><span class="pUnit">/ ${p.unit||"pi√®ce"}</span>`;

      head.appendChild(left);
      head.appendChild(right);

      const actions = document.createElement("div");
      actions.className = "pActions";

      const qty = document.createElement("div");
      qty.className = "qty";
      const minus = document.createElement("button");
      minus.type = "button";
      minus.textContent = "‚àí";
      const qspan = document.createElement("span");
      qspan.textContent = "1";
      const plus = document.createElement("button");
      plus.type = "button";
      plus.textContent = "+";
      minus.onclick = ()=> qspan.textContent = String(Math.max(1, Number(qspan.textContent)-1));
      plus.onclick  = ()=> qspan.textContent = String(Number(qspan.textContent)+1);
      qty.appendChild(minus); qty.appendChild(qspan); qty.appendChild(plus);

      const add = document.createElement("button");
      add.className = "btn";
      add.type = "button";
      add.textContent = "Ajouter";
      add.onclick = ()=> addToCart(p, Number(qspan.textContent));

      actions.appendChild(qty);
      actions.appendChild(add);

      card.appendChild(img);
      card.appendChild(head);
      card.appendChild(actions);

      grid.appendChild(card);
    });

    renderPager(total);
  }

  function renderPager(total){
    const el = document.getElementById("pager");
    el.innerHTML = "";

    const maxPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (maxPage <= 1) return;

    const prev = document.createElement("button");
    prev.className = "pageBtn";
    prev.textContent = "‚óÄ";
    prev.disabled = (page <= 1);
    prev.onclick = ()=> { page--; renderGrid(); };
    el.appendChild(prev);

    // pages (compact)
    const windowSize = 5;
    let start = Math.max(1, page - Math.floor(windowSize/2));
    let end = Math.min(maxPage, start + windowSize - 1);
    start = Math.max(1, end - windowSize + 1);

    if (start > 1){
      el.appendChild(pageNum(1));
      if (start > 2) el.appendChild(dots());
    }

    for (let i=start;i<=end;i++){
      el.appendChild(pageNum(i));
    }

    if (end < maxPage){
      if (end < maxPage-1) el.appendChild(dots());
      el.appendChild(pageNum(maxPage));
    }

    const next = document.createElement("button");
    next.className = "pageBtn";
    next.textContent = "‚ñ∂";
    next.disabled = (page >= maxPage);
    next.onclick = ()=> { page++; renderGrid(); };
    el.appendChild(next);

    function pageNum(n){
      const b = document.createElement("button");
      b.className = "pageBtn" + (n===page ? " active" : "");
      b.textContent = String(n);
      b.onclick = ()=> { page = n; renderGrid(); };
      return b;
    }
    function dots(){
      const s = document.createElement("span");
      s.style.opacity = .6;
      s.style.padding = "0 4px";
      s.textContent = "‚Ä¶";
      return s;
    }
  }

  function renderAll(){
    renderCategories();
    renderGrid();
    updateCartUI();
  }

  // =========================
  // CART
  // =========================
  function addToCart(p, q){
    const key = codeOf(p) || String(p.id);
    if (!cart[key]) cart[key] = { product:p, qty:0 };
    cart[key].qty += q;
    updateCartUI();
  }

  function removeFromCart(key){
    if (cart[key]) delete cart[key];
    updateCartUI();
  }

  function cartEntries(){
    return Object.entries(cart).map(([k,v])=>({ key:k, ...v })).filter(x=>x.qty>0);
  }

  function updateCartUI(){
    const items = cartEntries();
    let totalProducts = 0;
    let totalQty = 0;

    items.forEach(it => {
      totalProducts += Number(it.product.price||0) * it.qty;
      totalQty += it.qty;
    });

    document.getElementById("cartTotal").textContent = fmt(totalProducts);
    document.getElementById("miniTotal").textContent = fmt(totalProducts);
    document.getElementById("miniCount").textContent = String(totalQty);
    document.getElementById("cartCountLabel").textContent =
      totalQty + (totalQty<=1 ? " article" : " articles");

    const listEl = document.getElementById("cartItems");
    if (items.length === 0){
      listEl.innerHTML = "<div class='cartEmpty'>Aucun article dans le panier.</div>";
      return;
    }

    listEl.innerHTML = "";
    items.forEach(it => {
      const row = document.createElement("div");
      row.className = "cartItem";

      const name = document.createElement("div");
      name.className = "cartName";
      name.textContent = it.product.name;

      const qty = document.createElement("div");
      qty.className = "cartQty";
      qty.textContent = "√ó " + it.qty;

      const tot = document.createElement("div");
      tot.className = "cartTotal";
      tot.textContent = fmt(Number(it.product.price||0) * it.qty) + " dt";

      const rm = document.createElement("div");
      rm.className = "cartRemove";
      rm.textContent = "‚úï";
      rm.onclick = ()=> removeFromCart(it.key);

      row.appendChild(name);
      row.appendChild(qty);
      row.appendChild(tot);
      row.appendChild(rm);
      listEl.appendChild(row);
    });
  }

  function clearCartAndForm(){
    for (const k in cart) delete cart[k];
    updateCartUI();
    document.querySelector("form").reset();
    customerLocation = "";
    document.getElementById("gpsVal").textContent = "Aucune position.";
  }

  // =========================
  // GPS
  // =========================
  function getLocation(){
    const out = document.getElementById("gpsVal");
    if (!navigator.geolocation){
      out.textContent = "G√©olocalisation non support√©e.";
      return;
    }
    out.textContent = "Localisation en cours‚Ä¶";
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        customerLocation = `https://www.google.com/maps?q=${lat},${lng}`;
        out.textContent = customerLocation;
      },
      ()=> out.textContent = "Impossible d‚Äôobtenir la position."
    );
  }
  window.getLocation = getLocation;

  // =========================
  // SEND ORDER (WhatsApp)
  // =========================
  function sendOrder(){
    const items = cartEntries();
    if (items.length === 0){
      alert("Votre panier est vide.");
      return;
    }

    const name = document.getElementById("cName").value.trim();
    const phone = document.getElementById("cPhone").value.trim();
    const addr = document.getElementById("cAddr").value.trim();
    const type = document.getElementById("orderType").value;
    const pay = document.getElementById("payMethod").value;

    if (!name || !phone || !addr){
      alert("Veuillez remplir Nom, T√©l√©phone et Adresse.");
      return;
    }

    let totalProducts = 0;
    items.forEach(it => totalProducts += Number(it.product.price||0) * it.qty);

    // Livraison rules
    let deliveryFee = 0;
    if (type === "Livraison √† domicile"){
      if (totalProducts < MIN_DELIVERY){
        alert("Minimum livraison : " + MIN_DELIVERY + " dt.");
        return;
      }
      deliveryFee = (totalProducts >= FREE_DELIVERY_FROM) ? 0 : DELIVERY_FEE;
    }

    const totalToPay = totalProducts + deliveryFee;

    const now = new Date();
    const orderId = createOrderId();
    const dateStr = now.toLocaleString("fr-FR");

    const lines = [];
    lines.push(`üßæ MAXI JDC MARKET`);
    lines.push(`ID : ${orderId}`);
    lines.push(`Date : ${dateStr}`);
    lines.push("");
    lines.push(`üë§ Nom : ${name}`);
    lines.push(`üìû T√©l√©phone : ${phone}`);
    lines.push(`üìç Adresse : ${addr}`);
    lines.push(`üöö Type : ${type}`);
    lines.push(`üí≥ Paiement : ${pay}`);
    lines.push(`üåç GPS : ${customerLocation ? customerLocation : "non fourni"}`);
    lines.push("");
    lines.push("üõí Produits :");
    items.forEach(it=>{
      const p = it.product;
      const lineTotal = Number(p.price||0)*it.qty;
      lines.push(`‚Ä¢ ${it.qty} √ó ${p.name} (${Number(p.price||0).toFixed(3)} dt) = ${lineTotal.toFixed(3)} dt`);
    });
    lines.push("");
    lines.push(`üí∞ Total produits : ${totalProducts.toFixed(3)} dt`);
    lines.push(`üöö Livraison : ${deliveryFee.toFixed(3)} dt`);
    lines.push(`‚úÖ Total √† payer : ${totalToPay.toFixed(3)} dt`);

    // Save order locally (admin)
    const orders = loadOrders();
    orders.push({
      id: orderId,
      dateISO: now.toISOString(),
      status: "En attente",
      customer: { name, phone, address: addr, orderType: type, paymentMethod: pay, location: customerLocation },
      items: items.map(it=>({
        code: codeOf(it.product),
        name: it.product.name,
        price: Number(it.product.price||0),
        qty: it.qty
      })),
      totalProducts: +totalProducts.toFixed(3),
      deliveryFee: +deliveryFee.toFixed(3),
      totalWithDelivery: +totalToPay.toFixed(3)
    });
    saveOrders(orders);

    clearCartAndForm();

    const url = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + encodeURIComponent(lines.join("\n"));
    window.location.href = url;
  }
  window.sendOrder = sendOrder;

  // =========================
  // ADMIN
  // =========================
  function openAdmin(){
    const code = document.getElementById("adminCode").value.trim();
    const panel = document.getElementById("adminPanel");
    if (code !== ADMIN_CODE){
      panel.style.display = "none";
      alert("Code admin incorrect.");
      return;
    }
    panel.style.display = "block";
    renderAdmin();
  }
  window.openAdmin = openAdmin;

  function renderAdmin(){
    const wrap = document.getElementById("adminOrders");
    const orders = loadOrders();
    if (orders.length === 0){
      wrap.innerHTML = "<div class='note' style='margin-top:10px'>Aucune commande enregistr√©e sur cet appareil.</div>";
      return;
    }

    orders.sort((a,b)=> new Date(b.dateISO)-new Date(a.dateISO));
    let html = "";

    orders.forEach((o, i)=>{
      const dt = new Date(o.dateISO).toLocaleString("fr-FR");
      const selectId = "st_" + i;
      html += `
        <div class="orderBox">
          <div style="font-weight:950">${o.id} ‚Äî ${o.customer.name} (${o.customer.phone})</div>
          <div class="note">${dt} ‚Ä¢ Total: <strong>${fmt(o.totalWithDelivery)} dt</strong> (livraison ${fmt(o.deliveryFee)} dt)</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span class="badge">Statut</span>
            <select id="${selectId}">
              ${ORDER_STATUSES.map(s=>`<option ${s===o.status?"selected":""} value="${s}">${s}</option>`).join("")}
            </select>
            <button class="pageBtn" type="button" onclick="saveStatus('${o.id}', document.getElementById('${selectId}').value)">Enregistrer</button>
          </div>
        </div>`;
    });

    wrap.innerHTML = html;
  }

  function saveStatus(orderId, st){
    const orders = loadOrders();
    const idx = orders.findIndex(x=>x.id===orderId);
    if (idx<0){ alert("Commande introuvable."); return; }
    orders[idx].status = st;
    saveOrders(orders);
    alert("Statut mis √† jour.");
    renderAdmin();
  }
  window.saveStatus = saveStatus;

  // =========================
  // QR MODAL
  // =========================
  const qrMini = document.getElementById("qrMini");
  const qrModal = document.getElementById("qrModal");
  qrMini.addEventListener("click", ()=> qrModal.style.display="flex");
  function closeQr(){ qrModal.style.display="none"; }
  window.closeQr = closeQr;
  qrModal.addEventListener("click", (e)=>{ if (e.target===qrModal) closeQr(); });

  // =========================
  // LOAD PRODUCTS
  // =========================
  async function loadProducts(){
    const res = await fetch(PRODUCTS_JSON_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("Fetch error: " + res.status);
    const data = await res.json();

    const items = Array.isArray(data) ? data : (data.products || []);
    const catsFromJson = Array.isArray(data.categories) ? data.categories : [];

    ALL = items.map(r=>{
      const code = String(r.code || r.CODE_ARTICLE || r.id || "").trim();
      const name = String(r.name || r.DESIGNATION || "").trim();
      let category = normCat(r.category);

      // corrections
      if (CATEGORY_OVERRIDES_BY_CODE[code]) category = CATEGORY_OVERRIDES_BY_CODE[code];
      category = smartCategoryFix(name, category);

      return {
        id: r.id,
        code,
        name,
        category,
        price: Number(r.price || r.PRIX || r.Prix || 0),
        unit: String(r.unit || "pi√®ce"),
        image: String(r.image || PLACEHOLDER)
      };
    });

    // categories: priorit√© au JSON, sinon construire depuis produits
    const set = new Set();
    if (catsFromJson.length){
      catsFromJson.forEach(c=> set.add(normCat(c)));
    } else {
      ALL.forEach(p=> set.add(p.category));
    }
    CATEGORIES = Array.from(set);

    renderAll();
  }

  // Search
  document.getElementById("search").addEventListener("input", (e)=>{
    searchTerm = e.target.value || "";
    page = 1;
    renderGrid();
    renderCategories();
  });
  document.getElementById("clearSearch").addEventListener("click", ()=>{
    document.getElementById("search").value = "";
    searchTerm = "";
    page = 1;
    renderGrid();
    renderCategories();
  });

  // Scroll cart
  document.getElementById("openCartBtn").addEventListener("click", ()=>{
    document.getElementById("cartSection").scrollIntoView({behavior:"smooth"});
  });

  loadProducts().catch(err=>{
    console.error(err);
    alert("Erreur : impossible de charger data/products.json");
  });
</script>
</body>
</html>
