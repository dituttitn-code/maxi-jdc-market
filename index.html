<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äî Commande</title>

  <style>
    :root{
      --bg0:#061014;
      --bg1:#071b20;
      --card:#0c1f25;
      --card2:#0f262d;
      --line:#163941;
      --text:#e8f1f6;
      --muted:#9db8c2;
      --accent:#26d6c8;
      --accent2:#22c55e;
      --danger:#ff6b6b;
      --warn:#fbbf24;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(38,214,200,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 15%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(900px 700px at 50% 85%, rgba(38,214,200,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{
      max-width: 1240px;
      margin: 24px auto 70px;
      padding: 0 16px;
    }

    .topbar{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: 24px;
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .toprow{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }

    .logo{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      flex: 0 0 auto;
      display:grid;
      place-items:center;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.05);
    }

    .brandTitle{
      line-height: 1.05;
    }
    .brandTitle .t{
      font-weight: 900;
      letter-spacing: .4px;
      font-size: 22px; /* plus grand */
    }
    .brandTitle .s{
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .searchBox{
      flex: 1 1 380px;
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 280px;
    }

    .searchBox input{
      width:100%;
      border-radius: 999px;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
    }
    .searchBox input::placeholder{color: rgba(232,241,246,.55)}

    .btn{
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 700;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.10) }
    .btn.green{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.16);
    }
    .btn.green:hover{ background: rgba(34,197,94,.22) }

    .pills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .pill{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(232,241,246,.92);
      font-size: 12px;
    }

    /* panier pilule */
    .cartPill{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      margin-left:auto; /* pousse √† droite */
      user-select:none;
    }
    .cartPill:hover{ background:rgba(255,255,255,.10); }
    #cartTopCount{
      margin-left:8px;
      display:inline-block;
      min-width:24px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
      text-align:center;
    }

    .noteBar{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.14);
      color: rgba(232,241,246,.85);
      background: rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size: 12px;
    }
    .noteBar .sub{ color: rgba(232,241,246,.75) }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
    }

    .panel{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .panelHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 8px;
    }
    .panelHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
    }

    .cats{ display:flex; flex-direction:column; gap:10px; }
    .catBtn{
      text-align:left;
      border-radius: 14px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .catBtn:hover{ background: rgba(255,255,255,.06) }
    .catBtn.active{
      border-color: rgba(38,214,200,.40);
      box-shadow: 0 0 0 2px rgba(38,214,200,.10) inset;
      background: rgba(38,214,200,.06);
    }
    .catMeta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .catMeta .name{ font-weight: 900; font-size: 13px; }
    .catMeta .file{ font-size: 11px; color: rgba(232,241,246,.55); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 210px; }
    .countPill{
      font-weight:900;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color: rgba(232,241,246,.92);
      flex:0 0 auto;
    }

    .productsHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .productsHeader h3{
      margin:0;
      font-size: 14px;
      font-weight: 900;
    }
    .pager{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pager .pillBtn{
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 900;
    }
    .pager .pillBtn:hover{ background: rgba(255,255,255,.08) }
    .pager .pageTxt{ color: rgba(232,241,246,.75); font-size: 12px; min-width: 62px; text-align:center; }

    .cards{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 1060px){
      .grid{ grid-template-columns: 1fr; }
      .cards{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .brand{ min-width: 200px; }
    }
    @media (max-width: 720px){
      .cards{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.09);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
      min-height: 134px;
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(300px 120px at 20% 0%, rgba(38,214,200,.12), transparent 60%),
        radial-gradient(240px 140px at 85% 40%, rgba(34,197,94,.10), transparent 65%);
      pointer-events:none;
      opacity:.9;
    }
    .card > *{ position:relative; z-index:1; }

    .rowTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .pname{
      font-weight: 950;
      font-size: 13px;
      line-height: 1.2;
      text-transform: uppercase;
    }
    .price{
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(38,214,200,.10);
      border: 1px solid rgba(38,214,200,.25);
      white-space:nowrap;
    }

    .metaLine{
      margin-top: 6px;
      display:flex;
      gap:10px;
      align-items:center;
      color: rgba(232,241,246,.74);
      font-size: 11px;
      flex-wrap:wrap;
    }

    /* petit rond couleur article */
    .dot{
      width:10px;height:10px;border-radius:99px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(38,214,200,.55);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25);
    }

    .qtyRow{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .qtyBox{
      display:flex;
      align-items:center;
      gap:8px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 6px 8px;
    }
    .qbtn{
      width: 30px; height: 30px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 900;
    }
    .qbtn:hover{ background: rgba(255,255,255,.10) }
    .qnum{
      min-width: 22px;
      text-align:center;
      font-weight: 900;
    }
    .addBtn{
      border-radius: 999px;
      padding: 10px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .addBtn:hover{ background: rgba(255,255,255,.10) }

    /* DRAWER / MODAL */
    .overlay{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      z-index: 1000;
    }
    .overlay.show{ display:block; }

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      width: min(520px, 96vw);
      height: 100%;
      background: rgba(6,16,20,.95);
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -18px 0 50px rgba(0,0,0,.55);
      transform: translateX(105%);
      transition: transform .25s ease;
      z-index: 1001;
      display:flex;
      flex-direction:column;
    }
    .drawer.show{ transform: translateX(0); }

    .drawerHead{
      padding: 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .drawerHead .h{
      font-weight: 950;
      letter-spacing:.2px;
    }
    .xbtn{
      width: 38px; height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
    }
    .xbtn:hover{ background: rgba(255,255,255,.10) }

    .drawerBody{
      padding: 14px;
      overflow:auto;
      flex:1;
    }

    .cartList{ display:flex; flex-direction:column; gap:10px; }
    .cartItem{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px;
    }
    .cartItemTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .cartItemTop .n{ font-weight: 900; font-size: 13px; }
    .cartItemTop .p{ font-weight: 950; color: rgba(232,241,246,.92); white-space:nowrap; }
    .cartItemSub{
      margin-top: 6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: rgba(232,241,246,.72);
      font-size: 12px;
    }

    .summary{
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .sumRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      font-size: 13px;
    }
    .sumRow .k{ color: rgba(232,241,246,.75) }
    .sumRow .v{ font-weight: 950 }
    .minMsg{
      margin-top: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,107,107,.12);
      color: rgba(255,230,230,.96);
      display:none;
      font-weight: 900;
    }
    .minMsg.show{ display:block; }

    .form{
      margin-top: 12px;
      display:grid;
      gap:10px;
    }
    .form label{
      font-size: 12px;
      color: rgba(232,241,246,.75);
    }
    .form input, .form textarea{
      width:100%;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    .form textarea{ min-height: 76px; resize: vertical; }

    .drawerFoot{
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btnDanger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.16);
    }
    .btnDanger:hover{ background: rgba(255,107,107,.22) }

    /* ADMIN */
    .adminBar{
      margin-top: 14px;
      display:none;
    }
    .adminBar.show{ display:block; }
    .adminGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .adminGrid{ grid-template-columns: 1fr; }
    }
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .table th,.table td{
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 8px 6px;
      text-align:left;
      vertical-align:top;
      color: rgba(232,241,246,.86);
    }
    .table th{
      color: rgba(232,241,246,.65);
      font-weight: 900;
    }
    .tag{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight: 900;
      font-size: 11px;
    }
    .hint{
      margin-top: 10px;
      color: rgba(232,241,246,.55);
      font-size: 11px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="toprow">
        <div class="brand">
          <div class="logo">
            <!-- mets ton logo dans le repo (ex: logo-maxi-jdc-market.jpg) -->
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC" onerror="this.style.display='none'">
          </div>
          <div class="brandTitle">
            <div class="t">MAXI JDC MARKET</div>
            <div class="s">Des prix mini ‚Äî Un MAXI choix</div>
          </div>
        </div>

        <div class="searchBox">
          <input id="q" type="text" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn green" id="globalBtn">Recherche globale</button>
        </div>
      </div>

      <div class="pills">
        <div class="pill">üìç Jardins de Carthage , derri√®re mosqu√©e Essalem</div>
        <div class="pill">üïí 7h ‚Äì 1h</div>
        <div class="pill">üí¨ WhatsApp: <b id="waTxt">00216 25 600 978</b></div>

        <div class="pill cartPill" id="cartTopBtn" title="Ouvrir le panier">
          üõí Panier <span id="cartTopCount">0</span>
        </div>
      </div>

      <div class="noteBar">
        ‚úÖ Donn√©es charg√©es depuis <b>data/*.csv</b> ‚Äî une cat√©gorie = un fichier CSV.
        <span class="sub">Conditions : minimum livraison <b>15 dt</b> ¬∑ Livraison gratuite si total ‚â• <b>30 dt</b> ¬∑ Sinon frais <b>5 dt</b> ¬∑ Retrait magasin possible</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="panelHeader">
          <h3>Cat√©gories</h3>
          <div class="sub" id="status">Chargement‚Ä¶</div>
        </div>
        <div class="cats" id="cats"></div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="productsHeader">
          <div>
            <h3 id="activeLabel">Produits</h3>
            <div class="sub" id="activeFile">S√©lectionne une cat√©gorie.</div>
          </div>

          <div class="pager">
            <button class="pillBtn" id="prevBtn">‚Äπ</button>
            <div class="pageTxt" id="pageTxt">Page 1/1</div>
            <button class="pillBtn" id="nextBtn">‚Ä∫</button>
          </div>

          <div class="sub" id="countTxt">0 article(s)</div>
        </div>

        <div class="cards" id="cards"></div>

        <div class="hint">Admin : Ctrl + Shift + A (ou ajoute <b>?admin=1</b> dans l‚ÄôURL)</div>

        <!-- ADMIN PANEL -->
        <div class="adminBar" id="adminBar">
          <div class="panelHeader">
            <h3>Admin ¬∑ Historique commandes & clients</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn" id="exportBtn">Exporter JSON</button>
              <button class="btn btnDanger" id="clearOrdersBtn">Vider historique</button>
            </div>
          </div>

          <div class="adminGrid">
            <div class="panel" style="box-shadow:none;background:rgba(255,255,255,.02)">
              <div class="panelHeader">
                <h3>Commandes</h3>
                <div class="sub"><span class="tag" id="ordersCount">0</span></div>
              </div>
              <table class="table" id="ordersTable"></table>
            </div>

            <div class="panel" style="box-shadow:none;background:rgba(255,255,255,.02)">
              <div class="panelHeader">
                <h3>Clients</h3>
                <div class="sub"><span class="tag" id="clientsCount">0</span></div>
              </div>
              <table class="table" id="clientsTable"></table>

              <div style="margin-top:12px">
                <div class="panelHeader" style="margin-bottom:6px">
                  <h3>Admin ¬∑ Modifier un prix (override)</h3>
                  <div class="sub">par code produit</div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <input id="ovCode" placeholder="Code" style="flex:1;min-width:120px;border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--text)">
                  <input id="ovPrice" placeholder="Prix (dt)" style="width:140px;border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--text)">
                  <button class="btn green" id="ovSave">Enregistrer</button>
                  <button class="btn" id="ovClear">Effacer override</button>
                </div>
                <div class="sub" style="margin-top:8px">Astuce : apr√®s override, recharge la cat√©gorie (clic cat√©gorie) pour voir le prix.</div>
              </div>

            </div>
          </div>
        </div>
        <!-- /ADMIN PANEL -->
      </div>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div class="overlay" id="overlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div class="h">üõí Panier</div>
      <button class="xbtn" id="closeDrawer">‚úï</button>
    </div>

    <div class="drawerBody">
      <div class="cartList" id="cartList"></div>

      <div class="summary">
        <div class="sumRow"><div class="k">Sous-total</div><div class="v" id="subTotal">0,00 dt</div></div>
        <div class="sumRow"><div class="k">Frais livraison</div><div class="v" id="shipFee">‚Äî</div></div>
        <div class="sumRow"><div class="k">Total</div><div class="v" id="cartTotal">0,00 dt</div></div>
        <div class="minMsg" id="minMsg">Minimum commande 15 dt</div>
      </div>

      <div class="form">
        <div>
          <label>Nom</label>
          <input id="cName" placeholder="Nom du client" />
        </div>
        <div>
          <label>T√©l√©phone</label>
          <input id="cTel" placeholder="Ex: 25 600 978" />
        </div>
        <div>
          <label>Adresse</label>
          <input id="cAddr" placeholder="Adresse de livraison" />
        </div>
        <div>
          <label>Note (facultatif)</label>
          <textarea id="cNote" placeholder="Ex: interphone, √©tage, rep√®re‚Ä¶"></textarea>
        </div>
      </div>
    </div>

    <div class="drawerFoot">
      <button class="btn btnDanger" id="clearCartBtn">Vider panier</button>
      <button class="btn green" id="sendWaBtn">Envoyer WhatsApp</button>
    </div>
  </div>

  <script>
    /**********************
     * CONFIG
     **********************/
    const WHATSAPP_NUMBER = "0021625600978"; // sans espaces
    const MIN_ORDER = 15;
    const FREE_SHIPPING = 30;
    const SHIPPING_FEE = 5;
    const PAGE_SIZE = 9;

    /**********************
     * CATEGORIES (IMPORTANT: data/... sans / au d√©but)
     **********************/
    const CATEGORIES = [
      { key:"fruits_legumes", label:"Fruits & L√©gumes", file:"data/fruits_legumes.csv" },
      { key:"lait_oeufs_produits_frais", label:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
      { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
      { key:"boulangerie_patisserie", label:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
      { key:"epicerie_salee", label:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
      { key:"epicerie_sucree", label:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
      { key:"pates", label:"P√¢tes", file:"data/pates.csv" },
      { key:"conserves", label:"Conserves", file:"data/conserves.csv" },
    ];

    /**********************
     * STATE
     **********************/
    const state = {
      activeCat: CATEGORIES[0].key,
      global: false,
      q: "",
      page: 1,
      dataByCat: new Map(),
      cart: {}, // key -> {code,name,price,cat,qty}
      priceOverrides: loadJSON("maxi_price_overrides_v1", {}),
      admin: false
    };

    /**********************
     * HELPERS
     **********************/
    const $ = (id)=>document.getElementById(id);

    function fmtDT(n){
      const x = Number(n||0);
      return x.toFixed(2).replace(".", ",") + " dt";
    }

    function hashHue(str){
      let h=0;
      for(let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
      return h % 360;
    }

    function dotColor(catKey, code){
      const hue = (hashHue(catKey + ":" + code) + 140) % 360;
      return `hsl(${hue} 70% 55% / .9)`;
    }

    function loadJSON(k, fallback){
      try{ return JSON.parse(localStorage.getItem(k) || ""); }catch(e){ return fallback; }
    }
    function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

    function saveCart(){
      saveJSON("maxi_cart_v1", state.cart);
    }
    function loadCart(){
      state.cart = loadJSON("maxi_cart_v1", {});
    }

    /**********************
     * SHIPPING + TOTALS
     **********************/
    function cartCount(){
      return Object.values(state.cart).reduce((a,it)=>a+(it.qty||0),0);
    }
    function cartSubTotal(){
      return Object.values(state.cart).reduce((a,it)=> a + (Number(it.price)||0) * (it.qty||0), 0);
    }
    function shippingFee(){
      const total = cartSubTotal();
      if (total >= FREE_SHIPPING) return 0;
      if (total >= MIN_ORDER) return SHIPPING_FEE;
      return null; // non valide
    }
    function grandTotal(){
      const fee = shippingFee();
      if (fee === null) return null;
      return cartSubTotal() + fee;
    }

    /**********************
     * CSV PARSER (simple)
     * format attendu: code \t ou ; ou , puis nom puis prix (dt)
     **********************/
    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = [];
      for(const line of lines){
        // detect separator
        const sep = line.includes("\t") ? "\t" : (line.includes(";") ? ";" : ",");
        const parts = line.split(sep).map(s=>s.trim());
        if(parts.length < 2) continue;

        // si format "CODE  NOM  PRIX"
        let code = parts[0];
        let name = parts[1] || "";
        let price = parts[2] ?? "";

        // si price vide, essayer fin de ligne
        if(price === "" && parts.length >= 3) price = parts[parts.length-1];

        // normaliser prix
        price = String(price).replace("dt","").replace(",",".").trim();
        const p = Number(price);
        const priceNum = Number.isFinite(p) ? p : 0;

        items.push({
          code: String(code||"").trim(),
          name: String(name||"").trim(),
          price: priceNum
        });
      }
      return items;
    }

    /**********************
     * LOAD ALL CATEGORIES
     **********************/
    async function loadAll(){
      $("status").textContent = "Chargement‚Ä¶";
      for(const c of CATEGORIES){
        try{
          const r = await fetch(c.file, { cache:"no-store" });
          if(!r.ok) throw new Error("HTTP " + r.status);
          const text = await r.text();
          const items = parseCSV(text).map(it=>{
            // appliquer override prix si exist
            const ov = state.priceOverrides[it.code];
            if(ov !== undefined && ov !== null && ov !== ""){
              const p = Number(String(ov).replace(",","."));
              if(Number.isFinite(p)) it.price = p;
            }
            return {...it, catKey:c.key, catLabel:c.label};
          });
          state.dataByCat.set(c.key, items);
        }catch(e){
          console.warn("Erreur CSV", c.file, e);
          state.dataByCat.set(c.key, []);
        }
      }
      $("status").textContent = "OK";
      buildCats();
      render();
    }

    /**********************
     * UI BUILD
     **********************/
    function buildCats(){
      const box = $("cats");
      box.innerHTML = "";
      for(const c of CATEGORIES){
        const items = state.dataByCat.get(c.key) || [];
        const btn = document.createElement("button");
        btn.className = "catBtn" + (state.activeCat===c.key ? " active":"");
        btn.onclick = ()=>{
          state.activeCat = c.key;
          state.global = false;
          state.page = 1;
          render();
          buildCats();
        };

        const meta = document.createElement("div");
        meta.className = "catMeta";
        const n = document.createElement("div");
        n.className = "name";
        n.textContent = c.label;
        const f = document.createElement("div");
        f.className = "file";
        f.textContent = "CSV: " + c.file.replace("data/","");
        meta.appendChild(n);
        meta.appendChild(f);

        const count = document.createElement("div");
        count.className = "countPill";
        count.textContent = items.length + " article(s)";

        btn.appendChild(meta);
        btn.appendChild(count);
        box.appendChild(btn);
      }
    }

    function getActiveItems(){
      let items = [];
      if(state.global){
        for(const c of CATEGORIES){
          items = items.concat(state.dataByCat.get(c.key) || []);
        }
      }else{
        items = (state.dataByCat.get(state.activeCat) || []);
      }

      const q = (state.q||"").trim().toLowerCase();
      if(q){
        items = items.filter(it=>{
          const hay = (it.name+" "+it.code+" "+it.catLabel).toLowerCase();
          return hay.includes(q);
        });
      }

      return items;
    }

    function render(){
      $("waTxt").textContent = "00216 25 600 978";

      const activeCatObj = CATEGORIES.find(x=>x.key===state.activeCat) || CATEGORIES[0];
      $("activeLabel").textContent = state.global ? "Recherche globale" : activeCatObj.label;
      $("activeFile").textContent = state.global ? "Toutes les cat√©gories" : ("Source: " + activeCatObj.file);

      const items = getActiveItems();
      $("countTxt").textContent = items.length + " article(s)";

      const totalPages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
      state.page = Math.min(state.page, totalPages);
      $("pageTxt").textContent = `Page ${state.page}/${totalPages}`;

      const start = (state.page-1)*PAGE_SIZE;
      const pageItems = items.slice(start, start+PAGE_SIZE);

      const box = $("cards");
      box.innerHTML = "";

      for(const it of pageItems){
        const card = document.createElement("div");
        card.className = "card";

        const top = document.createElement("div");
        top.className = "rowTop";

        const left = document.createElement("div");
        const pn = document.createElement("div");
        pn.className = "pname";
        pn.textContent = it.name || "‚Äî";

        const meta = document.createElement("div");
        meta.className = "metaLine";

        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = dotColor(it.catKey, it.code);

        const code = document.createElement("span");
        code.textContent = `Code: ${it.code || "‚Äî"}`;

        const cat = document.createElement("span");
        cat.textContent = `¬∑ ${it.catLabel}`;

        meta.appendChild(dot);
        meta.appendChild(code);
        meta.appendChild(cat);

        left.appendChild(pn);
        left.appendChild(meta);

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = fmtDT(it.price);

        top.appendChild(left);
        top.appendChild(price);

        const qtyRow = document.createElement("div");
        qtyRow.className = "qtyRow";

        const qtyBox = document.createElement("div");
        qtyBox.className = "qtyBox";

        const key = it.code || (it.catKey + ":" + it.name);
        const currentQty = (state.cart[key]?.qty)||0;

        const minus = document.createElement("button");
        minus.className = "qbtn";
        minus.textContent = "‚àí";
        minus.onclick = ()=> changeQty(it, -1);

        const qnum = document.createElement("div");
        qnum.className = "qnum";
        qnum.textContent = currentQty;

        const plus = document.createElement("button");
        plus.className = "qbtn";
        plus.textContent = "+";
        plus.onclick = ()=> changeQty(it, +1);

        qtyBox.appendChild(minus);
        qtyBox.appendChild(qnum);
        qtyBox.appendChild(plus);

        const add = document.createElement("button");
        add.className = "addBtn";
        add.innerHTML = "üõí <span>Ajouter</span>";
        add.onclick = ()=> changeQty(it, +1);

        qtyRow.appendChild(qtyBox);
        qtyRow.appendChild(add);

        card.appendChild(top);
        card.appendChild(qtyRow);
        box.appendChild(card);
      }

      refreshCartUI();
    }

    function changeQty(it, delta){
      const key = it.code || (it.catKey + ":" + it.name);
      const cur = state.cart[key]?.qty || 0;
      const next = Math.max(0, cur + delta);

      if(next === 0){
        delete state.cart[key];
      }else{
        state.cart[key] = {
          key,
          code: it.code,
          name: it.name,
          price: it.price,
          cat: it.catLabel,
          qty: next
        };
      }
      saveCart();
      render(); // pour mettre √† jour les quantit√©s sur les cartes
    }

    /**********************
     * CART UI
     **********************/
    function openCart(){
      $("overlay").classList.add("show");
      $("drawer").classList.add("show");
      refreshCartUI();
    }
    function closeCart(){
      $("overlay").classList.remove("show");
      $("drawer").classList.remove("show");
    }

    function refreshCartUI(){
      $("cartTopCount").textContent = cartCount();

      const list = $("cartList");
      list.innerHTML = "";

      const keys = Object.keys(state.cart);
      if(!keys.length){
        const e = document.createElement("div");
        e.className = "sub";
        e.style.padding = "8px";
        e.textContent = "Panier vide. Ajoute des articles üôÇ";
        list.appendChild(e);
      }else{
        for(const k of keys){
          const it = state.cart[k];
          const row = document.createElement("div");
          row.className = "cartItem";

          const top = document.createElement("div");
          top.className = "cartItemTop";

          const n = document.createElement("div");
          n.className = "n";
          n.textContent = it.name;

          const p = document.createElement("div");
          p.className = "p";
          p.textContent = fmtDT(it.price);

          top.appendChild(n);
          top.appendChild(p);

          const sub = document.createElement("div");
          sub.className = "cartItemSub";

          const left = document.createElement("div");
          left.textContent = `x${it.qty} ¬∑ ${it.code || ""} ¬∑ ${it.cat || ""}`;

          const qtyBox = document.createElement("div");
          qtyBox.className = "qtyBox";
          qtyBox.style.padding = "4px 6px";

          const minus = document.createElement("button");
          minus.className = "qbtn";
          minus.textContent = "‚àí";
          minus.onclick = ()=> changeQty({code:it.key, name:it.name, price:it.price, catLabel:it.cat, catKey:""}, -1);

          const qnum = document.createElement("div");
          qnum.className = "qnum";
          qnum.textContent = it.qty;

          const plus = document.createElement("button");
          plus.className = "qbtn";
          plus.textContent = "+";
          plus.onclick = ()=> changeQty({code:it.key, name:it.name, price:it.price, catLabel:it.cat, catKey:""}, +1);

          qtyBox.appendChild(minus);
          qtyBox.appendChild(qnum);
          qtyBox.appendChild(plus);

          sub.appendChild(left);
          sub.appendChild(qtyBox);

          row.appendChild(top);
          row.appendChild(sub);
          list.appendChild(row);
        }
      }

      // totals
      $("subTotal").textContent = fmtDT(cartSubTotal());

      const fee = shippingFee();
      if(fee === null){
        $("shipFee").textContent = "‚Äî";
        $("cartTotal").textContent = "Minimum commande 15 dt";
        $("cartTotal").style.color = "var(--danger)";
        $("minMsg").classList.add("show");
      }else{
        $("shipFee").textContent = fmtDT(fee);
        $("cartTotal").textContent = fmtDT(grandTotal());
        $("cartTotal").style.color = "";
        $("minMsg").classList.remove("show");
      }

      // admin tables
      if(state.admin) renderAdmin();
    }

    /**********************
     * WHATSAPP + SAVE ORDER
     **********************/
    function buildWhatsAppMessage(){
      const keys = Object.keys(state.cart);
      const name = $("cName").value.trim();
      const tel = $("cTel").value.trim();
      const addr = $("cAddr").value.trim();
      const note = $("cNote").value.trim();

      let msg = "üõí *Commande MAXI JDC MARKET*\\n\\n";
      msg += `üë§ Nom: ${name || "‚Äî"}\\n`;
      msg += `üìû Tel: ${tel || "‚Äî"}\\n`;
      msg += `üìç Adresse: ${addr || "‚Äî"}\\n`;
      if(note) msg += `üìù Note: ${note}\\n`;
      msg += "\\n*Articles:*\\n";

      for(const k of keys){
        const it = state.cart[k];
        const lineTotal = (Number(it.price)||0) * (it.qty||0);
        msg += `‚Ä¢ x${it.qty} ${it.name}`;
        if(it.code) msg += ` (Code: ${it.code})`;
        msg += ` ‚Äî ${fmtDT(lineTotal)}\\n`;
      }

      const sub = cartSubTotal();
      const fee = shippingFee();
      const total = grandTotal();

      msg += `\\nüßæ Sous-total: ${fmtDT(sub)}\\n`;
      if(fee === null){
        msg += `‚ö†Ô∏è Minimum commande ${MIN_ORDER} dt\\n`;
      }else{
        msg += `üöö Frais livraison: ${fmtDT(fee)}\\n`;
        msg += `‚úÖ *Total: ${fmtDT(total)}*\\n`;
      }

      return msg;
    }

    function saveOrder(){
      const fee = shippingFee();
      if(fee === null) return false;

      const order = {
        id: Date.now(),
        ts: new Date().toISOString(),
        customer: {
          name: $("cName").value.trim(),
          tel: $("cTel").value.trim(),
          addr: $("cAddr").value.trim(),
          note: $("cNote").value.trim(),
        },
        items: Object.values(state.cart).map(it=>({
          code: it.code || "",
          name: it.name || "",
          qty: it.qty || 0,
          price: Number(it.price)||0,
          cat: it.cat || ""
        })),
        subTotal: cartSubTotal(),
        shipFee: fee,
        total: grandTotal()
      };

      const orders = loadJSON("maxi_orders_v1", []);
      orders.unshift(order);
      saveJSON("maxi_orders_v1", orders);
      return true;
    }

    /**********************
     * ADMIN
     **********************/
    function enableAdmin(){
      state.admin = true;
      $("adminBar").classList.add("show");
      renderAdmin();
    }

    function renderAdmin(){
      const orders = loadJSON("maxi_orders_v1", []);
      $("ordersCount").textContent = orders.length;

      // Orders table
      const ot = $("ordersTable");
      ot.innerHTML = `
        <tr>
          <th>Date</th><th>Client</th><th>Total</th><th>Articles</th>
        </tr>
      `;

      for(const o of orders.slice(0, 30)){
        const dt = new Date(o.id).toLocaleString();
        const client = (o.customer?.name || "‚Äî") + "<br><span style='color:rgba(232,241,246,.65)'>" + (o.customer?.tel || "‚Äî") + "</span>";
        const itemsCount = (o.items||[]).reduce((a,x)=>a+(x.qty||0),0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dt}</td>
          <td>${client}</td>
          <td><b>${fmtDT(o.total)}</b></td>
          <td>${itemsCount}</td>
        `;
        ot.appendChild(tr);
      }

      // Clients table (aggregate)
      const byTel = new Map();
      for(const o of orders){
        const tel = (o.customer?.tel || "").trim() || "‚Äî";
        const name = (o.customer?.name || "").trim() || "‚Äî";
        const key = tel + "||" + name;
        if(!byTel.has(key)) byTel.set(key, {tel, name, orders:0, total:0});
        const c = byTel.get(key);
        c.orders += 1;
        c.total += Number(o.total)||0;
      }
      const clients = Array.from(byTel.values()).sort((a,b)=>b.total-a.total);
      $("clientsCount").textContent = clients.length;

      const ct = $("clientsTable");
      ct.innerHTML = `
        <tr>
          <th>Client</th><th>Commandes</th><th>Total</th>
        </tr>
      `;
      for(const c of clients.slice(0, 30)){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${c.name}</b><br><span style="color:rgba(232,241,246,.65)">${c.tel}</span></td>
          <td>${c.orders}</td>
          <td><b>${fmtDT(c.total)}</b></td>
        `;
        ct.appendChild(tr);
      }
    }

    /**********************
     * EVENTS
     **********************/
    $("prevBtn").onclick = ()=>{
      state.page = Math.max(1, state.page-1);
      render();
    };
    $("nextBtn").onclick = ()=>{
      const items = getActiveItems();
      const totalPages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
      state.page = Math.min(totalPages, state.page+1);
      render();
    };

    $("q").addEventListener("input", (e)=>{
      state.q = e.target.value;
      state.page = 1;
      render();
    });

    $("clearBtn").onclick = ()=>{
      $("q").value = "";
      state.q = "";
      state.page = 1;
      render();
    };

    $("globalBtn").onclick = ()=>{
      state.global = !state.global;
      state.page = 1;
      render();
    };

    $("cartTopBtn").onclick = openCart;
    $("overlay").onclick = closeCart;
    $("closeDrawer").onclick = closeCart;

    $("clearCartBtn").onclick = ()=>{
      state.cart = {};
      saveCart();
      refreshCartUI();
      render();
    };

    $("sendWaBtn").onclick = ()=>{
      if(!Object.keys(state.cart).length){
        alert("Panier vide");
        return;
      }
      const fee = shippingFee();
      if(fee === null){
        alert("Minimum commande 15 dt");
        return;
      }

      // enregistrer commande
      saveOrder();

      const msg = buildWhatsAppMessage();
      const url = `https://wa.me/${WHATSAPP_NUMBER.replace(/\\D/g,"")}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    };

    // Admin shortcuts
    document.addEventListener("keydown", (e)=>{
      if(e.ctrlKey && e.shiftKey && (e.key==="A" || e.key==="a")){
        enableAdmin();
      }
    });

    $("exportBtn").onclick = ()=>{
      const orders = loadJSON("maxi_orders_v1", []);
      const blob = new Blob([JSON.stringify(orders, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "maxi_orders.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };

    $("clearOrdersBtn").onclick = ()=>{
      if(confirm("Vider l'historique des commandes ?")){
        saveJSON("maxi_orders_v1", []);
        renderAdmin();
      }
    };

    $("ovSave").onclick = ()=>{
      const code = $("ovCode").value.trim();
      const price = $("ovPrice").value.trim().replace(",",".");
      if(!code){ alert("Code manquant"); return; }
      const p = Number(price);
      if(!Number.isFinite(p)){ alert("Prix invalide"); return; }
      state.priceOverrides[code] = p;
      saveJSON("maxi_price_overrides_v1", state.priceOverrides);
      alert("Override enregistr√© ‚úÖ");
    };

    $("ovClear").onclick = ()=>{
      const code = $("ovCode").value.trim();
      if(!code){ alert("Code manquant"); return; }
      delete state.priceOverrides[code];
      saveJSON("maxi_price_overrides_v1", state.priceOverrides);
      alert("Override supprim√© ‚úÖ");
    };

    /**********************
     * INIT
     **********************/
    (function init(){
      loadCart();

      // admin via URL
      const params = new URLSearchParams(location.search);
      if(params.get("admin")==="1") enableAdmin();

      // init cart badge
      $("cartTopCount").textContent = cartCount();

      // init
      loadAll();
    })();
  </script>
</body>
</html>
