<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äî Commande</title>
  <style>
    :root{--bg:#1f1f1f;--card:#2a2a2a;--txt:#f2f2f2;--muted:#bdbdbd;--green:#35d04f;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#111;color:var(--txt);}
    header{padding:18px 16px;background:#181818;border-bottom:1px solid #2b2b2b;}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:50%;background:#333;display:grid;place-items:center;font-weight:800}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .info{color:var(--muted);font-size:13px}
    .bar{margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input{background:#101010;border:1px solid #2b2b2b;color:var(--txt);padding:10px 12px;border-radius:10px;min-width:280px;outline:none}
    button{background:#232323;border:1px solid #2b2b2b;color:var(--txt);padding:10px 12px;border-radius:999px;cursor:pointer}
    button.active{border-color:var(--green);box-shadow:0 0 0 2px rgba(53,208,79,.15) inset}
    .actions{display:flex;gap:8px;align-items:center}
    .pill{background:#0f0f0f;border:1px solid #2b2b2b;border-radius:999px;padding:8px 10px;color:var(--muted);font-size:12px}
    main{padding:16px}
    .cats{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
    .card{background:#141414;border:1px solid #2b2b2b;border-radius:16px;overflow:hidden}
    .img{height:130px;background:#0c0c0c;display:grid;place-items:center}
    .img img{max-width:100%;max-height:100%;object-fit:contain}
    .cbody{padding:10px 10px 12px}
    .name{font-weight:700;font-size:13px;line-height:1.2;min-height:32px}
    .meta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px}
    .price{margin-top:10px;font-size:18px;font-weight:800}
    .cat{color:var(--muted);font-size:12px;margin-top:4px}
    .row{display:flex;gap:8px;align-items:center;margin-top:10px}
    .qty{display:flex;gap:8px;align-items:center;background:#0f0f0f;border:1px solid #2b2b2b;border-radius:999px;padding:6px 10px}
    .qty b{min-width:18px;text-align:center}
    .add{flex:1;background:var(--green);border:none;color:#0b1a0f;font-weight:800}
    .small{font-size:12px;color:var(--muted)}
    .footerbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:12px;color:var(--muted);font-size:12px}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">M</div>
      <div>
        <div style="font-weight:900">MAXI JDC MARKET</div>
        <div class="sub">Des prix mini ‚Äî Un MAXI choix</div>
      </div>
    </div>
    <div class="info">üìç Jardins de Carthage, derri√®re mosqu√©e Essalem ‚Ä¢ üïí 7h ‚Äì 1h ‚Ä¢ üí¨ WhatsApp: 00216 25 600 978</div>
  </div>

  <div class="bar">
    <input id="q" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
    <div class="actions">
      <button id="btnClear">Effacer</button>
      <button id="btnAll" class="active">Recherche globale</button>
      <span class="pill" id="count">0 article(s)</span>
    </div>
  </div>

  <div class="cats" id="cats"></div>

  <div class="footerbar">
    <div>Conditions: minimum livraison 15 dt ‚Ä¢ Livraison gratuite si total ‚â• 30 dt ‚Ä¢ Sinon frais 5 dt ‚Ä¢ Retrait magasin possible</div>
    <div id="pageInfo">Page 1/1</div>
  </div>
</header>

<main>
  <div class="grid" id="grid"></div>
</main>

<script>
/** ===================== CONFIG ===================== **/
const CSV_FILES = [
  // fichier -> cat√©gorie PRO affich√©e
  { file: "Fruits et legumes.CSV",          cat: "Fruits & L√©gumes" },
  { file: "Lait et D√©riv√©s.CSV",            cat: "Produits laitiers & ≈íufs" },
  { file: "Fromage.CSV",                    cat: "Fromage & Cr√®merie" },
  { file: "Salami.CSV",                     cat: "Charcuterie" },
  { file: "Pates et Conserves.CSV",         cat: "√âpicerie sal√©e" },
  { file: "Chocolas et Biscuits.CSV",       cat: "√âpicerie sucr√©e" },
  { file: "Chips.CSV",                      cat: "Snacking sal√©" },
  { file: "Caf√©.CSV",                       cat: "Caf√© & Capsules" },
  { file: "Jus et Boissons.CSV",            cat: "Boissons & Jus" },
  { file: "Eaux.CSV",                       cat: "Eaux" },
  { file: "Surgele.CSV",                    cat: "Surgel√©s" },
  { file: "Hygiene et Soins.CSV",           cat: "Hygi√®ne & Soins" },
  { file: "Hygiene et entretien.CSV",       cat: "Hygi√®ne & Entretien" },
  { file: "B√©b√© et Maman.CSV",              cat: "B√©b√© & Maman" },
  { file: "Animaux.CSV",                    cat: "Produits animaux" },
  { file: "Cuisine du monde.CSV",           cat: "Cuisine du monde" },
  { file: "Fruits Secs.CSV",                cat: "Fruits secs & Graines" },
  { file: "Vipa.CSV",                       cat: "√âpicerie healthy" },
];

const DATA_DIR = "data/";                 // ton dossier data
const IMG_DIR  = "images/products/";      // ton dossier images/products
const PLACEHOLDER = "images/products/placeholder.jpg"; // mets un placeholder si tu veux

const PAGE_SIZE = 24;

/** ===================== STATE ===================== **/
let ALL = [];              // tous les produits (fusionn√©s mais cat√©gorie conserv√©e)
let ACTIVE_CAT = "Toutes cat√©gories";
let page = 1;
let query = "";

/** ===================== HELPERS ===================== **/
function norm(s){
  return (s ?? "").toString().trim();
}
function toPrice(s){
  // g√®re "10,800" -> 10.8  et "10.8"
  const x = norm(s).replace(/\s/g,"").replace(",",".");
  const n = parseFloat(x);
  return Number.isFinite(n) ? n : 0;
}
function detectSep(line){
  const sc = (line.match(/;/g)||[]).length;
  const cc = (line.match(/,/g)||[]).length;
  return sc >= cc ? ";" : ",";
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length);
  if(!lines.length) return [];
  const sep = detectSep(lines[0]);

  const headers = lines[0].split(sep).map(h => norm(h).toUpperCase());
  const idx = (nameList) => {
    for(const nm of nameList){
      const i = headers.indexOf(nm);
      if(i !== -1) return i;
    }
    return -1;
  };

  const iCode = idx(["CODE_ARTICL","CODE_ARTI","CODE","CODE_ARTICLE"]);
  const iName = idx(["DESIGNATION","LIBELLE","NOM","NAME"]);
  const iPrice= idx(["PV_TTC","PV_TTO","PRIX","PRICE"]);

  const out = [];
  for(let k=1;k<lines.length;k++){
    const cols = lines[k].split(sep);
    const code = iCode>=0 ? norm(cols[iCode]) : "";
    const name = iName>=0 ? norm(cols[iName]) : "";
    const price = iPrice>=0 ? toPrice(cols[iPrice]) : 0;
    if(!name) continue;

    out.push({ code, name, price });
  }
  return out;
}
function imgFor(code){
  if(!code) return PLACEHOLDER;
  return IMG_DIR + encodeURIComponent(code) + ".jpg";
}

/** ===================== UI BUILD ===================== **/
const elCats = document.getElementById("cats");
const elGrid = document.getElementById("grid");
const elCount= document.getElementById("count");
const elPage = document.getElementById("pageInfo");
const elQ    = document.getElementById("q");

function buildCatButtons(){
  const cats = ["Toutes cat√©gories", ...Array.from(new Set(ALL.map(p=>p.category)))];
  elCats.innerHTML = "";
  for(const c of cats){
    const b = document.createElement("button");
    b.textContent = c;
    b.className = (c===ACTIVE_CAT) ? "active" : "";
    b.onclick = () => { ACTIVE_CAT=c; page=1; render(); };
    elCats.appendChild(b);
  }
}

function filtered(){
  const q = query.toLowerCase();
  return ALL.filter(p=>{
    const okCat = (ACTIVE_CAT==="Toutes cat√©gories") || (p.category===ACTIVE_CAT);
    if(!okCat) return false;
    if(!q) return true;
    return (p.name.toLowerCase().includes(q) ||
            p.category.toLowerCase().includes(q) ||
            (p.code||"").toLowerCase().includes(q));
  });
}

function render(){
  const list = filtered();
  elCount.textContent = ${list.length} article(s);

  const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
  page = Math.min(page, totalPages);
  elPage.textContent = Page ${page}/${totalPages};

  const start = (page-1)*PAGE_SIZE;
  const slice = list.slice(start, start + PAGE_SIZE);

  // rendu stable (√©vite clignote)
  const frag = document.createDocumentFragment();
  for(const p of slice){
    const card = document.createElement("div");
    card.className = "card";

    const imgWrap = document.createElement("div");
    imgWrap.className = "img";
    const img = document.createElement("img");
    img.loading = "lazy";
    img.src = imgFor(p.code);
    img.onerror = () => { img.src = PLACEHOLDER; };
    imgWrap.appendChild(img);

    const body = document.createElement("div");
    body.className = "cbody";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = p.name;

    const cat = document.createElement("div");
    cat.className = "cat";
    cat.textContent = ${p.category}${p.code ? " ‚Ä¢ " + p.code : ""};

    const price = document.createElement("div");
    price.className = "price";
    price.textContent = ${p.price.toFixed(3)} dt;

    const row = document.createElement("div");
    row.className = "row";

    const qty = document.createElement("div");
    qty.className = "qty";
    const minus = document.createElement("button"); minus.textContent = "‚àí";
    const plus  = document.createElement("button"); plus.textContent = "+";
    const num   = document.createElement("b"); num.textContent = "0";
    minus.onclick = ()=>{ let v=+num.textContent; v=Math.max(0,v-1); num.textContent=v; };
    plus.onclick  = ()=>{ let v=+num.textContent; v=v+1; num.textContent=v; };
    qty.append(minus,num,plus);

    const add = document.createElement("button");
    add.className = "add";
    add.textContent = "Ajouter";
    add.onclick = ()=>{ alert(Ajout√©: ${p.name} x ${num.textContent}); };

    row.append(qty, add);

    body.append(name, cat, price, row);
    card.append(imgWrap, body);
    frag.appendChild(card);
  }

  elGrid.innerHTML = "";
  elGrid.appendChild(frag);
}

/** ===================== LOAD ALL CSV ===================== **/
async function loadAll(){
  const products = [];
  for(const it of CSV_FILES){
    const url = DATA_DIR + encodeURIComponent(it.file);
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(res.status);
      const txt = await res.text();
      const rows = parseCSV(txt);

      for(const r of rows){
        products.push({
          id: ${it.cat}-${r.code}-${r.name}.slice(0,200),
          code: r.code,
          name: r.name,
          category: it.cat,
          price: r.price
        });
      }
    }catch(e){
      console.warn("CSV non charg√©:", it.file, e);
    }
  }

  ALL = products;
  buildCatButtons();
  render();
}

document.getElementById("btnClear").onclick = ()=>{
  elQ.value = "";
  query = "";
  page = 1;
  render();
};
document.getElementById("btnAll").onclick = ()=>{
  ACTIVE_CAT = "Toutes cat√©gories";
  page = 1;
  buildCatButtons();
  render();
};

// recherche (debounce)
let t=null;
elQ.addEventListener("input", ()=>{
  clearTimeout(t);
  t = setTimeout(()=>{
    query = elQ.value.trim();
    page = 1;
    render();
  }, 180);
});

// pagination clavier (‚Üê ‚Üí)
window.addEventListener("keydown", (e)=>{
  if(e.key==="ArrowRight"){ page++; render(); }
  if(e.key==="ArrowLeft"){ page=Math.max(1,page-1); render(); }
});

loadAll();
</script>
</body>
</html>
