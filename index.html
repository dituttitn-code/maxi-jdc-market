<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>MAXI JDC MARKET ‚Äì Vente en ligne</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ PWA -->
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg-dark:#050505;--bg-page:#101010;--card-bg:#181818;
      --accent:#25d366;--accent-soft:rgba(37,211,102,.18);
      --text-main:#f5f5f5;--text-muted:#aaaaaa;--border-soft:#333333;
      --radius-lg:16px;--radius-md:12px;--shadow-soft:0 10px 30px rgba(0,0,0,.5);
      --logo-size:60px;--logo-radius:50%;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#202020 0,#050505 40%,#000 100%);color:var(--text-main)}
    a{color:inherit}
    header{background:#000;color:#f9f9f9;padding:14px 16px;display:flex;align-items:center;
      justify-content:space-between;gap:16px;flex-wrap:wrap;position:sticky;top:0;z-index:50}
    header .brand{display:flex;align-items:center;gap:12px}
    header img.logo{width:var(--logo-size);height:var(--logo-size);border-radius:var(--logo-radius);
      object-fit:cover;border:none;box-shadow:none;background:transparent;display:block}
    header h1{margin:0;font-size:21px;letter-spacing:1px}
    header p.slogan{margin:2px 0 0;font-size:12px;opacity:.85}
    .header-info{font-size:11px;text-align:right;line-height:1.4}
    .header-actions{display:flex;align-items:center;gap:12px}
    .cart-button{position:relative;display:inline-flex;align-items:center;gap:6px;padding:8px 12px;
      border-radius:999px;border:1px solid rgba(255,255,255,.35);background:rgba(20,20,20,.85);
      cursor:pointer;font-size:13px}
    .cart-button span.icon{font-size:18px}
    .cart-count-badge{position:absolute;top:-6px;right:-4px;background:#ff5252;color:#fff;font-size:10px;
      padding:2px 6px;border-radius:999px;font-weight:700}
    .cart-total-mini{font-size:11px;opacity:.9}

    .hero{padding:20px 16px 10px}
    .hero-inner{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:minmax(0,2.3fr) minmax(0,1.5fr);
      gap:16px;align-items:center}
    @media (max-width:768px){.hero-inner{grid-template-columns:1fr}}
    .hero h2{margin:0 0 8px;font-size:22px}
    .hero p{margin:0 0 10px;font-size:13px;opacity:.9}
    .hero .chips{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0 14px}
    .chip{font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.18);opacity:.9}
    .btn-primary{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border-radius:999px;background:var(--accent);
      color:#000;text-decoration:none;font-weight:600;font-size:14px;border:none;cursor:pointer}
    .hero-note{font-size:11px;opacity:.8;margin-top:6px}
    .hero-highlight{border-radius:var(--radius-lg);background:rgba(0,0,0,.7);border:1px solid #303030;padding:10px 14px;
      font-size:11px;line-height:1.4}

    .page{max-width:1100px;margin:8px auto 30px;padding:0 14px 20px}
    .card{background:var(--card-bg);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);padding:16px 16px 18px;
      border:1px solid #252525;margin-bottom:14px}
    .cards-row{display:grid;grid-template-columns:minmax(0,1.5fr) minmax(0,1.5fr);gap:14px}
    @media (max-width:900px){.cards-row{grid-template-columns:1fr}}
    .card h3{margin:0 0 10px;font-size:16px}
    .card-subtitle{font-size:12px;color:var(--text-muted);margin-bottom:12px}

    .cart-items{max-height:220px;overflow-y:auto;border-radius:12px;background:#101010;padding:10px;border:1px solid var(--border-soft);margin-bottom:10px}
    .cart-empty{font-size:12px;color:var(--text-muted);text-align:center;padding:20px 8px}
    .cart-item{display:grid;grid-template-columns:minmax(0,1.5fr) auto auto auto;gap:4px 8px;font-size:12px;padding:6px 0;
      border-bottom:1px dashed #333;align-items:center}
    .cart-item:last-child{border-bottom:none}
    .cart-item-name{font-weight:500}
    .cart-item-qty{text-align:center}
    .cart-item-total{text-align:right;font-weight:600}
    .cart-remove{cursor:pointer;font-size:14px;color:#ff7777;text-align:center}
    .cart-summary{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin-top:6px;border-top:1px solid #333;padding-top:8px}
    .cart-summary span.label{color:var(--text-muted)}
    .cart-summary span.value{font-weight:700;font-size:15px}

    .checkout-form{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .form-row{display:flex;flex-direction:column;gap:3px;font-size:12px}
    .form-row label{color:var(--text-muted)}
    .input-field,.select-field{border-radius:999px;border:1px solid var(--border-soft);padding:7px 11px;font-size:13px;outline:none;
      background:#101010;color:var(--text-main);transition:border-color .15s,box-shadow .15s,background .15s}
    .input-field::placeholder{color:#666}
    .input-field:focus,.select-field:focus{border-color:var(--accent);background:#141414;box-shadow:0 0 0 2px var(--accent-soft)}
    .location-row{display:flex;gap:6px;align-items:center;margin-top:2px}
    .location-display{font-size:11px;color:var(--text-muted);flex:1;min-height:14px;word-break:break-all}
    .btn-location{border-radius:999px;border:1px dashed var(--accent);padding:5px 9px;font-size:11px;cursor:pointer;background:#061b0f;color:#9af7c2;white-space:nowrap}
    .btn-submit{margin-top:8px;border-radius:999px;border:none;background:var(--accent);color:#000;padding:10px 10px;font-size:14px;font-weight:700;
      cursor:pointer;width:100%;display:inline-flex;justify-content:center;align-items:center;gap:6px}
    .btn-submit:disabled{opacity:.6;cursor:not-allowed}
    .note-whatsapp{font-size:11px;color:var(--text-muted);margin-top:6px}

    .section-title{margin:22px 0 8px;font-size:16px}
    .categories-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .category-pill{padding:6px 11px;border-radius:999px;border:1px solid var(--border-soft);background:#101010;font-size:12px;cursor:pointer;white-space:nowrap;color:var(--text-main)}
    .category-pill.active{background:var(--accent-soft);border-color:var(--accent);color:#00ff99;font-weight:600}

    .products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px}
    .product-card{border-radius:var(--radius-md);border:1px solid var(--border-soft);padding:10px;display:flex;flex-direction:column;gap:6px;font-size:12px;background:#121212}
    .product-header{display:flex;justify-content:space-between;gap:6px;align-items:flex-start}
    .product-name{font-weight:600;font-size:13px}
    .product-category{font-size:11px;color:var(--text-muted)}
    .product-price{font-weight:700;font-size:13px;margin-top:4px}
    .product-unit{font-size:11px;color:var(--text-muted)}
    .product-actions{display:flex;justify-content:space-between;align-items:center;gap:6px;margin-top:4px}
    .qty-control{display:inline-flex;align-items:center;border-radius:999px;border:1px solid var(--border-soft);overflow:hidden;background:#101010}
    .qty-control button{border:none;background:#181818;color:#f5f5f5;padding:4px 8px;font-size:14px;cursor:pointer}
    .qty-control span{padding:0 8px;font-size:13px;min-width:20px;text-align:center}
    .btn-add{flex:1;border-radius:999px;border:none;background:var(--accent);color:#000;padding:6px 8px;font-size:12px;font-weight:600;cursor:pointer}

    .search-bar{display:flex;gap:8px;align-items:center;margin:10px 0 12px}
    .search-bar input{flex:1}
    .small-text{font-size:11px;color:var(--text-muted)}

    .qr-card{max-width:360px}
    .qr-img{width:190px;max-width:100%;display:block;margin:10px auto 0;border-radius:12px;background:#fff;padding:8px}

    footer{text-align:center;padding:14px;font-size:11px;color:#666;background:#000;border-top:1px solid #222}
    .loading{font-size:12px;color:#aaa}
  </style>
</head>

<body>
  <!-- Logo -->
<img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET" style="max-width:180px; margin-bottom:15px;">

<!-- QR code -->
<img src="qr-maxi-jdc-site.jpg" alt="QR MAXI JDC MARKET" style="max-width:180px;">

  <header>
    <div class="brand">
      <!-- ‚úÖ Logo (ta photo propre) -->
      <img src="logo-maxi-jdc.jpg" alt="MAXI JDC MARKET" class="logo" />
      <div>
        <h1>MAXI JDC MARKET</h1>
        <p class="slogan">Des prix mini ‚Äì Un MAXI choix</p>
      </div>
    </div>

    <div class="header-actions">
      <div class="header-info">
        <div>üìç Jardins de Carthage, derri√®re mosqu√©e Esselem</div>
        <div>‚è∞ 7h ‚Äì 1h du matin</div>
        <div>üì± WhatsApp : <strong>00216 25 600 978</strong></div>
      </div>

      <div class="cart-button" id="open-cart">
        <span class="icon">üß∫</span>
        <div>
          <div style="font-size:12px;">Panier</div>
          <div class="cart-total-mini"><span id="mini-cart-total">0,000</span> dt</div>
        </div>
        <div class="cart-count-badge" id="mini-cart-count">0</div>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="hero-inner">
      <div>
        <h2>Vente en ligne ‚Äì MAXI JDC MARKET</h2>
        <p>Choisissez vos produits, ajoutez au panier et envoyez votre commande directement sur WhatsApp.</p>
        <div class="chips">
          <span class="chip">üîé Recherche globale</span>
          <span class="chip">üì± Installable iOS / Android</span>
          <span class="chip">üöö Livraison min 15 dt</span>
        </div>
        <button class="btn-primary" type="button" id="scroll-to-cart">Voir mon panier</button>
        <div class="hero-note">Le message s‚Äôouvre dans WhatsApp avec la liste des produits et le total.</div>
      </div>

      <div class="hero-highlight">
        <strong>Livraison & retrait :</strong><br>
        ‚Ä¢ Livraison Jardins de Carthage et alentours (selon zone)<br>
        ‚Ä¢ <strong>Minimum livraison : 15 dt</strong><br>
        ‚Ä¢ Livraison gratuite √† partir de 30 dt d‚Äôachats<br>
        ‚Ä¢ Sinon, frais de livraison : 5 dt<br>
        ‚Ä¢ Retrait possible en magasin MAXI JDC MARKET
      </div>
    </div>
  </section>

  <main class="page">
    <div class="cards-row" id="cart-and-client">
      <section class="card">
        <h3>üõí Panier</h3>
        <div class="card-subtitle">Votre panier est vide. Ajoutez des produits pour commencer.</div>

        <div class="cart-items" id="cart-items">
          <div class="cart-empty">Aucun article dans le panier pour l‚Äôinstant.</div>
        </div>

        <div class="cart-summary">
          <span class="label"><span id="cart-count-label">0 article</span> ‚Äì Total produits</span>
          <span class="value"><span id="cart-total">0,000</span> dt</span>
        </div>

        <div class="small-text">
          Livraison : min 15 dt (si ‚ÄúLivraison √† domicile‚Äù). Frais (0 ou 5 dt) ajout√©s automatiquement.
        </div>
      </section>

      <section class="card">
        <h3>üë§ Informations client</h3>

        <form class="checkout-form" onsubmit="event.preventDefault(); sendWhatsAppOrder();">
          <div class="form-row">
            <label for="customer-name">Nom & pr√©nom</label>
            <input id="customer-name" class="input-field" type="text" placeholder="Ex : Nour Khelifi" required />
          </div>

          <div class="form-row">
            <label for="customer-phone">T√©l√©phone</label>
            <input id="customer-phone" class="input-field" type="tel" placeholder="Ex : 55 123 456" required />
          </div>

          <div class="form-row">
            <label for="customer-address">Adresse compl√®te</label>
            <input id="customer-address" class="input-field" type="text" placeholder="Immeuble, rue, √©tage, porte‚Ä¶" required />
          </div>

          <div class="form-row">
            <label for="order-type">Type de commande</label>
            <select id="order-type" class="select-field" required>
              <option value="Livraison √† domicile" selected>Livraison √† domicile</option>
              <option value="Retrait en magasin">Retrait en magasin</option>
            </select>
          </div>

          <div class="form-row">
            <label for="payment-method">Mode de paiement</label>
            <select id="payment-method" class="select-field" required>
              <option value="Esp√®ces √† la livraison" selected>Esp√®ces √† la livraison</option>
              <option value="Paiement par carte en magasin">Carte bancaire en magasin</option>
            </select>
          </div>

          <div class="form-row">
            <label>Localisation GPS (optionnel)</label>
            <div class="location-row">
              <button type="button" class="btn-location" onclick="getLocation()">üìç R√©cup√©rer ma position</button>
              <div class="location-display" id="location-display">Aucune position pour l‚Äôinstant.</div>
            </div>
          </div>

          <button class="btn-submit" type="submit" id="btn-send">Envoyer la commande sur WhatsApp üì≤</button>

          <div class="note-whatsapp">
            Num√©ro magasin : <strong>00216 25 600 978</strong><br />
            (La sonnerie/alerte d√©pend des notifications WhatsApp Business)
          </div>
        </form>
      </section>
    </div>

    <section class="card">
      <h3>üîé Recherche</h3>
      <div class="search-bar">
        <input id="search-input" class="input-field" type="text" placeholder="Chercher un article (ex: VANCAT, Stika, couches...)" />
        <button class="btn-add" type="button" id="clear-search" style="flex:none;padding:6px 12px;">Effacer</button>
      </div>
      <div class="small-text" id="search-hint">Tape un mot : la recherche s‚Äôapplique √† <strong>tous</strong> les produits.</div>
    </section>

    <section>
      <h3 class="section-title">Cat√©gories</h3>
      <div class="categories-list" id="categories-container"></div>

      <h3 class="section-title">Produits</h3>
      <div id="loading" class="loading">Chargement des produits‚Ä¶</div>
      <div class="products-grid" id="products-container"></div>
    </section>

    <section class="card qr-card">
      <h3>üì± Commander par QR code</h3>
      <p class="small-text">
        Scannez ce QR code pour ouvrir directement le site :
        <strong>dituttitn-code.github.io/maxi-jdc-delivery</strong>
      </p>
      <img src="qr-maxi-jdc-site.png" alt="QR MAXI JDC MARKET (Site)" class="qr-img" />
    </section>

    <section class="card">
      <h3>üì¶ Historique de mes commandes (2 derni√®res ann√©es)</h3>
      <p class="small-text">
        Entrez le m√™me num√©ro de t√©l√©phone utilis√© pour vos commandes pour
        voir votre historique et vos points fid√©lit√© valid√©s (sur cet appareil).
      </p>
      <div class="form-row">
        <label for="history-phone">T√©l√©phone</label>
        <input id="history-phone" class="input-field" type="tel" placeholder="Ex : 55 123 456" />
      </div>
      <button type="button" class="btn-submit" id="show-history-btn" style="margin-top:10px;">Afficher mon historique</button>
      <div id="history-result" class="small-text" style="margin-top:10px;"></div>
    </section>

    <section class="card">
      <h3>üîê Espace admin (magasin)</h3>
      <p class="small-text">
        Gestion des statuts de livraison et validation des points fid√©lit√©.
        Donn√©es sauvegard√©es dans ce navigateur (localStorage).
      </p>
      <div class="form-row">
        <label for="admin-code">Code acc√®s admin</label>
        <input id="admin-code" class="input-field" type="password" placeholder="Code admin (MAXI2024)" />
      </div>
      <button type="button" class="btn-submit" id="open-admin-btn" style="margin-top:10px;">Ouvrir le panneau admin</button>

      <div id="admin-panel" style="display:none;margin-top:12px;">
        <div class="small-text">
          Code admin actuel : <strong>MAXI2024</strong> (modifiable dans le code si besoin).
        </div>
        <div id="admin-orders-container" style="margin-top:10px;"></div>
      </div>
    </section>
  </main>

  <footer>
    MAXI JDC MARKET ‚Äì Jardins de Carthage ‚Ä¢ WhatsApp 00216 25 600 978 ‚Ä¢ Des prix mini ‚Äì Un MAXI choix
  </footer>

  <script>
    /* =======================
       ‚úÖ CONFIG
    ======================= */
    const ADMIN_CODE = "MAXI2024";
    const ORDER_STATUSES = ["En attente","En cours de pr√©paration","Pr√™t √† livrer","Livr√©"];

    const WHATSAPP_PHONE_E164 = "21625600978"; // ‚úÖ 00216 25 600 978 -> wa.me/21625600978

    const MIN_DELIVERY_AMOUNT = 15;       // ‚úÖ Minimum livraison
    const FREE_DELIVERY_FROM  = 30;       // gratuit d√®s 30
    const DELIVERY_FEE        = 5;        // sinon 5 dt

    // ‚úÖ Mets tes CSV dans /data/ sur GitHub
    // IMPORTANT : √©vite espaces/accents dans les noms de fichiers -> plus simple !
    // Exemple: "Bebe-et-maman.csv" au lieu de "B√©b√© et Maman.CSV"
    const DATA_SOURCES = [
      { category: "Animaux",          url: "data/Animaux.csv" },
      { category: "Eaux",             url: "data/Eaux.csv" },
      { category: "Fruits",           url: "data/Fruits.csv" },
      { category: "Fruits Secs",      url: "data/Fruits-Secs.csv" },
      { category: "Chips",            url: "data/Chips.csv" },
      { category: "Caf√©",             url: "data/Cafe.csv" },
      { category: "B√©b√© et Maman",    url: "data/Bebe-et-maman.csv" },
      { category: "Chocolats & Biscuits", url: "data/Chocolats-et-biscuits.csv" },
      { category: "Cuisine du monde", url: "data/Cuisine-du-monde.csv" },
      { category: "Fromage",          url: "data/Fromage.csv" }
      // üëâ tu ajoutes autant que tu veux (infini)
    ];

    /* =======================
       ‚úÖ ETAT
    ======================= */
    let categories = [];
    let products = [];           // tous les produits (charg√©s depuis CSV)
    const cart = {};
    let activeCategory = "";
    let customerLocation = "";
    let searchQuery = "";

    /* =======================
       ‚úÖ ELEMENTS
    ======================= */
    const categoriesContainer = document.getElementById("categories-container");
    const productsContainer   = document.getElementById("products-container");
    const loadingEl           = document.getElementById("loading");

    const cartItemsEl      = document.getElementById("cart-items");
    const cartTotalEl      = document.getElementById("cart-total");
    const miniCartTotalEl  = document.getElementById("mini-cart-total");
    const miniCartCountEl  = document.getElementById("mini-cart-count");
    const cartCountLabelEl = document.getElementById("cart-count-label");

    const searchInput = document.getElementById("search-input");

    /* =======================
       ‚úÖ OUTILS
    ======================= */
    function formatMoney(value) {
      return Number(value || 0).toFixed(3).replace(".", ",");
    }
    function slugify(str) {
      return String(str || "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase().trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }
    function detectDelimiter(line) {
      const commas = (line.match(/,/g) || []).length;
      const semis  = (line.match(/;/g) || []).length;
      return semis > commas ? ";" : ",";
    }
    function parseCSV(text) {
      const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim() !== "");
      if (!lines.length) return [];

      const delimiter = detectDelimiter(lines[0]);

      // parse simple (supports quotes)
      const rows = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const out = [];
        let cur = "", inQuotes = false;
        for (let j = 0; j < line.length; j++) {
          const ch = line[j];
          if (ch === '"') {
            if (inQuotes && line[j+1] === '"') { cur += '"'; j++; }
            else inQuotes = !inQuotes;
          } else if (ch === delimiter && !inQuotes) {
            out.push(cur); cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur);
        rows.push(out.map(s => s.trim()));
      }

      const header = rows[0].map(h => h.trim().toUpperCase());
      const dataRows = rows.slice(1);

      const idxCode  = header.indexOf("CODE_ARTICLE");
      const idxName  = header.indexOf("DESIGNATION");
      const idxPrix  = header.indexOf("PRIX");

      return dataRows.map(cols => ({
        code: idxCode >= 0 ? cols[idxCode] : "",
        name: idxName >= 0 ? cols[idxName] : "",
        price: idxPrix >= 0 ? cols[idxPrix] : ""
      })).filter(r => r.name);
    }
    function toPriceNumber(v) {
      const s = String(v || "").replace(",", ".").replace(/[^0-9.]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    /* =======================
       ‚úÖ CHARGEMENT PRODUITS DEPUIS GITHUB (CSV)
    ======================= */
    async function loadAllProducts() {
      products = [];
      for (const src of DATA_SOURCES) {
        try {
          const res = await fetch(src.url, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const text = await res.text();
          const rows = parseCSV(text);

          rows.forEach(r => {
            const code = String(r.code || "").trim();
            const name = String(r.name || "").trim();
            const price = toPriceNumber(r.price);

            const id = code ? ("code-" + code) : ("p-" + slugify(name));
            products.push({
              id,
              code,
              name,
              category: src.category,
              price,
              unit: "dt",
              // üëâ plus tard: imageUrl depuis CSV (colonne IMAGE_URL) ou convention assets/products/<CODE>.jpg
              imageUrl: ""
            });
          });
        } catch (e) {
          console.warn("Erreur chargement:", src.category, src.url, e);
        }
      }

      categories = Array.from(new Set(products.map(p => p.category))).sort((a,b)=>a.localeCompare(b, "fr"));
      activeCategory = categories[0] || "";
    }

    /* =======================
       ‚úÖ UI: Categories + Produits + Search
    ======================= */
    function renderCategories() {
      categoriesContainer.innerHTML = "";
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "category-pill" + (cat === activeCategory ? " active" : "");
        btn.textContent = cat;
        btn.onclick = () => {
          activeCategory = cat;
          searchQuery = "";
          searchInput.value = "";
          renderCategories();
          renderProducts();
        };
        categoriesContainer.appendChild(btn);
      });
    }

    function renderProducts() {
      productsContainer.innerHTML = "";

      const q = (searchQuery || "").trim().toLowerCase();

      let filtered = products;
      if (q) {
        filtered = products.filter(p => (
          p.name.toLowerCase().includes(q) ||
          String(p.code || "").toLowerCase().includes(q) ||
          p.category.toLowerCase().includes(q)
        ));
      } else {
        filtered = products.filter(p => p.category === activeCategory);
      }

      if (filtered.length === 0) {
        productsContainer.innerHTML = "<p style='font-size:12px;color:#aaa;'>Aucun produit trouv√©.</p>";
        return;
      }

      filtered.forEach(product => {
        const card = document.createElement("div");
        card.className = "product-card";

        const header = document.createElement("div");
        header.className = "product-header";

        const left = document.createElement("div");
        const nameEl = document.createElement("div");
        nameEl.className = "product-name";
        nameEl.textContent = product.name;

        const catEl = document.createElement("div");
        catEl.className = "product-category";
        catEl.textContent = product.category + (product.code ? (" ‚Ä¢ " + product.code) : "");
        left.appendChild(nameEl);
        left.appendChild(catEl);

        const right = document.createElement("div");
        right.style.textAlign = "right";
        const priceEl = document.createElement("div");
        priceEl.className = "product-price";
        priceEl.textContent = product.price.toFixed(3) + " dt";
        const unitEl = document.createElement("div");
        unitEl.className = "product-unit";
        unitEl.textContent = "";
        right.appendChild(priceEl);
        right.appendChild(unitEl);

        header.appendChild(left);
        header.appendChild(right);

        const actions = document.createElement("div");
        actions.className = "product-actions";

        let qty = 1;
        const qtyControl = document.createElement("div");
        qtyControl.className = "qty-control";

        const minusBtn = document.createElement("button");
        minusBtn.type = "button";
        minusBtn.textContent = "‚àí";

        const qtySpan = document.createElement("span");
        qtySpan.textContent = qty;

        minusBtn.onclick = () => { if (qty > 1) { qty--; qtySpan.textContent = qty; } };

        const plusBtn = document.createElement("button");
        plusBtn.type = "button";
        plusBtn.textContent = "+";
        plusBtn.onclick = () => { qty++; qtySpan.textContent = qty; };

        qtyControl.appendChild(minusBtn);
        qtyControl.appendChild(qtySpan);
        qtyControl.appendChild(plusBtn);

        const addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.className = "btn-add";
        addBtn.textContent = "Ajouter au panier";
        addBtn.onclick = () => addToCart(product, qty);

        actions.appendChild(qtyControl);
        actions.appendChild(addBtn);

        card.appendChild(header);
        card.appendChild(actions);
        productsContainer.appendChild(card);
      });
    }

    /* =======================
       ‚úÖ Panier
    ======================= */
    function addToCart(product, quantity) {
      if (!cart[product.id]) cart[product.id] = { product, qty: 0 };
      cart[product.id].qty += quantity;
      updateCartUI();
    }
    function removeFromCart(productId) {
      if (cart[productId]) { delete cart[productId]; updateCartUI(); }
    }
    function updateCartUI() {
      const entries = Object.values(cart).filter(item => item.qty > 0);
      let totalAmount = 0;
      let totalQty = 0;

      entries.forEach(item => { totalAmount += item.product.price * item.qty; totalQty += item.qty; });

      cartTotalEl.textContent = formatMoney(totalAmount);
      miniCartTotalEl.textContent = formatMoney(totalAmount);
      miniCartCountEl.textContent = totalQty;
      cartCountLabelEl.textContent = totalQty + (totalQty <= 1 ? " article" : " articles");

      if (entries.length === 0) {
        cartItemsEl.innerHTML = "<div class='cart-empty'>Aucun article dans le panier pour l‚Äôinstant.</div>";
        return;
      }

      cartItemsEl.innerHTML = "";
      entries.forEach(item => {
        const row = document.createElement("div");
        row.className = "cart-item";

        const nameCol = document.createElement("div");
        nameCol.className = "cart-item-name";
        nameCol.textContent = item.product.name;

        const qtyCol = document.createElement("div");
        qtyCol.className = "cart-item-qty";
        qtyCol.textContent = "√ó " + item.qty;

        const totalCol = document.createElement("div");
        totalCol.className = "cart-item-total";
        totalCol.textContent = formatMoney(item.product.price * item.qty) + " dt";

        const removeCol = document.createElement("div");
        removeCol.className = "cart-remove";
        removeCol.textContent = "‚úï";
        removeCol.title = "Retirer du panier";
        removeCol.onclick = () => removeFromCart(item.product.id);

        row.appendChild(nameCol);
        row.appendChild(qtyCol);
        row.appendChild(totalCol);
        row.appendChild(removeCol);
        cartItemsEl.appendChild(row);
      });
    }

    function clearCartAndForm() {
      for (const key in cart) delete cart[key];
      updateCartUI();
      const form = document.querySelector(".checkout-form");
      if (form) form.reset();
      customerLocation = "";
      const display = document.getElementById("location-display");
      if (display) display.textContent = "Aucune position pour l‚Äôinstant.";
    }

    /* =======================
       ‚úÖ Localisation
    ======================= */
    function getLocation() {
      const display = document.getElementById("location-display");
      if (!navigator.geolocation) { display.textContent = "La g√©olocalisation n‚Äôest pas support√©e."; return; }
      display.textContent = "Localisation en cours...";
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          customerLocation = https://www.google.com/maps?q=${lat},${lng};
          display.textContent = customerLocation;
        },
        () => { display.textContent = "Impossible d‚Äôobtenir la position."; }
      );
    }

    /* =======================
       ‚úÖ Historique / Admin (inchang√©)
    ======================= */
    function loadOrders() {
      const json = localStorage.getItem("maxiOrdersV1");
      return json ? JSON.parse(json) : [];
    }
    function saveOrders(orders) {
      localStorage.setItem("maxiOrdersV1", JSON.stringify(orders));
    }
    function createOrderId() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      let counter = Number(localStorage.getItem("maxiOrderCounter") || "0") + 1;
      localStorage.setItem("maxiOrderCounter", String(counter));
      return MAXI-${y}${m}${d}-${counter};
    }

    /* =======================
       ‚úÖ Envoi WhatsApp + minimum livraison
    ======================= */
    function sendWhatsAppOrder() {
      const entries = Object.values(cart).filter(item => item.qty > 0);
      if (entries.length === 0) { alert("Votre panier est vide."); return; }

      const name    = document.getElementById("customer-name").value.trim();
      const phone   = document.getElementById("customer-phone").value.trim();
      const address = document.getElementById("customer-address").value.trim();
      const orderType     = document.getElementById("order-type").value;
      const paymentMethod = document.getElementById("payment-method").value;

      if (!name || !phone || !address) { alert("Veuillez remplir nom, t√©l√©phone et adresse."); return; }

      let totalProducts = 0;
      entries.forEach(item => { totalProducts += item.product.price * item.qty; });

      // ‚úÖ Minimum livraison 15 dt
      if (orderType === "Livraison √† domicile" && totalProducts < MIN_DELIVERY_AMOUNT) {
        alert(Minimum livraison : ${MIN_DELIVERY_AMOUNT.toFixed(3)} dt. Votre panier est √† ${totalProducts.toFixed(3)} dt.);
        return;
      }

      let deliveryFee = 0;
      if (orderType === "Livraison √† domicile") deliveryFee = totalProducts >= FREE_DELIVERY_FROM ? 0 : DELIVERY_FEE;

      const totalWithDelivery = totalProducts + deliveryFee;
      const potentialPoints = +(totalProducts * 0.01).toFixed(3);

      const now = new Date();
      const orderId = createOrderId();
      const dateStr = now.toLocaleString("fr-FR");

      const lines = [];
      lines.push(ID : ${orderId});
      lines.push(Date : ${dateStr});
      lines.push("");
      lines.push("üõí Nouvelle commande MAXI JDC MARKET");
      lines.push("");
      lines.push("üë§ Nom : " + name);
      lines.push("üìû T√©l√©phone : " + phone);
      lines.push("üìç Adresse : " + address);
      lines.push("üöö Type de commande : " + orderType);
      lines.push("üí≥ Mode de paiement : " + paymentMethod);
      lines.push("üåç Localisation : " + (customerLocation ? customerLocation : "non fournie"));
      lines.push("");
      lines.push("Produits :");

      entries.forEach(item => {
        const lineTotal = item.product.price * item.qty;
        lines.push(‚Ä¢ ${item.qty} √ó ${item.product.name} (${item.product.price.toFixed(3)} dt) = ${lineTotal.toFixed(3)} dt);
      });

      lines.push("");
      lines.push("üí∞ Total produits : " + totalProducts.toFixed(3) + " dt");
      lines.push("üöö Frais de livraison : " + deliveryFee.toFixed(3) + " dt");
      lines.push("üí≥ Total √† payer : " + totalWithDelivery.toFixed(3) + " dt");
      lines.push("üéÅ Points fid√©lit√© (potentiels) : " + potentialPoints.toFixed(3) + " dt (valid√©s apr√®s paiement)");

      const orders = loadOrders();
      orders.push({
        id: orderId,
        dateISO: now.toISOString(),
        status: "En attente",
        customer: { name, phone, address, orderType, paymentMethod, location: customerLocation },
        items: entries.map(item => ({ id: item.product.id, code: item.product.code, name: item.product.name, price: item.product.price, qty: item.qty })),
        totalProducts: +totalProducts.toFixed(3),
        deliveryFee: +deliveryFee.toFixed(3),
        totalWithDelivery: +totalWithDelivery.toFixed(3),
        potentialPoints,
        validatedPoints: 0,
        pointsValidated: false
      });
      saveOrders(orders);

      clearCartAndForm();

      const whatsappUrl = "https://wa.me/" + WHATSAPP_PHONE_E164 + "?text=" + encodeURIComponent(lines.join("\n"));
      window.location.href = whatsappUrl;
    }

    function showCustomerHistory() {
      const phone = document.getElementById("history-phone").value.trim();
      const result = document.getElementById("history-result");
      if (!phone) { result.textContent = "Veuillez entrer un num√©ro de t√©l√©phone."; return; }

      const all = loadOrders();
      const now = new Date();
      const cutoff = new Date();
      cutoff.setFullYear(now.getFullYear() - 2);

      const list = all.filter(o => o.customer.phone === phone && new Date(o.dateISO) >= cutoff);

      if (list.length === 0) {
        result.textContent = "Aucune commande trouv√©e pour ce num√©ro sur les 2 derni√®res ann√©es (sur cet appareil).";
        return;
      }

      list.sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));

      let totalValidated = 0;
      let txt = "";

      list.forEach(order => {
        const dt = new Date(order.dateISO);
        const dateStr = dt.toLocaleString("fr-FR");
        if (order.pointsValidated) totalValidated += order.validatedPoints || 0;

        const ptsPot = formatMoney(order.potentialPoints || 0);
        const ptsVal = order.pointsValidated ? "‚úÖ " + formatMoney(order.validatedPoints || 0) + " dt" : "‚è≥ En attente de validation";

        txt +=
`‚Ä¢ ${order.id} ‚Äî ${dateStr}
   Statut : ${order.status}
   Total produits : ${formatMoney(order.totalProducts)} dt
   Livraison : ${formatMoney(order.deliveryFee)} dt
   Total pay√© : ${formatMoney(order.totalWithDelivery)} dt
   Points potentiels : ${ptsPot} dt
   Points valid√©s : ${ptsVal}

`;
      });

      txt += Points fid√©lit√© cumul√©s valid√©s : ${formatMoney(totalValidated)} dt;
      result.innerHTML = "<pre style='white-space:pre-wrap;font-size:11px;'>" + txt + "</pre>";
    }

    function renderAdminOrders() {
      const container = document.getElementById("admin-orders-container");
      const orders = loadOrders();

      if (orders.length === 0) {
        container.innerHTML = "<div style='font-size:12px;color:#aaa;'>Aucune commande enregistr√©e pour le moment.</div>";
        return;
      }

      orders.sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));

      let html = "";
      orders.forEach((order, index) => {
        const dt = new Date(order.dateISO);
        const dateStr = dt.toLocaleString("fr-FR");
        const selectId = status-${index};
        const ptsPot = formatMoney(order.potentialPoints || 0);
        const ptsVal = order.pointsValidated ? "‚úÖ " + formatMoney(order.validatedPoints || 0) + " dt" : "‚è≥ en attente";

        html += `
<div style="border-top:1px solid #333;padding:8px 0;">
  <div style="font-size:12px;font-weight:600;">
    ${order.id} ‚Äì ${order.customer.name} (${order.customer.phone})
  </div>
  <div style="font-size:11px;">
    ${dateStr} ‚Äì Total : ${formatMoney(order.totalWithDelivery)} dt (livraison ${formatMoney(order.deliveryFee)} dt)
  </div>
  <div style="font-size:11px;margin-top:4px;">
    Statut :
    <select id="${selectId}" class="select-field" style="max-width:190px;margin-top:4px;">
      ${ORDER_STATUSES.map(s => <option value="${s}" ${s === order.status ? "selected" : ""}>${s}</option>).join("")}
    </select>
  </div>
  <div style="margin-top:4px;font-size:11px;">
    Points potentiels : ${ptsPot} dt ‚Äì Points valid√©s : ${ptsVal}
  </div>
  <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
    <button type="button" class="btn-add" style="flex:none;padding:4px 10px;font-size:11px;"
      onclick="updateOrderStatus('${order.id}', document.getElementById('${selectId}').value)">
      Enregistrer le statut
    </button>
    <button type="button" class="btn-add" style="flex:none;padding:4px 10px;font-size:11px;background:#ffd54f;color:#000;"
      onclick="validateOrderPoints('${order.id}')">
      Valider les points
    </button>
  </div>
</div>`;
      });

      container.innerHTML = html;
    }

    function updateOrderStatus(orderId, newStatus) {
      const orders = loadOrders();
      const idx = orders.findIndex(o => o.id === orderId);
      if (idx === -1) { alert("Commande introuvable."); return; }
      orders[idx].status = newStatus;
      saveOrders(orders);
      alert("Statut mis √† jour.");
      renderAdminOrders();
      refreshHistoryIfOpen();
    }

    function validateOrderPoints(orderId) {
      const orders = loadOrders();
      const idx = orders.findIndex(o => o.id === orderId);
      if (idx === -1) { alert("Commande introuvable."); return; }
      const order = orders[idx];
      if (order.pointsValidated) { alert("Les points pour cette commande sont d√©j√† valid√©s."); return; }
      if (order.status !== "Livr√©") {
        const ok = confirm("La commande n‚Äôest pas au statut 'Livr√©'. Valider les points quand m√™me ?");
        if (!ok) return;
      }
      order.pointsValidated = true;
      order.validatedPoints = order.potentialPoints || 0;
      saveOrders(orders);
      alert("Points fid√©lit√© valid√©s.");
      renderAdminOrders();
      refreshHistoryIfOpen();
    }

    function refreshHistoryIfOpen() {
      const phoneInput = document.getElementById("history-phone");
      const result = document.getElementById("history-result");
      if (phoneInput && result && phoneInput.value.trim()) showCustomerHistory();
    }

    /* =======================
       ‚úÖ Events + PWA SW
    ======================= */
    document.getElementById("scroll-to-cart").addEventListener("click", () => {
      document.getElementById("cart-and-client").scrollIntoView({ behavior: "smooth" });
    });
    document.getElementById("open-cart").addEventListener("click", () => {
      document.getElementById("cart-and-client").scrollIntoView({ behavior: "smooth" });
    });

    document.getElementById("show-history-btn").addEventListener("click", showCustomerHistory);

    document.getElementById("open-admin-btn").addEventListener("click", () => {
      const code = document.getElementById("admin-code").value.trim();
      const panel = document.getElementById("admin-panel");
      if (code === ADMIN_CODE) { panel.style.display = "block"; renderAdminOrders(); }
      else { panel.style.display = "none"; alert("Code admin incorrect."); }
    });

    searchInput.addEventListener("input", () => {
      searchQuery = searchInput.value;
      renderProducts();
    });
    document.getElementById("clear-search").addEventListener("click", () => {
      searchQuery = "";
      searchInput.value = "";
      renderProducts();
    });

    async function init() {
      // PWA: service worker
      if ("serviceWorker" in navigator) {
        try { await navigator.serviceWorker.register("sw.js"); } catch (e) {}
      }

      await loadAllProducts();
      loadingEl.style.display = "none";
      renderCategories();
      renderProducts();
      updateCartUI();
    }

    window.getLocation = getLocation;
    window.sendWhatsAppOrder = sendWhatsAppOrder;
    window.updateOrderStatus = updateOrderStatus;
    window.validateOrderPoints = validateOrderPoints;

    init();
  </script>
</body>
</html>

