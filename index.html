<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>MAXI JDC MARKET</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#0b0f14;color:#fff}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#0e1621}
.logo{font-size:20px;font-weight:bold}
.logo span{color:#1f8f55}
input,button{padding:10px;border-radius:20px;border:none}
button{cursor:pointer}
#container{display:flex}
#cats{width:240px;padding:10px}
.cat{background:#131b28;padding:10px;border-radius:10px;margin-bottom:6px;cursor:pointer}
.cat.active{background:#1f8f55}
#products{flex:1;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.card{background:#131b28;padding:10px;border-radius:10px}
.price{float:right;background:#1f8f55;padding:4px 8px;border-radius:12px}
.cart-btn{position:relative}
.cart-count{position:absolute;top:-5px;right:-5px;background:red;color:#fff;border-radius:50%;padding:2px 6px;font-size:12px}
#cartBox{position:fixed;top:0;right:0;width:340px;height:100%;background:#0e1621;padding:12px;display:none;overflow:auto}
</style>
</head>

<body>

<header>
<div class="logo">M<span>/JDC/</span>M</div>
<button class="cart-btn" onclick="toggleCart()">üõí Panier <span class="cart-count" id="cartCount">0</span></button>
</header>

<div id="container">
<div id="cats"></div>
<div id="products"></div>
</div>

<div id="cartBox">
<h3>üõí Panier</h3>
<div id="cartItems"></div>
<hr>
<div id="totalBox"></div>

<h4>üë§ Informations client</h4>
<input id="cName" placeholder="Nom"><br><br>
<input id="cPhone" placeholder="T√©l√©phone"><br><br>
<input id="cAddr" placeholder="Adresse"><br><br>
<button onclick="getGPS()">üìç Utiliser ma position</button>
<div id="gps"></div>

<hr>
<button onclick="sendOrder()">üì§ Envoyer la commande</button>
</div>

<script>
const MIN_ORDER = 15;
const DELIVERY_FEE = 5;

const CATEGORIES=[
 {id:"sucree",name:"√âpicerie Sucr√©e",file:"data/epicerie_sucree.csv"},
 {id:"salee",name:"√âpicerie Sal√©e",file:"data/epicerie_salee.csv"},
 {id:"pates",name:"P√¢tes",file:"data/pates.csv"}
];

let cart=[];
let gpsData="";

function parseCSV(t,cat){
 const l=t.replace(/\r/g,"").split("\n").filter(x=>x.trim());
 const h=l[0].split(";").map(x=>x.toLowerCase());
 const iN=h.indexOf("designation");
 const iP=h.indexOf("price");
 return l.slice(1).map(r=>{
  const c=r.split(";");
  return{n:c[iN],p:Number(c[iP].replace(",",".")),cat};
 });
}

async function showCat(c){
 document.querySelectorAll(".cat").forEach(x=>x.classList.remove("active"));
 document.getElementById("cat-"+c.id).classList.add("active");
 const t=await fetch(c.file+"?v="+Date.now()).then(r=>r.text());
 const d=parseCSV(t,c.name);
 products.innerHTML="";
 d.forEach(p=>{
  products.innerHTML+=`
  <div class="card">
   <div class="price">${p.p.toFixed(2)} dt</div>
   <b>${p.n}</b><br><br>
   <button onclick='addCart(${JSON.stringify(p)})'>Ajouter</button>
  </div>`;
 });
}

function addCart(p){
 cart.push(p);
 updateCart();
}

function updateCart(){
 cartCount.innerText=cart.length;
 cartItems.innerHTML="";
 let sum=0;
 cart.forEach((p,i)=>{
  sum+=p.p;
  cartItems.innerHTML+=`${p.n} - ${p.p.toFixed(2)} dt <button onclick="cart.splice(${i},1);updateCart()">‚ùå</button><br>`;
 });
 totalBox.innerHTML=`Total produits : ${sum.toFixed(2)} dt<br>Livraison : ${DELIVERY_FEE} dt<br><b>Total : ${(sum+DELIVERY_FEE).toFixed(2)} dt</b>`;
}

function toggleCart(){
 cartBox.style.display=cartBox.style.display?"":"block";
}

function getGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  gpsData=`${p.coords.latitude}, ${p.coords.longitude}`;
  gps.innerText="GPS enregistr√©";
 });
}

function sendOrder(){
 const sum=cart.reduce((a,b)=>a+b.p,0);
 if(sum<MIN_ORDER){alert("Commande minimum "+MIN_ORDER+" dt");return;}
 localStorage.setItem("client",JSON.stringify({
  n:cName.value,t:cPhone.value,a:cAddr.value
 }));
 alert("Commande envoy√©e !");
 cart=[];
 updateCart();
 cartBox.style.display="none";
}

function init(){
 const cl=JSON.parse(localStorage.getItem("client")||"{}");
 cName.value=cl.n||"";cPhone.value=cl.t||"";cAddr.value=cl.a||"";
 CATEGORIES.forEach(c=>{
  cats.innerHTML+=`<div class="cat" id="cat-${c.id}" onclick='showCat(CATEGORIES.find(x=>x.id=="${c.id}"))'>${c.name}</div>`;
 });
 showCat(CATEGORIES[0]);
}
init();
</script>
</body>
</html>
