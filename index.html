<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äî Commande</title>

  <style>
    :root{
      --bg0:#071015;
      --bg1:#0b1620;
      --card:#0c1a22;
      --card2:#0f2230;
      --line:#1b3442;
      --text:#e8f1f6;
      --muted:#9db0bc;
      --accent:#26d6c8;
      --accent2:#22c55e;
      --danger:#ff5b5b;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(38,214,200,.10), transparent 60%),
        radial-gradient(1200px 800px at 80% 0%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }
    .wrap{ width:min(1200px, 96vw); margin: 28px auto 40px; }

    .top{
      background: rgba(12,26,34,.72);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .topRow{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px; padding: 6px 10px; border-radius: 16px;
    }
    .logo{
      width: 64px; height: 64px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center; overflow:hidden; flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit: cover; display:block; }

    .brandText b{
      display:block;
      font-size: 20px;   /* plus grand */
      line-height: 1.1;
      letter-spacing: .2px;
    }
    .brandText span{
      display:block;
      color:var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }

    .controls{
      display:flex; align-items:center; gap:10px;
      flex:1 1 420px; min-width: 320px; justify-content:center;
    }
    .search{ display:flex; gap:10px; align-items:center; flex:1 1 520px; min-width: 320px; }
    .search input{
      flex:1 1 auto; min-width:220px; height:42px; padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text); outline:none;
    }
    .search input::placeholder{ color: rgba(232,241,246,.55); }

    .btn{
      height:42px; padding:0 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text); cursor:pointer; font-weight:800; white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.green{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35); }
    .btn.green:hover{ background: rgba(34,197,94,.18); }

    .pills{
      display:flex; gap:10px; align-items:center;
      margin-left:auto; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      padding: 8px 12px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text); font-size: 12px;
      display:flex; align-items:center; gap:8px;
    }
    .cartPill{ cursor:pointer; user-select:none; }
    .cartPill:hover{ background: rgba(255,255,255,.10); }
    #cartTopCount{
      margin-left:8px;
      display:inline-block;
      min-width:24px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
      text-align:center;
    }

    .noteBar{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(12,26,34,.55);
      border:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .noteBar .ok{ color: var(--accent2); font-weight: 900; }

    .grid{ margin-top: 14px; display:grid; grid-template-columns: 320px 1fr; gap: 14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .panel{
      background: rgba(12,26,34,.70);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
    }
    .panelHeader h3{ margin:0; font-size: 14px; letter-spacing: .3px; }
    .sub{ color: var(--muted); font-size: 12px; }

    .cats{ padding: 12px; display:flex; flex-direction:column; gap: 10px; }
    .catBtn{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      color: var(--text);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .catBtn:hover{ background: rgba(255,255,255,.09); }
    .catBtn.active{
      border-color: rgba(38,214,200,.45);
      background: rgba(38,214,200,.08);
      box-shadow: 0 0 0 2px rgba(38,214,200,.08) inset;
    }
    .catBtn .meta{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .catBtn .meta b{ font-size: 13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .catBtn .meta span{ font-size: 11px; color: var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .badge{
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      flex:0 0 auto;
    }

    .main{ display:flex; flex-direction:column; min-height: 420px; }
    .mainTop{
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .mainTitle b{ display:block; font-size: 14px; }
    .mainTitle span{ display:block; color:var(--muted); font-size: 12px; }

    .pager{ display:flex; align-items:center; gap:10px; color: var(--muted); font-size: 12px; }
    .pager .navBtn{
      width: 34px; height: 34px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      color: var(--text);
    }
    .pager .navBtn:hover{ background: rgba(255,255,255,.10); }

    .products{
      padding: 14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 1100px){ .products{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 560px){ .products{ grid-template-columns: 1fr; } }

    .card{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 92px;
    }
    .cardTop{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
    .pName{
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .1px;
      line-height: 1.1;
    }
    .pSub{ color: var(--muted); font-size: 11px; margin-top: 3px; }
    .price{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(38,214,200,.25);
      background: rgba(38,214,200,.08);
      font-weight: 900;
      white-space:nowrap;
      align-self:flex-start;
      min-width: 86px;
      text-align:center;
    }
    .cardBottom{ display:flex; justify-content:flex-end; gap:10px; align-items:center; }
    .addBtn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight: 900;
    }
    .addBtn:hover{ background: rgba(255,255,255,.10); }
    .addBtn[disabled]{ opacity:.45; cursor:not-allowed; }
    .empty{ color: var(--muted); padding: 20px 14px; }

    /* Drawer */
    .overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:stretch; justify-content:flex-end;
      z-index: 999;
    }
    .overlay.show{ display:flex; }

    .drawer{
      width: min(460px, 92vw);
      background: rgba(10,18,24,.98);
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
    }
    .drawerHead{
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .drawerHead b{ font-size: 14px; }
    .drawerClose{
      width: 36px; height: 36px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      color: var(--text);
      font-weight: 900;
    }
    .drawerClose:hover{ background: rgba(255,255,255,.10); }
    .drawerBody{ padding: 14px; overflow:auto; flex:1 1 auto; }

    .cartList{ display:flex; flex-direction:column; gap:10px; }
    .cartItem{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .cartItem .l{ min-width:0; }
    .cartItem .l b{
      display:block; font-size: 13px; line-height: 1.1; margin-bottom: 3px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .cartItem .l span{
      display:block; color: var(--muted); font-size: 11px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .qty{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }
    .qty button{
      width: 32px; height: 32px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      color: var(--text);
      font-weight: 900;
    }
    .qty button:hover{ background: rgba(255,255,255,.10); }
    .qty .n{ min-width: 24px; text-align:center; font-weight: 900; }

    .summary{
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      color: var(--muted);
      font-size: 12px;
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .row b{ color: var(--text); }

    .warn{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,91,91,.30);
      background: rgba(255,91,91,.10);
      color: #ffd0d0;
      font-size: 12px;
      display:none;
    }
    .warn.show{ display:block; }

    .drawerFoot{
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .btnWide{ flex:1 1 220px; display:flex; gap:10px; }
    .btnWide .btn{ flex:1 1 auto; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .form label{ display:block; font-size: 11px; color: var(--muted); margin-bottom: 4px; }
    .form input, .form textarea{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 10px;
      outline:none;
    }
    .form textarea{ min-height: 70px; resize: vertical; }
    .form .full{ grid-column: 1 / -1; }

    /* Admin modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
      padding: 18px;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      background: rgba(10,18,24,.98);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalBody{ padding: 14px; max-height: 70vh; overflow:auto; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }
    .box{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
    }
    .box h4{ margin:0 0 8px; font-size: 13px; }

    table{ width:100%; border-collapse: collapse; font-size: 12px; }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,.06);
      padding: 8px 6px;
      text-align:left;
      vertical-align: top;
      color: var(--muted);
    }
    th{ color: var(--text); font-weight: 900; }
    .tiny{ font-size:11px; color: var(--muted); }

    .hint{
      margin-top: 10px;
      text-align:center;
      color: rgba(232,241,246,.35);
      font-size: 11px;
      user-select:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo" title="MAXI JDC MARKET">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET">
          </div>
          <div class="brandText">
            <b>MAXI JDC MARKET</b>
            <span>Des prix mini ‚Äî Un MAXI choix</span>
          </div>
        </div>

        <div class="controls">
          <div class="search">
            <input id="q" type="text" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." />
            <button class="btn" id="clearBtn">Effacer</button>
            <button class="btn green" id="globalBtn">Recherche globale</button>
          </div>
        </div>

        <div class="pills">
          <div class="pill">üìç Jardins de Carthage, derri√®re mosqu√©e Essalem</div>
          <div class="pill">üïñ 7h ‚Äì 1h</div>
          <div class="pill">üí¨ WhatsApp: <b id="waShow">00216 25 600 978</b></div>

          <div class="pill cartPill" id="cartTopBtn" title="Ouvrir le panier">
            üõí Panier <span id="cartTopCount">0</span>
          </div>
        </div>
      </div>

      <div class="noteBar">
        <span class="ok">‚úÖ</span>
        <span>Donn√©es charg√©es depuis <b>/data/*.csv</b> ‚Äî une cat√©gorie = un fichier CSV.</span>
        <span style="margin-left:auto;"></span>
        <span class="sub">Conditions : minimum livraison <b>15 dt</b> ¬∑ Livraison gratuite si total ‚â• <b>30 dt</b> ¬∑ Sinon frais <b>5 dt</b></span>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="panelHeader">
          <h3>Cat√©gories</h3>
          <div class="sub" id="status">Chargement‚Ä¶</div>
        </div>
        <div class="cats" id="cats"></div>
      </div>

      <div class="panel main">
        <div class="mainTop">
          <div class="mainTitle">
            <b id="activeTitle">Produits</b>
            <span id="activeSub">S√©lectionne une cat√©gorie.</span>
          </div>
          <div class="pager">
            <button class="navBtn" id="prevBtn" title="Page pr√©c√©dente">‚Äπ</button>
            <span id="pageInfo">Page 1/1</span>
            <button class="navBtn" id="nextBtn" title="Page suivante">‚Ä∫</button>
          </div>
        </div>
        <div class="products" id="products">
          <div class="empty">S√©lectionne une cat√©gorie √† gauche.</div>
        </div>
      </div>
    </div>

    <div class="hint">Admin : Ctrl + Shift + A (ou ajoute #admin √† l‚ÄôURL)</div>
  </div>

  <!-- PANIER -->
  <div class="overlay" id="cartOverlay" aria-hidden="true">
    <div class="drawer" role="dialog" aria-label="Panier">
      <div class="drawerHead">
        <b>üõí Panier</b>
        <button class="drawerClose" id="cartCloseBtn">‚úï</button>
      </div>

      <div class="drawerBody">
        <div class="cartList" id="cartList"></div>

        <div class="warn" id="minWarn">Minimum commande <b>15 dt</b> pour valider la livraison.</div>

        <div class="summary">
          <div class="row"><span>Sous-total</span><b id="subTotal">0,00 dt</b></div>
          <div class="row"><span>Frais livraison</span><b id="shipFee">‚Äî</b></div>
          <div class="row"><span>Total</span><b id="cartTotal">0,00 dt</b></div>
        </div>

        <div class="box" style="margin-top:12px;">
          <h4>Fiche client</h4>
          <div class="form">
            <div>
              <label>Nom</label>
              <input id="cName" placeholder="Nom et pr√©nom" />
            </div>
            <div>
              <label>T√©l√©phone</label>
              <input id="cTel" placeholder="ex: 25xxxxxx" />
            </div>
            <div class="full">
              <label>Adresse</label>
              <input id="cAddr" placeholder="Adresse compl√®te (quartier, rue‚Ä¶)" />
            </div>
            <div class="full">
              <label>Note (optionnel)</label>
              <textarea id="cNote" placeholder="Ex: sonnette, √©tage, rep√®re‚Ä¶"></textarea>
            </div>
          </div>
          <div class="tiny" style="margin-top:8px;">
            ‚ö†Ô∏è L‚Äôhistorique client est enregistr√© sur ce navigateur (localStorage).
          </div>
        </div>
      </div>

      <div class="drawerFoot">
        <button class="btn" id="clearCartBtn">Vider</button>
        <div class="btnWide">
          <button class="btn green" id="sendWhatsAppBtn">Envoyer sur WhatsApp</button>
          <button class="btn" id="saveOrderBtn">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="modalOverlay" id="adminOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Admin">
      <div class="modalHead">
        <b>üõ†Ô∏è Admin ‚Äî Historique & Clients</b>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="exportBtn">Exporter JSON</button>
          <button class="btn" id="clearHistoryBtn" style="border-color:rgba(255,91,91,.35); background:rgba(255,91,91,.10);">Vider l‚Äôhistorique</button>
          <button class="drawerClose" id="adminCloseBtn">‚úï</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div class="box">
            <h4>Param√®tres</h4>
            <div class="form" style="margin-top:8px;">
              <div>
                <label>WhatsApp (num√©ro)</label>
                <input id="waNumber" placeholder="0021625600978" />
              </div>
              <div>
                <label>Minimum commande (dt)</label>
                <input id="minOrder" placeholder="15" />
              </div>
              <div>
                <label>Livraison gratuite ‚â• (dt)</label>
                <input id="freeShip" placeholder="30" />
              </div>
              <div>
                <label>Frais livraison (dt)</label>
                <input id="shipFeeAdmin" placeholder="5" />
              </div>
              <div class="full" style="display:flex; gap:10px;">
                <button class="btn green" id="saveSettingsBtn">Enregistrer</button>
                <button class="btn" id="resetSettingsBtn">Valeurs par d√©faut</button>
              </div>
            </div>
            <div class="tiny">Acc√®s Admin: Ctrl+Shift+A ou #admin</div>
          </div>

          <div class="box">
            <h4>Recherche client</h4>
            <div class="search" style="margin-top:8px;">
              <input id="adminSearch" placeholder="Recherche (nom, tel)..." />
              <button class="btn" id="adminSearchClear">Effacer</button>
            </div>
            <div class="tiny" style="margin-top:6px;">Le tableau se met √† jour automatiquement.</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px;">
          <div class="box">
            <h4>Clients (historique)</h4>
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>T√©l</th>
                    <th>Nb commandes</th>
                    <th>Total d√©pens√©</th>
                    <th>Derni√®re adresse</th>
                  </tr>
                </thead>
                <tbody id="clientsTable"></tbody>
              </table>
            </div>
          </div>

          <div class="box">
            <h4>Derni√®res commandes</h4>
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Total</th>
                    <th>R√©sum√©</th>
                  </tr>
                </thead>
                <tbody id="ordersTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /********************
     * CONFIG + STATE
     ********************/
    const DEFAULT_SETTINGS = {
      whatsapp: "0021625600978",
      minOrder: 15,
      freeShipping: 30,
      shippingFee: 5,
      pageSize: 12
    };

    const STORAGE_SETTINGS = "maxi_settings_v2";
    const STORAGE_CART = "maxi_cart_v2";
    const STORAGE_ORDERS = "maxi_orders_v2";

    const state = {
      settings: loadSettings(),
      cart: loadCart(),
      dataByCat: new Map(),
      activeCat: null,
      global: false,
      page: 1,
      q: ""
    };

    const CATEGORIES = [
      { key:"fruits_legumes", label:"Fruits & L√©gumes", file:"data/fruits_legumes.csv" },
      { key:"lait_oeufs_produits_frais", label:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
      { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
      { key:"boulangerie_patisserie", label:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
      { key:"epicerie_salee", label:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
      { key:"epicerie_sucree", label:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
      { key:"pates", label:"P√¢tes", file:"data/pates.csv" },
      { key:"conserves", label:"Conserves", file:"data/conserves.csv" }
    ];

    function $(id){ return document.getElementById(id); }

    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || "null");
        return Object.assign({}, DEFAULT_SETTINGS, s || {});
      }catch(e){
        return Object.assign({}, DEFAULT_SETTINGS);
      }
    }
    function saveSettings(){
      localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(state.settings));
      $("waShow").textContent = formatWAShow(state.settings.whatsapp);
    }

    function loadCart(){
      try{
        const c = JSON.parse(localStorage.getItem(STORAGE_CART) || "{}");
        return c && typeof c === "object" ? c : {};
      }catch(e){ return {}; }
    }
    function saveCart(){ localStorage.setItem(STORAGE_CART, JSON.stringify(state.cart)); }

    function fmtDT(n){
      const v = Number(n || 0);
      return v.toFixed(2).replace(".", ",") + " dt";
    }

    function formatWAShow(n){
      const digits = String(n || "").replace(/\D/g,"");
      if(digits.startsWith("00216")){
        const rest = digits.slice(5);
        return "00216 " + rest.replace(/(\d{2})(\d{3})(\d{3})/, "$1 $2 $3");
      }
      return n;
    }

    /********************
     * PARSE CSV (ROBUSTE)
     * Supporte:
     * - TAB \t
     * - ;
     * - ,
     * - fichiers sans header (code + designation + prix)
     * - fichiers avec colonnes en + (prix √† la fin)
     ********************/
    function isNumericToken(x){
      const s = String(x ?? "").trim().replace(/\s+/g,"");
      if(!s) return false;
      const v = Number(s.replace(",", "."));
      return Number.isFinite(v);
    }

    function toNumber(x){
      const s = String(x ?? "").trim().replace(/\s+/g,"");
      const v = Number(s.replace(",", "."));
      return Number.isFinite(v) ? v : NaN;
    }

    function detectDelimiter(line){
      const counts = [
        { d:"\t", c:(line.split("\t").length-1) },
        { d:";",  c:(line.split(";").length-1) },
        { d:",",  c:(line.split(",").length-1) }
      ].sort((a,b)=>b.c-a.c);
      return counts[0].c > 0 ? counts[0].d : "\t";
    }

    function splitLine(line, delim){
      // split simple (pas besoin de quotes ici, tes fichiers sont "propres")
      return line.split(delim).map(x=>x.trim());
    }

    function parseProductsText(text){
      const lines = text.replace(/\r/g,"").split("\n").map(l=>l.trim()).filter(l=>l);
      if(!lines.length) return [];

      const delim = detectDelimiter(lines[0]);

      // Detect header (contient "code" + "prix" etc)
      const firstCols = splitLine(lines[0], delim).map(x=>x.toLowerCase());
      const looksHeader =
        firstCols.some(h => h.includes("code")) &&
        firstCols.some(h => h.includes("prix") || h.includes("price"));

      let start = 0;
      let idxCode = 0, idxName = 1, idxPrice = 2;

      if(looksHeader){
        idxCode = firstCols.findIndex(h => h.includes("code"));
        idxName = firstCols.findIndex(h => h.includes("designation") || h.includes("d√©signation") || h.includes("name") || h.includes("article"));
        idxPrice = firstCols.findIndex(h => h.includes("prix") || h.includes("price"));
        start = 1;
      }

      const out = [];
      for(let i=start; i<lines.length; i++){
        const cols = splitLine(lines[i], delim);
        if(cols.length < 2) continue;

        let code = "";
        let name = "";
        let price = NaN;

        if(looksHeader){
          code = (cols[idxCode] ?? "").trim();
          name = (cols[idxName] ?? "").trim();
          price = toNumber(cols[idxPrice] ?? "");
        }else{
          // Sans header: la logique la plus fiable:
          // - code = 1er champ
          // - prix = dernier champ NUMERIQUE (souvent le dernier)
          // - nom = entre les deux
          code = (cols[0] ?? "").trim();

          // cherche prix √† partir de la fin
          let pIndex = -1;
          for(let k=cols.length-1; k>=1; k--){
            if(isNumericToken(cols[k])) { pIndex = k; break; }
          }

          if(pIndex === -1){
            // fallback: si 3e colonne est prix
            pIndex = cols.length >= 3 && isNumericToken(cols[2]) ? 2 : -1;
          }

          if(pIndex !== -1){
            price = toNumber(cols[pIndex]);
            const middle = cols.slice(1, pIndex).join(" ").trim();
            name = middle || (cols[1] ?? "").trim();
          }else{
            // pas de prix => on garde article mais on bloque l'ajout
            name = cols.slice(1).join(" ").trim();
            price = NaN;
          }
        }

        if(!code && !name) continue;

        out.push({
          code,
          name,
          price: Number.isFinite(price) ? price : null
        });
      }
      return out;
    }

    /********************
     * SHIPPING RULES
     ********************/
    function cartCount(){ return Object.values(state.cart).reduce((a,b)=>a + (b.qty||0), 0); }
    function cartTotal(){
      return Object.values(state.cart).reduce((a,it)=> a + (Number(it.price)||0) * (it.qty||0), 0);
    }

    function shippingFee(){
      const total = cartTotal();
      const MIN = Number(state.settings.minOrder)||15;
      const FREE = Number(state.settings.freeShipping)||30;
      const FEE = Number(state.settings.shippingFee)||5;

      if(total < MIN) return null;
      if(total >= FREE) return 0;
      return FEE;
    }
    function grandTotal(){
      const fee = shippingFee();
      if(fee === null) return null;
      return cartTotal() + fee;
    }

    /********************
     * UI BUILD
     ********************/
    function buildCats(){
      const box = $("cats");
      box.innerHTML = "";
      for(const c of CATEGORIES){
        const btn = document.createElement("button");
        btn.className = "catBtn" + (state.activeCat === c.key ? " active" : "");
        btn.onclick = () => {
          state.activeCat = c.key;
          state.global = false;
          state.page = 1;
          $("globalBtn").classList.remove("green");
          buildCats();
          render();
        };

        const meta = document.createElement("div");
        meta.className = "meta";

        const t = document.createElement("b");
        t.textContent = c.label;
        const s = document.createElement("span");
        s.textContent = "CSV: " + c.file.split("/").pop();

        meta.appendChild(t);
        meta.appendChild(s);

        const count = document.createElement("span");
        count.className = "badge";
        const arr = state.dataByCat.get(c.key) || [];
        count.textContent = arr.length + " article(s)";

        btn.appendChild(meta);
        btn.appendChild(count);
        box.appendChild(btn);
      }
    }

    function activeLabel(){
      if(state.global) return "Recherche globale";
      const c = CATEGORIES.find(x=>x.key===state.activeCat);
      return c ? c.label : "Produits";
    }
    function activeFile(){
      const c = CATEGORIES.find(x=>x.key===state.activeCat);
      return c ? c.file : "";
    }

    function getAllItems(){
      if(state.global){
        let all = [];
        for(const c of CATEGORIES){
          const arr = state.dataByCat.get(c.key) || [];
          all = all.concat(arr.map(it => ({...it, catKey:c.key, catLabel:c.label})));
        }
        return all;
      }
      if(!state.activeCat) return [];
      const c = CATEGORIES.find(x=>x.key===state.activeCat);
      const arr = state.dataByCat.get(state.activeCat) || [];
      return arr.map(it => ({...it, catKey: state.activeCat, catLabel: c ? c.label : ""}));
    }

    function matchQuery(it, q){
      if(!q) return true;
      const s = q.toLowerCase().trim();
      const hay = [it.name||"", it.code||"", it.catLabel||""].join(" ").toLowerCase();
      return hay.includes(s);
    }

    function render(){
      $("activeTitle").textContent = activeLabel();
      if(state.global){
        $("activeSub").textContent = "Recherche sur toutes les cat√©gories.";
      }else if(state.activeCat){
        $("activeSub").textContent = "Source: /" + activeFile() + " ¬∑ Mise √† jour rapide (prix + nouveaux articles)";
      }else{
        $("activeSub").textContent = "S√©lectionne une cat√©gorie.";
      }

      const box = $("products");
      const all = getAllItems().filter(it => matchQuery(it, state.q));

      const pageSize = Number(state.settings.pageSize)||12;
      const totalPages = Math.max(1, Math.ceil(all.length / pageSize));
      state.page = Math.min(state.page, totalPages);

      const start = (state.page - 1) * pageSize;
      const slice = all.slice(start, start + pageSize);

      $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
      $("prevBtn").disabled = state.page <= 1;
      $("nextBtn").disabled = state.page >= totalPages;

      box.innerHTML = "";
      if(!state.activeCat && !state.global){
        box.innerHTML = `<div class="empty">S√©lectionne une cat√©gorie √† gauche.</div>`;
        return;
      }
      if(!slice.length){
        box.innerHTML = `<div class="empty">Aucun r√©sultat.</div>`;
        return;
      }

      for(const p of slice){
        const card = document.createElement("div");
        card.className = "card";

        const top = document.createElement("div");
        top.className = "cardTop";

        const left = document.createElement("div");
        left.style.minWidth = "0";

        const name = document.createElement("div");
        name.className = "pName";
        name.textContent = (p.name || "").toUpperCase();

        const sub = document.createElement("div");
        sub.className = "pSub";
        sub.textContent = `Code: ${p.code || "-"} ¬∑ ${p.catLabel || ""}`;

        left.appendChild(name);
        left.appendChild(sub);

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = (p.price == null) ? "‚Äî" : fmtDT(p.price);

        top.appendChild(left);
        top.appendChild(price);

        const bottom = document.createElement("div");
        bottom.className = "cardBottom";

        const add = document.createElement("button");
        add.className = "addBtn";
        add.textContent = "+ Ajouter";
        add.disabled = (p.price == null);
        add.title = (p.price == null) ? "Prix manquant dans le CSV" : "Ajouter au panier";
        add.onclick = () => addToCart(p);

        bottom.appendChild(add);

        card.appendChild(top);
        card.appendChild(bottom);
        box.appendChild(card);
      }
    }

    /********************
     * CART
     ********************/
    function addToCart(p){
      if(p.price == null) return;
      const key = String(p.code || p.name || Math.random());
      if(!state.cart[key]){
        state.cart[key] = {
          code: p.code || "",
          name: p.name || "",
          price: Number(p.price)||0,
          qty: 1
        };
      }else{
        state.cart[key].qty = (state.cart[key].qty||0) + 1;
      }
      saveCart();
      refreshCartUI();
    }

    function incItem(key){
      if(!state.cart[key]) return;
      state.cart[key].qty = (state.cart[key].qty||0) + 1;
      saveCart();
      refreshCartUI();
    }
    function decItem(key){
      if(!state.cart[key]) return;
      state.cart[key].qty = (state.cart[key].qty||0) - 1;
      if(state.cart[key].qty <= 0) delete state.cart[key];
      saveCart();
      refreshCartUI();
    }
    function clearCart(){
      state.cart = {};
      saveCart();
      refreshCartUI();
      render();
    }

    function refreshCartUI(){
      $("cartTopCount").textContent = cartCount();

      const list = $("cartList");
      list.innerHTML = "";

      const keys = Object.keys(state.cart);
      if(!keys.length){
        list.innerHTML = `<div class="empty">Panier vide. Ajoute des articles üòä</div>`;
      }else{
        for(const k of keys){
          const it = state.cart[k];

          const row = document.createElement("div");
          row.className = "cartItem";

          const l = document.createElement("div");
          l.className = "l";
          const b = document.createElement("b");
          b.textContent = it.name || "";
          const s = document.createElement("span");
          s.textContent = `Code: ${it.code || "-"} ¬∑ ${fmtDT(it.price)}`;
          l.appendChild(b); l.appendChild(s);

          const r = document.createElement("div");
          r.className = "qty";

          const m = document.createElement("button");
          m.textContent = "‚àí";
          m.onclick = () => decItem(k);

          const n = document.createElement("div");
          n.className = "n";
          n.textContent = String(it.qty || 0);

          const p = document.createElement("button");
          p.textContent = "+";
          p.onclick = () => incItem(k);

          r.appendChild(m); r.appendChild(n); r.appendChild(p);

          row.appendChild(l);
          row.appendChild(r);
          list.appendChild(row);
        }
      }

      const sub = cartTotal();
      $("subTotal").textContent = fmtDT(sub);

      const fee = shippingFee();
      const totalBox = $("cartTotal");

      if(fee === null){
        $("shipFee").textContent = "‚Äî";
        totalBox.textContent = "Minimum commande 15 dt";
        totalBox.style.color = "var(--danger)";
        $("minWarn").classList.add("show");
      }else{
        $("shipFee").textContent = fmtDT(fee);
        const g = grandTotal();
        totalBox.textContent = fmtDT(g);
        totalBox.style.color = "";
        $("minWarn").classList.remove("show");
      }
    }

    function openCart(){
      $("cartOverlay").classList.add("show");
      $("cartOverlay").setAttribute("aria-hidden","false");
      refreshCartUI();
    }
    function closeCart(){
      $("cartOverlay").classList.remove("show");
      $("cartOverlay").setAttribute("aria-hidden","true");
    }

    /********************
     * ORDERS + CLIENT HISTORY
     ********************/
    function loadOrders(){
      try{
        const arr = JSON.parse(localStorage.getItem(STORAGE_ORDERS) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveOrders(arr){ localStorage.setItem(STORAGE_ORDERS, JSON.stringify(arr)); }

    function buildOrderPayload(){
      const keys = Object.keys(state.cart);
      if(!keys.length) return { ok:false, msg:"Panier vide." };

      const fee = shippingFee();
      if(fee === null) return { ok:false, msg:`Minimum commande ${state.settings.minOrder} dt.` };

      const name = $("cName").value.trim();
      const tel  = $("cTel").value.trim();
      const addr = $("cAddr").value.trim();
      const note = $("cNote").value.trim();

      if(!name || !tel) return { ok:false, msg:"Nom + T√©l√©phone obligatoires." };

      const items = keys.map(k => {
        const it = state.cart[k];
        return {
          code: it.code || "",
          name: it.name || "",
          price: Number(it.price)||0,
          qty: it.qty||0,
          lineTotal: (Number(it.price)||0) * (it.qty||0)
        };
      });

      const payload = {
        id: "ORD-" + Date.now(),
        createdAt: new Date().toISOString(),
        customer: { name, tel, addr, note },
        items,
        subTotal: cartTotal(),
        shippingFee: fee,
        total: grandTotal()
      };

      return { ok:true, payload };
    }

    function saveOrderOnly(){
      const r = buildOrderPayload();
      if(!r.ok){ alert(r.msg); return; }
      const orders = loadOrders();
      orders.unshift(r.payload);
      saveOrders(orders);
      alert("‚úÖ Commande enregistr√©e.");
    }

    function sendWhatsApp(){
      const r = buildOrderPayload();
      if(!r.ok){ alert(r.msg); return; }

      const wa = String(state.settings.whatsapp || "").replace(/\D/g,"");
      const o = r.payload;

      let msg = `üõí *Commande MAXI JDC MARKET*\n\n`;
      msg += `üë§ Nom: ${o.customer.name}\n`;
      msg += `üìû Tel: ${o.customer.tel}\n`;
      msg += `üìç Adresse: ${o.customer.addr || "-"}\n`;
      if(o.customer.note) msg += `üìù Note: ${o.customer.note}\n`;

      msg += `\n*Articles:*\n`;
      for(const it of o.items){
        msg += `‚Ä¢ ${it.qty} √ó ${it.name}`;
        if(it.code) msg += ` (Code: ${it.code})`;
        msg += ` ‚Äî ${fmtDT(it.lineTotal)}\n`;
      }

      msg += `\n‚ûï Sous-total: *${fmtDT(o.subTotal)}*`;
      msg += `\nüöö Livraison: *${fmtDT(o.shippingFee)}*`;
      msg += `\n‚úÖ *Total: ${fmtDT(o.total)}*`;

      const orders = loadOrders();
      orders.unshift(o);
      saveOrders(orders);

      window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`, "_blank");
      alert("‚úÖ WhatsApp pr√™t + commande enregistr√©e.");
    }

    /********************
     * ADMIN
     ********************/
    function openAdmin(){
      $("adminOverlay").classList.add("show");
      $("adminOverlay").setAttribute("aria-hidden","false");
      fillAdminSettings();
      refreshAdminTables();
    }
    function closeAdmin(){
      $("adminOverlay").classList.remove("show");
      $("adminOverlay").setAttribute("aria-hidden","true");
    }
    function fillAdminSettings(){
      $("waNumber").value = state.settings.whatsapp || "";
      $("minOrder").value = String(state.settings.minOrder ?? 15);
      $("freeShip").value = String(state.settings.freeShipping ?? 30);
      $("shipFeeAdmin").value = String(state.settings.shippingFee ?? 5);
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function refreshAdminTables(){
      const q = ($("adminSearch").value || "").toLowerCase().trim();
      const orders = loadOrders();

      const ot = $("ordersTable");
      ot.innerHTML = "";
      for(const o of orders.slice(0, 80)){
        const name = o.customer?.name || "";
        const tel = o.customer?.tel || "";
        if(q && !(name.toLowerCase().includes(q) || tel.toLowerCase().includes(q))) continue;

        const tr = document.createElement("tr");
        const d = new Date(o.createdAt);
        tr.innerHTML = `
          <td>${isNaN(d.getTime()) ? "-" : d.toLocaleString()}</td>
          <td>${escapeHtml(name)}<div class="tiny">${escapeHtml(tel)}</div></td>
          <td><b style="color:var(--text)">${fmtDT(o.total)}</b></td>
          <td class="tiny">${escapeHtml((o.items||[]).slice(0,3).map(x=>`${x.qty}√ó${x.name}`).join(" ¬∑ "))}${(o.items||[]).length>3?" ‚Ä¶":""}</td>
        `;
        ot.appendChild(tr);
      }

      const map = new Map();
      for(const o of orders){
        const tel = (o.customer?.tel || "").trim();
        if(!tel) continue;
        const key = tel;
        const prev = map.get(key) || { name:o.customer?.name||"", tel, count:0, total:0, addr:o.customer?.addr||"" };
        prev.count += 1;
        prev.total += Number(o.total)||0;
        if(o.customer?.name) prev.name = o.customer.name;
        if(o.customer?.addr) prev.addr = o.customer.addr;
        map.set(key, prev);
      }

      let clients = Array.from(map.values());
      if(q){
        clients = clients.filter(c =>
          (c.name||"").toLowerCase().includes(q) ||
          (c.tel||"").toLowerCase().includes(q)
        );
      }
      clients.sort((a,b)=> (b.total - a.total));

      const ct = $("clientsTable");
      ct.innerHTML = "";
      for(const c of clients.slice(0, 250)){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="color:var(--text); font-weight:900;">${escapeHtml(c.name||"-")}</td>
          <td>${escapeHtml(c.tel||"-")}</td>
          <td>${c.count}</td>
          <td><b style="color:var(--text)">${fmtDT(c.total)}</b></td>
          <td class="tiny">${escapeHtml(c.addr||"-")}</td>
        `;
        ct.appendChild(tr);
      }
    }

    /********************
     * LOAD DATA
     ********************/
    async function loadAll(){
      $("status").textContent = "Chargement‚Ä¶";
      for(const c of CATEGORIES){
        try{
          const r = await fetch(c.file, { cache:"no-store" });
          if(!r.ok) throw new Error("HTTP " + r.status);
          const text = await r.text();
          const items = parseProductsText(text);
          state.dataByCat.set(c.key, items);
        }catch(e){
          state.dataByCat.set(c.key, []);
          console.warn("Erreur CSV", c.file, e);
        }
      }
      $("status").textContent = "OK";
      buildCats();
      render();
    }

    /********************
     * EVENTS
     ********************/
    function wire(){
      $("waShow").textContent = formatWAShow(state.settings.whatsapp);

      $("q").addEventListener("input", () => {
        state.q = $("q").value;
        state.page = 1;
        render();
      });
      $("clearBtn").onclick = () => {
        $("q").value = "";
        state.q = "";
        state.page = 1;
        render();
      };

      $("globalBtn").onclick = () => {
        state.global = !state.global;
        state.activeCat = state.global ? null : state.activeCat;
        state.page = 1;
        $("globalBtn").classList.toggle("green", state.global);
        buildCats();
        render();
      };

      $("prevBtn").onclick = () => { state.page = Math.max(1, state.page - 1); render(); };
      $("nextBtn").onclick = () => { state.page = state.page + 1; render(); };

      $("cartTopBtn").onclick = openCart;
      $("cartCloseBtn").onclick = closeCart;
      $("cartOverlay").addEventListener("click", (e) => {
        if(e.target === $("cartOverlay")) closeCart();
      });

      $("clearCartBtn").onclick = clearCart;
      $("sendWhatsAppBtn").onclick = sendWhatsApp;
      $("saveOrderBtn").onclick = saveOrderOnly;

      document.addEventListener("keydown", (e) => {
        if(e.ctrlKey && e.shiftKey && (e.key === "A" || e.key === "a")){
          e.preventDefault();
          openAdmin();
        }
        if(e.key === "Escape"){
          closeCart();
          closeAdmin();
        }
      });

      $("adminCloseBtn").onclick = closeAdmin;
      $("adminOverlay").addEventListener("click", (e) => {
        if(e.target === $("adminOverlay")) closeAdmin();
      });

      $("adminSearch").addEventListener("input", refreshAdminTables);
      $("adminSearchClear").onclick = () => { $("adminSearch").value=""; refreshAdminTables(); };

      $("saveSettingsBtn").onclick = () => {
        state.settings.whatsapp = $("waNumber").value.trim() || DEFAULT_SETTINGS.whatsapp;
        state.settings.minOrder = Number(($("minOrder").value || "").replace(",",".")) || DEFAULT_SETTINGS.minOrder;
        state.settings.freeShipping = Number(($("freeShip").value || "").replace(",",".")) || DEFAULT_SETTINGS.freeShipping;
        state.settings.shippingFee = Number(($("shipFeeAdmin").value || "").replace(",",".")) || DEFAULT_SETTINGS.shippingFee;
        saveSettings();
        refreshCartUI();
        refreshAdminTables();
        alert("‚úÖ Param√®tres enregistr√©s.");
      };

      $("resetSettingsBtn").onclick = () => {
        state.settings = Object.assign({}, DEFAULT_SETTINGS);
        saveSettings();
        fillAdminSettings();
        refreshCartUI();
        refreshAdminTables();
      };

      $("exportBtn").onclick = () => {
        const orders = loadOrders();
        const blob = new Blob([JSON.stringify(orders, null, 2)], { type:"application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "maxi-jdc-orders.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
      };

      $("clearHistoryBtn").onclick = () => {
        if(!confirm("Tu es s√ªr ? Cela supprime tout l‚Äôhistorique sur ce navigateur.")) return;
        localStorage.removeItem(STORAGE_ORDERS);
        refreshAdminTables();
        alert("‚úÖ Historique supprim√©.");
      };

      if(location.hash && location.hash.toLowerCase() === "#admin"){
        openAdmin();
      }
    }

    function init(){
      wire();
      buildCats();
      refreshCartUI();
      loadAll();
    }
    init();
  </script>
</body>
</html>
