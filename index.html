<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes"/>
  <title>MAXI JDC MARKET ‚Äî Commande</title>

  <style>
    :root{
      --bg0:#0a1929;
      --bg1:#112240;
      --card:#1a365d;
      --card2:#162447;
      --line:rgba(255,255,255,.15);
      --text:#f0f6fc;
      --muted:#8b949e;
      --accent:#00ff88;
      --accent2:#00d4ff;
      --danger:#ff6b6b;
      --shadow: 0 10px 40px rgba(0,0,0,.5);
      --radius:12px;
      --drawerW: 100vw;
    }
    *{box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent;}
    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 100%);
      min-height:100vh;
      line-height:1.6;
      overflow-x:hidden;
      touch-action: manipulation;
    }
    .wrap{
      max-width:100%;
      margin:0 auto;
      padding:8px 8px 70px;
      transition: transform .3s ease;
    }
    body.drawer-open .wrap{ transform: translateX(-20vw); }

    .top{
      background: rgba(10, 25, 47, 0.95);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 8px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 5px;
      z-index: 100;
      backdrop-filter: blur(10px);
      margin-bottom: 8px;
    }
    .topRow{
      display:flex;
      flex-direction: column;
      gap:8px;
      align-items:stretch;
    }
    .brand{
      display:flex;
      gap:6px;
      align-items:center;
      min-width:0;
    }
    .logo{
      width:36px;
      height:36px;
      border-radius:6px;
      border:2px solid var(--accent);
      overflow:hidden;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      background:#0a1929;
      padding: 1px;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .brandText h1{
      margin:0;
      font-size:14px;
      font-weight:700;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }
    .brandText p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:9px;
    }

    /* RECHERCHE + PANIER C√îTE √Ä C√îTE */
    .search-row {
      display: flex;
      gap: 6px;
      align-items: center;
      width: 100%;
    }
    .search{
      flex: 1 1 auto;
      display:flex;
      gap:3px;
      align-items:center;
      min-width: 0;
    }
    .search input{
      flex:1;
      height:32px;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:0 8px;
      outline:none;
      font-size:12px;
      min-width: 0;
      width: 100%;
    }
    .search input:focus{ border-color: var(--accent); background: rgba(255,255,255,.12); }
    .btn{
      height:32px;
      padding:0 8px;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.1);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:10px;
      transition: all 0.2s ease;
      white-space:nowrap;
      min-width: 55px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn:hover{ background: rgba(255,255,255,.15); border-color: var(--accent); }
    .btn.green{ background: rgba(0, 255, 136, 0.15); border-color: var(--accent); color: var(--accent); }
    .btn.green:hover{ background: rgba(0, 255, 136, 0.25); }

    /* Bouton panier dans la ligne recherche */
    #cartTopBtn {
      height: 32px;
      padding: 0 12px;
      border-radius:6px;
      border:1px solid var(--accent);
      background: rgba(0, 255, 136, 0.1);
      color: var(--accent);
      cursor: pointer;
      font-weight: 900;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      min-width: 85px;
      flex-shrink: 0;
    }
    #cartTopBtn:hover {
      background: rgba(0, 255, 136, 0.2);
    }
    #cartTopCount {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--accent);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 900;
    }

    .pills{
      margin-top:6px;
      display:flex;
      gap:3px;
      align-items:center;
      flex-wrap:wrap;
      padding:4px 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .pill{
      display:inline-flex;
      gap:3px;
      align-items:center;
      padding:3px 6px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size:8px;
      white-space:nowrap;
      flex-shrink: 0;
    }
    .pill strong{font-weight:800; color:var(--accent);}
    
    .qrPill{
      margin-left:auto;
      border:1px solid var(--accent2);
      background:rgba(0, 212, 255, 0.1);
      color:var(--accent2);
      font-weight:800;
      display:flex;
      align-items:center;
      gap:3px;
      flex-shrink: 0;
    }

    /* CAT√âGORIES HORIZONTALES */
    .catsHorizontal {
      margin-top: 8px;
      padding: 6px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow-x: auto;
      display: flex;
      gap: 4px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .catsHorizontal::-webkit-scrollbar { display: none; }
    
    .catBtnHoriz {
      flex: 0 0 auto;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-size: 10px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 3px;
      min-height: 28px;
    }
    .catBtnHoriz:hover { background: rgba(255,255,255,.1); border-color: var(--accent2); }
    .catBtnHoriz.active {
      border-color: var(--accent);
      background: rgba(0, 255, 136, 0.15);
      color: var(--accent);
    }
    .catCountHoriz {
      font-size: 8px;
      padding: 1px 3px;
      border-radius: 999px;
      background: rgba(0,0,0,.3);
      border: 1px solid rgba(255,255,255,.1);
    }

    .grid{
      margin-top:8px;
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      align-items:start;
    }
    .panel{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      flex-wrap: wrap;
    }
    .panelHeader h3{ margin:0; font-size:12px; font-weight:800; color:var(--accent); }
    .panelHeader .sub{
      color:var(--muted);
      font-size:8px;
      background: rgba(255,255,255,.05);
      padding: 1px 4px;
      border-radius: 999px;
      white-space: nowrap;
    }

    #cats{ display:none; }

    .content{padding:10px;}
    .contentHeader{
      display:flex;
      flex-direction: column;
      gap: 6px;
      padding:0 0 8px 0;
      border-bottom: 1px solid var(--line);
      margin-bottom: 8px;
    }
    .contentHeader h2{ margin:0; font-size:14px; font-weight:900; }
    .contentHeader .meta{ margin:2px 0 0; color:var(--muted); font-size:9px; }
    
    /* PAGER EN HAUT */
    .pager{
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      font-size:9px;
      white-space:nowrap;
    }
    .iconBtn{
      width:28px;
      height:28px;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      color:var(--text);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.15); border-color: var(--accent); }

    /* PAGINATION EN BAS */
    .pagination-bottom {
      margin-top: 12px;
      padding: 8px 0;
      border-top: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
      justify-content: center;
    }
    .page-numbers {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 100%;
      overflow-x: auto;
      padding: 3px;
    }
    .page-btn {
      min-width: 30px;
      height: 30px;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .page-btn:hover:not(.active) {
      background: rgba(255,255,255,.12);
      border-color: var(--accent2);
    }
    .page-btn.active {
      background: rgba(0, 255, 136, 0.15);
      border-color: var(--accent);
      color: var(--accent);
    }
    .page-btn.dots {
      background: transparent;
      border-color: transparent;
      cursor: default;
    }
    .page-info-bottom {
      color: var(--muted);
      font-size: 10px;
      text-align: center;
    }

    /* ==== MODIFICATIONS IMPORTANTES ==== */
    /* PRODUITS - 2 COLONNES SUR MOBILE, 3 SUR TABLETTE, 4 SUR DESKTOP */
    #products{
      display:grid;
      grid-template-columns:repeat(2, 1fr); /* 2 colonnes sur mobile */
      gap:8px;
    }

    .card{
      border-radius:8px;
      border:1px solid var(--line);
      background: var(--card2);
      padding:6px; /* R√©duit de 8px */
      box-shadow:0 3px 10px rgba(0,0,0,.25);
      transition: all 0.2s ease;
      display:flex;
      flex-direction:column;
      gap:5px; /* R√©duit de 6px */
      height: 100%;
    }
    .card:hover{ border-color: var(--accent2); transform: translateY(-2px); }

    /* PHOTO PLUS PETITE POUR OPTIMISER L'ESPACE */
    .imgWrap{
      width:100%;
      height:70px; /* R√©duit de 90px √† 70px */
      border-radius:6px;
      border:1px solid rgba(255,255,255,.12);
      background: #ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      padding: 2px;
    }
    .product-img{
      max-width:95%;
      max-height:95%;
      width:auto;
      height:auto;
      object-fit:contain;
      display:block;
    }
    .noPhoto{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#666666;
      font-weight:800;
      font-size:7px; /* R√©duit */
      background: #f8f8f8;
      text-align:center;
      padding:2px;
    }

    /* CONTENU DE LA CARTE OPTIMIS√â */
    .card-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-height: 0;
    }
    
    .card-top {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-height: 0;
    }
    
    .card-bottom {
      margin-top: auto;
    }

    .namePrice{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:3px;
      min-width:0;
    }
    .name{
      font-weight:900;
      font-size:10px; /* R√©duit de 11px */
      line-height:1.2;
      min-width:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      flex: 1;
    }
    .price{
      flex:0 0 auto;
      font-weight:900;
      padding:2px 4px; /* R√©duit */
      border-radius:999px;
      border:1px solid var(--accent);
      background: rgba(0, 255, 136, 0.1);
      color:var(--accent);
      font-size:8px; /* R√©duit de 9px */
      white-space:nowrap;
    }
    .meta2{
      color:var(--muted);
      font-size:7px; /* R√©duit de 8px */
      display:flex;
      flex-direction:column;
      gap:1px;
    }

    /* ACTIONS: DISPOSITION COMPACTE */
    .actions{
      margin-top:2px; /* R√©duit */
      display:flex;
      align-items:center;
      gap:3px; /* R√©duit de 4px */
      width:100%;
      min-height: 22px; /* R√©duit de 26px */
    }
    
    /* STEPPER PLUS PETIT */
    .stepper{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:2px;
      padding:1px 2px; /* R√©duit */
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.2);
      min-width: 0;
      width: 60px; /* R√©duit de 65px */
      flex-shrink: 0;
    }
    .stepper button{
      width:16px;
      height:16px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.1);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all 0.15s ease;
      flex:0 0 auto;
    }
    .stepper button:hover{ border-color: var(--accent); background: rgba(255,255,255,.2); }
    .stepper span{ 
      min-width:12px;
      text-align:center; 
      font-weight:900; 
      color:var(--text); 
      font-size:9px;
    }

    /* BOUTON STOCK PLUS PETIT */
    .stockBtn{
      height:20px; /* R√©duit de 22px */
      border-radius:4px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:6px; /* R√©duit de 7px */
      display:flex;
      align-items:center;
      justify-content:center;
      gap:2px;
      transition: all .15s ease;
      padding: 0 4px; /* R√©duit */
      flex: 1;
      min-width: 0;
      max-width: 65px; /* R√©duit de 75px */
    }
    .stockBtn:hover{ border-color: var(--accent2); background: rgba(255,255,255,.05); }
    .stockTag{
      padding:1px 3px;
      border-radius:999px;
      font-size:6px;
      border:1px solid rgba(255,255,255,.1);
      background: rgba(0,0,0,.15);
      color: rgba(255,255,255,.9);
      font-weight:700;
      min-width: 30px; /* R√©duit de 32px */
      text-align: center;
    }
    .stockTag.ok{ border-color: rgba(0,255,136,.3); color: var(--accent); background: rgba(0,255,136,.08); }
    .stockTag.no{ border-color: rgba(255,107,107,.4); color: var(--danger); background: rgba(255,107,107,.08); }

    /* BOUTON AJOUTER PLUS PETIT */
    .addBtn{
      height:20px; /* R√©duit de 22px */
      padding:0 6px; /* R√©duit de 7px */
      border-radius:999px;
      border:1px solid var(--accent);
      background: rgba(0, 255, 136, 0.1);
      color:var(--accent);
      cursor:pointer;
      font-weight:900;
      font-size:7px; /* R√©duit de 8px */
      display:flex;
      align-items:center;
      justify-content:center;
      gap:2px; /* R√©duit */
      white-space:nowrap;
      transition: all 0.15s ease;
      min-width: 0;
      flex-shrink: 0;
    }
    .addBtn:hover{ background: rgba(0, 255, 136, 0.22); }
    .addBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: var(--muted);
    }

    .hintAdmin{
      margin-top:6px;
      padding:5px;
      border-radius:4px;
      border:1px solid rgba(0,255,136,0.2);
      background: rgba(0,255,136,0.05);
      color: var(--muted);
      font-size:8px;
      text-align:center;
    }

    /* DRAWER + BACKDROP */
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.7);
      opacity:0;
      pointer-events:none;
      transition: opacity .3s ease;
      z-index:19;
    }
    .backdrop.open{ opacity:1; pointer-events:auto; }

    .drawer{
      position:fixed;
      top:0;
      right:0;
      height:100%;
      width:100vw;
      max-width:100vw;
      background: rgba(10, 25, 47, 0.98);
      border-left:2px solid var(--accent);
      box-shadow:-20px 0 60px rgba(0,0,0,.7);
      transform: translateX(100%);
      transition: transform .3s ease;
      z-index:20;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(18px);
      overflow: hidden;
    }
    .drawer.open{ transform: translateX(0); }

    .drawerHeader{
      padding:10px;
      border-bottom:2px solid var(--accent);
      background: rgba(0, 255, 136, 0.05);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:5px;
      flex-shrink: 0;
    }
    .drawerHeader h3{
      margin:0;
      font-size:14px;
      color: var(--accent);
      display:flex;
      gap:4px;
      align-items:center;
      font-weight:900;
    }

    .drawerBody{
      flex:1;
      overflow-y:auto;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      -webkit-overflow-scrolling: touch;
    }
    .section{
      border:1px solid var(--line);
      background: var(--card2);
      border-radius:8px;
      padding:8px;
    }
    .section h4{
      margin:0 0 5px;
      font-size:11px;
      color:var(--accent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      font-weight:900;
    }
    .row2{
      display:grid;
      grid-template-columns:1fr;
      gap:6px;
    }
    .field label{
      display:block;
      font-size:8px;
      color:var(--muted);
      margin-bottom:3px;
      font-weight:800;
    }
    .field input, .field textarea{
      width:100%;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:6px;
      outline:none;
      font-size:11px;
      transition: all 0.15s ease;
    }
    .field input:focus, .field textarea:focus{ border-color: var(--accent); background: rgba(255,255,255,.12); }
    .field textarea{ min-height:45px; resize:vertical; }
    .miniBtns{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
      margin-top:5px;
      align-items:center;
    }
    .mini{
      height:30px;
      padding:0 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.1);
      color: var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:9px;
      transition: all 0.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex: 1;
      min-width: 0;
    }
    .mini:hover{ background: rgba(255,255,255,.2); }
    .mini.green{ background: rgba(0, 255, 136, 0.15); border-color: var(--accent); color:var(--accent); }
    .mini.green:hover{ background: rgba(0, 255, 136, 0.28); }
    .mini.danger{ background: rgba(255, 107, 107, 0.15); border-color: var(--danger); color:var(--danger); }
    .mini.danger:hover{ background: rgba(255, 107, 107, 0.28); }

    .pinRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      margin-top:5px;
      padding-top:5px;
      border-top:1px dashed var(--line);
      color:var(--muted);
      font-size:8px;
    }
    .pinRow label{
      display:flex;
      gap:3px;
      align-items:center;
      cursor:pointer;
      flex: 1;
    }

    .cartList{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:4px;
    }
    .cartItem{
      border:1px solid var(--line);
      background: rgba(0,0,0,.2);
      border-radius:8px;
      padding:5px;
      display:flex;
      gap:5px;
      align-items:center;
      justify-content:space-between;
    }
    .cartItem .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:1px;
      flex:1;
    }
    .cartItem .left .t{
      font-weight:900;
      font-size:9px;
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .cartItem .left .s{
      color:var(--muted);
      font-size:7px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cartItem .right{
      display:flex;
      align-items:center;
      gap:4px;
      flex:0 0 auto;
    }
    .lineTotal{
      font-weight:900;
      white-space:nowrap;
      font-size:9px;
      color:var(--accent);
      min-width: 50px;
      text-align:right;
    }

    .totals{
      margin-top:5px;
      border-top:1px solid var(--line);
      padding-top:5px;
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:10px;
    }
    .totals .trow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
    }
    .totals .trow span{
      color:var(--muted);
    }
    .totals .trow strong{
      font-weight:900;
      color:var(--text);
    }

    .warn{
      margin-top:4px;
      padding:5px;
      border-radius:4px;
      border:1px dashed var(--line);
      background: rgba(0,0,0,.2);
      color:var(--muted);
      font-size:8px;
      line-height:1.3;
    }
    .warn.bad{
      border-color: rgba(255,107,107,.45);
      color:#ffb8b8;
      background: rgba(255,107,107,.12);
    }
    .warn.good{
      border-color: rgba(0,255,136,.45);
      color:#b8ffd9;
      background: rgba(0,255,136,.10);
    }

    .drawerFooter{
      padding:8px 10px;
      border-top:1px solid var(--line);
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:space-between;
      background: var(--card);
      flex-shrink:0;
    }

    /* Historique */
    .histToggle{
      width:100%;
      height:32px;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 6px;
      transition: all 0.15s ease;
      margin-top:4px;
      font-size:10px;
    }
    .histToggle:hover{ background: rgba(255,255,255,.14); }
    .histBox{
      margin-top:4px;
      display:none;
      border:1px solid var(--line);
      background: rgba(0,0,0,.2);
      border-radius:8px;
      padding:5px;
      max-height: 140px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .histBox.open{ display:block; }
    table{ width:100%; border-collapse:collapse; font-size:8px; }
    th,td{ padding:3px 2px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left; }
    th{ color:var(--muted); font-weight:900; font-size:7px; }
    td strong{ font-weight:900; color:var(--accent); }

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:30;
      padding:10px;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width:100%;
      max-width:95vw;
      border-radius:var(--radius);
      border:1px solid var(--accent);
      background: rgba(10, 25, 47, 0.98);
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .modalHead{
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      border-bottom:1px solid var(--accent);
      background: rgba(0, 255, 136, 0.05);
      flex-shrink: 0;
    }
    .modalHead h3{
      margin:0;
      font-size:12px;
      color:var(--accent);
      font-weight:900;
    }
    .modalBody{
      padding:8px;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalBody textarea{
      width:100%;
      min-height:140px;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:6px;
      outline:none;
      font-size:10px;
      line-height:1.5;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      resize: vertical;
    }
    .modalFoot{
      padding:8px;
      border-top:1px solid var(--line);
      display:flex;
      gap:4px;
      justify-content:flex-end;
      flex-wrap:wrap;
      flex-shrink: 0;
    }

    /* QR Code Modal */
    .qrModal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:30;
      padding:10px;
    }
    .qrModal.open{ display:flex; }
    .qrBox{
      background: var(--card);
      border-radius:var(--radius);
      border:1px solid var(--accent);
      padding:12px;
      max-width:300px;
      width:90vw;
      text-align:center;
      box-shadow: var(--shadow);
    }
    .qrBox h3{
      margin:0 0 6px;
      color:var(--accent);
      font-size:14px;
      font-weight:900;
    }
    .qrImage{
      width:100%;
      max-width:180px;
      border-radius:8px;
      border:1px solid var(--accent2);
      margin:0 auto 6px;
      display:block;
    }
    .qrInfo{
      color:var(--muted);
      font-size:10px;
      margin:6px 0;
      line-height:1.5;
    }

    /* ==== RESPONSIVE - Plus de colonnes sur √©crans plus grands ==== */
    @media (min-width: 480px){
      .wrap{padding:8px 8px 70px;}
      .top{padding: 10px;}
      .topRow{flex-direction: row; align-items: center;}
      .search-row{flex: 1;}
      #products{grid-template-columns:repeat(3, 1fr);} /* 3 colonnes sur tablette */
      .imgWrap{height: 75px;} /* L√©g√®rement plus grand */
      .row2{grid-template-columns:1fr 1fr;}
      .drawer{width: 90vw;}
      body.drawer-open .wrap{transform: translateX(-10vw);}
    }
    
    @media (min-width: 768px){
      html{font-size:13px;}
      .wrap{
        max-width: 1240px;
        padding: 12px 12px 40px;
        transition: padding-right .25s ease;
      }
      body.drawer-open .wrap{
        padding-right: calc(380px + 12px);
        transform: none;
      }
      .topRow{flex-direction: row; align-items: center;}
      .search-row{flex: 1;}
      .search input{min-width: 200px;}
      .pills{flex-wrap: nowrap;}
      .pill{font-size: 10px;}
      #products{grid-template-columns:repeat(4, 1fr);} /* 4 colonnes sur desktop */
      .imgWrap{height: 85px;}
      .card{padding:8px;} /* Un peu plus d'espace sur desktop */
      .name{font-size:11px;} /* Texte l√©g√®rement plus grand */
      .price{font-size:9px;}
      .drawer{width: var(--drawerW);}
      .drawer.open{transform: translateX(0);}
    }

    @media (min-width: 1024px){
      #products{grid-template-columns:repeat(5, 1fr);} /* 5 colonnes sur grand √©cran */
      .imgWrap{height: 90px;}
    }

    /* Pour iOS: √©viter le zoom sur les inputs */
    input, textarea, select {
      font-size: 16px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="topRow">
        <div class="brand">
          <div class="logo">
            <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET" onerror="this.style.display='none'">
          </div>
          <div class="brandText">
            <h1>MAXI JDC MARKET</h1>
            <p>Des prix mini ‚Äî Un MAXI choix</p>
          </div>
        </div>

        <!-- Ligne avec recherche + panier -->
        <div class="search-row">
          <div class="search">
            <input id="q" type="text" placeholder="üîç Rechercher..." />
            <button class="btn" id="clearBtn">Effacer</button>
            <button class="btn green" id="globalBtn">Tous</button>
          </div>
          <!-- Bouton panier unique -->
          <button class="btn" id="cartTopBtn" title="Panier">
            üõí Panier <span id="cartTopCount">0</span>
          </button>
        </div>
      </div>

      <div class="pills">
        <div class="pill">üìç Jardins de Carthage</div>
        <div class="pill">üïí 7h ‚Äì 1h</div>
        <div class="pill"><strong>WhatsApp:</strong> 00216 25 600 978</div>
        
        <div class="pill qrPill" id="qrBtn" title="Scanner le QR Code">
          üì± QR Code
        </div>
      </div>

      <!-- CAT√âGORIES HORIZONTALES -->
      <div class="catsHorizontal" id="catsHorizontal"></div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="content">
          <div class="contentHeader">
            <div class="titleWrap">
              <h2 id="activeLabel">Produits</h2>
              <div class="meta" id="activeMeta">S√©lectionne une cat√©gorie</div>
            </div>

            <!-- PAGINATION EN HAUT -->
            <div class="pager">
              <button class="iconBtn" id="prevBtn" title="Pr√©c√©dent">‚Äπ</button>
              <span id="pageInfo">Page 1/1</span>
              <button class="iconBtn" id="nextBtn" title="Suivant">‚Ä∫</button>
              <span id="countInfo">0 article(s)</span>
            </div>
          </div>

          <div id="products"></div>

          <!-- PAGINATION EN BAS -->
          <div class="pagination-bottom" id="paginationBottom" style="display: none;">
            <div class="page-info-bottom" id="pageInfoBottom">Page 1 sur 1</div>
            <div class="pagination-controls">
              <button class="page-btn" id="prevBottomBtn" title="Page pr√©c√©dente">‚Äπ Pr√©c√©dent</button>
              <div class="page-numbers" id="pageNumbers"></div>
              <button class="page-btn" id="nextBottomBtn" title="Page suivante">Suivant ‚Ä∫</button>
            </div>
          </div>

          <div class="hintAdmin">Astuce : cliquez sur le panier pour l'ouvrir.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div class="backdrop" id="backdrop" aria-hidden="true"></div>

  <!-- Drawer -->
  <aside class="drawer" id="drawer" aria-label="Panier">
    <div class="drawerHeader">
      <h3>üõí Panier & Fiche client</h3>
      <button class="btn" id="closeDrawer">Fermer</button>
    </div>

    <div class="drawerBody">
      <!-- Fiche client -->
      <div class="section" id="clientBox">
        <h4>
          <span>üë§ Fiche client (1 seule fois)</span>
          <span class="sub" id="clientLockTxt"></span>
        </h4>

        <div class="row2">
          <div class="field"><label>Nom</label><input id="cName" placeholder="Ex: Lotfi" /></div>
          <div class="field"><label>T√©l√©phone</label><input id="cTel" placeholder="Ex: 55xxxxxx" /></div>
        </div>

        <div class="field" style="margin-top:6px">
          <label>Adresse</label>
          <textarea id="cAddr" placeholder="Quartier, rue, rep√®re‚Ä¶"></textarea>
        </div>

        <div class="row2" style="margin-top:6px">
          <div class="field"><label>GPS (lat)</label><input id="cLat" placeholder="ex: 36.85" /></div>
          <div class="field"><label>GPS (lng)</label><input id="cLng" placeholder="ex: 10.30" /></div>
        </div>

        <div class="miniBtns">
          <button class="mini" id="gpsBtn">üìç Obtenir adresse GPS</button>
          <button class="mini green" id="saveClientBtn">Enregistrer</button>
          <button class="mini" id="editClientBtn">Modifier</button>
        </div>

        <div class="warn" style="margin-top:8px">
          ‚úÖ La fiche est enregistr√©e sur <b>cet appareil</b>.<br/>
          üîÅ Pour l'utiliser sur un autre appareil, utilisez "Code client".
        </div>

        <div class="field" style="margin-top:6px">
          <label>Code client (pour ouvrir sur un autre appareil)</label>
          <input id="clientCode" placeholder="(g√©n√©r√© apr√®s Enregistrer)" readonly />
        </div>

        <div class="miniBtns">
          <button class="mini" id="genCodeBtn">üîë G√©n√©rer code</button>
          <button class="mini" id="importCodeBtn">üì• Importer code</button>
        </div>

        <div class="pinRow">
          <label style="display:flex;gap:4px;align-items:center;cursor:pointer">
            <input type="checkbox" id="pinCart"> √âpingler le panier (laisser ouvert)
          </label>
          <span>üí° Pratique pour voir le total.</span>
        </div>
      </div>

      <!-- Panier -->
      <div class="section">
        <h4><span>üß∫ Articles</span><span class="sub" id="cartMiniInfo">0 article(s)</span></h4>
        <div class="cartList" id="cartList"></div>

        <div class="totals">
          <div class="trow"><span>Sous-total</span><strong id="subTotal">0,00 dt</strong></div>
          <div class="trow"><span>Frais livraison</span><strong id="shipFee">0,00 dt</strong></div>
          <div class="trow"><span>Total</span><strong id="cartTotal">0,00 dt</strong></div>
        </div>

        <!-- Informations mises √† jour -->
        <div class="warn" id="ruleBox" style="margin-top:6px">
          <div style="display:flex; flex-direction:column; gap:3px;">
            <div><strong>üìã Conditions de livraison :</strong></div>
            <div>‚Ä¢ Minimum commande: <strong>15 dt</strong></div>
            <div>‚Ä¢ Frais de livraison: <strong>3 dt</strong></div>
            <div>‚Ä¢ Livraison gratuite √† partir de <strong>30 dt</strong></div>
          </div>
        </div>

        <button class="histToggle" id="histToggleBtn">
          <span>üßæ Historique client</span><span id="histCount">0</span>
        </button>

        <div class="histBox" id="histBox">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px">
            <div style="color:var(--muted);font-size:10px">Derni√®res commandes (sur cet appareil)</div>
            <button class="mini danger" id="clearMyHistoryBtn">Effacer</button>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>Date</th><th>Total</th><th>Articles</th></tr></thead>
              <tbody id="histTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="drawerFooter">
      <button class="mini danger" id="clearCartBtn">Vider panier</button>
      <button class="mini green" id="sendBtn">üöÄ Envoyer</button>
    </div>
  </aside>

  <!-- Modal R√©sum√© Commande -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>‚úÖ Commande ‚Äî R√©sum√©</h3>
        <button class="btn" id="closeModal">Fermer</button>
      </div>
      <div class="modalBody"><textarea id="orderText" readonly></textarea></div>
      <div class="modalFoot">
        <button class="mini" id="copyBtn">üìã Copier</button>
        <button class="mini" id="downloadBtn">üíæ T√©l√©charger (.txt)</button>
        <button class="mini green" id="whatsappBtn">üì± WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- Modal QR Code -->
  <div class="qrModal" id="qrModal">
    <div class="qrBox">
      <h3>üì± QR Code du Site</h3>
      <img src="qr-maxi-jdc-site.jpg" alt="QR Code MAXI JDC MARKET" class="qrImage" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x300/0a1929/00ff88?text=QR+Code+Non+Trouv√©'">
      <div class="qrInfo">
        Scannez ce QR Code pour acc√©der au site MAXI JDC MARKET sur votre t√©l√©phone.<br>
        Partagez-le avec vos clients pour faciliter les commandes !
      </div>
      <button class="btn green" id="closeQrBtn">Fermer</button>
    </div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const MIN_ORDER = 15;
const FREE_SHIPPING = 30;
const SHIPPING_FEE = 3;
const WHATSAPP_NUMBER = "21625600978";

/* Cat√©gories */
const CATEGORIES = [
  { key:"animaux_compagnie", label:"Animaux de Compagnie", file:"data/animaux_compagnie.csv" },
  { key:"bebe_maman", label:"B√©b√© et Maman", file:"data/bebe_maman.csv" },
  { key:"boulangerie_patisserie", label:"Boulangerie & P√¢tisserie", file:"data/boulangerie_patisserie.csv" },
  { key:"cafe", label:"Caf√©", file:"data/cafe.csv" },
  { key:"chips_snacks", label:"Chips et Snacks", file:"data/chips_snacks.csv" },
  { key:"chocolats_biscuits", label:"Chocolats et Biscuits", file:"data/chocolats_biscuits.csv" },
  { key:"conserves", label:"Conserves", file:"data/conserves.csv" },
  { key:"cuisine_monde", label:"Cuisine du Monde", file:"data/cuisine_monde.csv" },
  { key:"eaux", label:"Eaux", file:"data/eaux.csv" },
  { key:"epicerie_salee", label:"√âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
  { key:"epicerie_sucree", label:"√âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
  { key:"fromage_charcuterie", label:"Fromage & Charcuterie", file:"data/fromage_charcuterie.csv" },
  { key:"fruits_legumes", label:"Fruits et L√©gumes", file:"data/fruits_legumes.csv" },
  { key:"fruits_secs_noix", label:"Fruits Secs et Noix", file:"data/fruits_secs_noix.csv" },
  { key:"hygiene_entretien", label:"Hygi√®ne et Entretien", file:"data/hygiene_entretien.csv" },
  { key:"hygiene_soins", label:"Hygi√®ne & Soins", file:"data/hygiene_soins.csv" },
  { key:"jus_boissons", label:"Jus & Boissons", file:"data/jus_boissons.csv" },
  { key:"lait_oeufs_produits_frais", label:"Lait, ≈íufs & Produits frais", file:"data/lait_oeufs_produits_frais.csv" },
  { key:"pates", label:"P√¢tes", file:"data/pates.csv" },
  { key:"produits_surgeles", label:"Produits Surgel√©s", file:"data/produits_surgeles.csv" },
  { key:"vipa_selections", label:"VIPA S√©lections", file:"data/vipa_selections.csv" }
];

/* ===================== HELPERS ===================== */
const $ = (id)=>document.getElementById(id);
const fmtDT = (n)=>Number(n||0).toFixed(2).replace(".", ",") + " dt";
function safeKey(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^\w\-]+/g,""); }
function dlText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
function encodeB64(str){
  return btoa(unescape(encodeURIComponent(str)));
}
function decodeB64(b64){
  return decodeURIComponent(escape(atob(b64)));
}

/* ===================== STATE ===================== */
const state = {
  dataByCat: new Map(),
  activeCat: "cafe",
  global:false,
  q:"",
  page:1,
  perPage:24, // Augment√© car plus de produits visibles avec 2 colonnes
  qtyPick:{},
  cart:{},
  client:null,
  pinCart:false,
  stockByCode:{},
  autoOpenOnAdd: false,
};

/* ===================== STORAGE ===================== */
function loadLocal(){
  try{ state.cart = JSON.parse(localStorage.getItem("maxi_cart_v2")||"{}") || {}; }catch(e){ state.cart = {}; }
  try{ const c = JSON.parse(localStorage.getItem("maxi_client_v2")||"null"); if(c) state.client = c; }catch(e){}
  try{ state.pinCart = localStorage.getItem("maxi_pin_cart_v2")==="1"; }catch(e){}
  try{ state.stockByCode = JSON.parse(localStorage.getItem("maxi_stock_v2")||"{}") || {}; }catch(e){ state.stockByCode = {}; }
}
function saveCart(){ localStorage.setItem("maxi_cart_v2", JSON.stringify(state.cart)); }
function saveClient(){ localStorage.setItem("maxi_client_v2", JSON.stringify(state.client||null)); }
function savePin(){ localStorage.setItem("maxi_pin_cart_v2", state.pinCart ? "1":"0"); }
function saveStock(){ localStorage.setItem("maxi_stock_v2", JSON.stringify(state.stockByCode||{})); }

function loadHistory(){ try{ return JSON.parse(localStorage.getItem("maxi_orders_v2")||"[]"); }catch(e){ return []; } }
function saveHistory(arr){ localStorage.setItem("maxi_orders_v2", JSON.stringify(arr||[])); }

/* ===================== CSV PARSER ===================== */
function parseCSV(text){
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows = [];
  for(const line0 of lines){
    const line = line0.trim();
    if(!line) continue;
    if(line.includes("CODE_ARTICLE") && line.includes("PRIX")) continue;
    if(line.startsWith(";") || line.startsWith("//")) continue;

    let parts = line.split("\t");
    if(parts.length < 3) parts = line.split(";");
    parts = parts.map(p => String(p||"").trim());

    if(parts.length >= 3){
      const code = parts[0];
      const name = parts[1];
      let priceRaw = parts[2];
      priceRaw = priceRaw.replace(",", ".").replace(/[^0-9.]/g,"");
      const price = Number(priceRaw) || 0;

      if(code && name && price > 0){
        rows.push({ code: String(code).trim(), name: String(name).trim(), price });
      }
    }
  }
  return rows;
}

/* ===================== CART CALC ===================== */
function cartCount(){ return Object.values(state.cart).reduce((a,it)=>a + (it.qty||0), 0); }
function cartTotal(){ return Object.values(state.cart).reduce((a,it)=>a + (Number(it.price)||0) * (it.qty||0), 0); }
function shippingFee(){
  const total = cartTotal();
  if(total < MIN_ORDER) return null;
  if(total >= FREE_SHIPPING) return 0;
  return SHIPPING_FEE;
}
function grandTotal(){
  const fee = shippingFee();
  if(fee === null) return null;
  return cartTotal() + fee;
}

/* ===================== DRAWER BEHAVIOR ===================== */
function openDrawer(){
  $("drawer").classList.add("open");
  $("backdrop").classList.add("open");
  document.body.classList.add("drawer-open");
}
function closeDrawer(force=false){
  if(state.pinCart && !force) return;
  $("drawer").classList.remove("open");
  $("backdrop").classList.remove("open");
  document.body.classList.remove("drawer-open");
}

/* ===================== CAT√âGORIES HORIZONTALES ===================== */
function buildCatsHorizontal(){
  const box = $("catsHorizontal");
  box.innerHTML = "";
  
  // Bouton "Tous"
  const allBtn = document.createElement("button");
  allBtn.className = "catBtnHoriz" + (state.global ? " active" : "");
  allBtn.onclick = ()=>{
    state.global = true;
    state.activeCat = null;
    state.page = 1;
    render();
  };
  const allCount = CATEGORIES.reduce((sum, c)=>sum + (state.dataByCat.get(c.key)||[]).length, 0);
  allBtn.innerHTML = `üåê Tous <span class="catCountHoriz">${allCount}</span>`;
  box.appendChild(allBtn);
  
  // Cat√©gories
  for(const c of CATEGORIES){
    const btn = document.createElement("button");
    btn.className = "catBtnHoriz" + (!state.global && state.activeCat===c.key ? " active" : "");
    btn.onclick = ()=>{
      state.activeCat = c.key;
      state.global = false;
      state.page = 1;
      render();
    };
    const items = state.dataByCat.get(c.key) || [];
    btn.innerHTML = `${c.label} <span class="catCountHoriz">${items.length}</span>`;
    box.appendChild(btn);
  }
}

function getActiveCat(){ return CATEGORIES.find(x=>x.key===state.activeCat) || CATEGORIES[0]; }

function getVisibleItems(){
  let items = [];
  if(state.global){
    for(const c of CATEGORIES){
      const arr = state.dataByCat.get(c.key) || [];
      items.push(...arr.map(it=>({...it, catKey:c.key, catLabel:c.label})));
    }
  } else {
    const c = getActiveCat();
    const arr = state.dataByCat.get(c.key) || [];
    items = arr.map(it=>({...it, catKey:c.key, catLabel:c.label}));
  }

  const q = String(state.q||"").trim().toLowerCase();
  if(q){
    items = items.filter(it =>
      (it.name||"").toLowerCase().includes(q) ||
      (it.code||"").toLowerCase().includes(q) ||
      (it.catLabel||"").toLowerCase().includes(q)
    );
  }

  items.sort((a,b)=>String(a.name).localeCompare(String(b.name), "fr"));
  return items;
}

/* ===================== STOCK ===================== */
function isInStock(code){
  if(state.stockByCode[code] === undefined) return true;
  return !!state.stockByCode[code];
}
function toggleStock(code){
  state.stockByCode[code] = !isInStock(code);
  saveStock();
  render();
}

/* ===================== PAGINATION ===================== */
function renderPagination(totalItems) {
  const totalPages = Math.max(1, Math.ceil(totalItems / state.perPage));
  
  // Mettre √† jour la pagination en haut
  $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
  
  // Mettre √† jour la pagination en bas
  const paginationBottom = $("paginationBottom");
  if (totalPages > 1) {
    paginationBottom.style.display = "block";
    $("pageInfoBottom").textContent = `Page ${state.page} sur ${totalPages} (${totalItems} articles)`;
    
    // Boutons Pr√©c√©dent/Suivant
    $("prevBottomBtn").disabled = (state.page === 1);
    $("nextBottomBtn").disabled = (state.page === totalPages);
    
    // G√©n√©rer les num√©ros de page
    const pageNumbers = $("pageNumbers");
    pageNumbers.innerHTML = "";
    
    const maxVisible = 5;
    let startPage = Math.max(1, state.page - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    // Bouton premi√®re page
    if (startPage > 1) {
      const firstBtn = document.createElement("button");
      firstBtn.className = "page-btn";
      firstBtn.textContent = "1";
      firstBtn.onclick = () => {
        state.page = 1;
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      pageNumbers.appendChild(firstBtn);
      
      if (startPage > 2) {
        const dots = document.createElement("span");
        dots.className = "page-btn dots";
        dots.textContent = "...";
        pageNumbers.appendChild(dots);
      }
    }
    
    // Pages visibles
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement("button");
      pageBtn.className = "page-btn" + (i === state.page ? " active" : "");
      pageBtn.textContent = i;
      pageBtn.onclick = () => {
        state.page = i;
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      pageNumbers.appendChild(pageBtn);
    }
    
    // Bouton derni√®re page
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const dots = document.createElement("span");
        dots.className = "page-btn dots";
        dots.textContent = "...";
        pageNumbers.appendChild(dots);
      }
      
      const lastBtn = document.createElement("button");
      lastBtn.className = "page-btn";
      lastBtn.textContent = totalPages;
      lastBtn.onclick = () => {
        state.page = totalPages;
        render();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      pageNumbers.appendChild(lastBtn);
    }
  } else {
    paginationBottom.style.display = "none";
  }
}

/* ===================== RENDER ===================== */
function render(){
  const active = getActiveCat();
  $("activeLabel").textContent = state.global ? "Tous les produits" : active.label;
  $("activeMeta").textContent = state.global ? "Toutes cat√©gories" : `${active.file}`;

  const items = getVisibleItems();
  const totalPages = Math.max(1, Math.ceil(items.length / state.perPage));
  if(state.page > totalPages) state.page = totalPages;

  const start = (state.page-1)*state.perPage;
  const pageItems = items.slice(start, start + state.perPage);

  $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
  $("countInfo").textContent = `${items.length} article(s)`;

  // Mettre √† jour la pagination
  renderPagination(items.length);

  const box = $("products");
  box.innerHTML = "";

  if(pageItems.length === 0){
    box.innerHTML = `<div class="warn" style="grid-column:1/-1;text-align:center;padding:30px;">
      ${items.length === 0 ? 'Aucun article trouv√©' : 'Aucun article sur cette page'}
    </div>`;
  } else {
    for(const it of pageItems){
      const pid = safeKey(`${it.catKey}_${it.code}_${it.name}`);
      if(state.qtyPick[pid] == null) state.qtyPick[pid] = 0;

      const card = document.createElement("div");
      card.className = "card";

      const stockOk = isInStock(it.code);
      const imgSrc = `images/products/${it.code}.jpg`;

      card.innerHTML = `
        <div class="imgWrap">
          <img src="${imgSrc}" class="product-img" alt="${it.name}"
               onload="this.parentElement.querySelector('.noPhoto')?.remove()"
               onerror="this.style.display='none'; this.parentElement.querySelector('.noPhoto').style.display='flex';" />
          <div class="noPhoto" style="display:none;">Aucune photo</div>
        </div>

        <div class="card-content">
          <div class="card-top">
            <div class="namePrice">
              <div class="name">${it.name}</div>
              <div class="price">${fmtDT(it.price)}</div>
            </div>
            <div class="meta2">
              <div>Code: ${it.code}</div>
            </div>
          </div>
          
          <div class="card-bottom">
            <div class="actions">
              <div class="stepper">
                <button data-act="minus" title="Moins">‚àí</button>
                <span class="qv">${state.qtyPick[pid]||0}</span>
                <button data-act="plus" title="Plus">+</button>
              </div>

              <button class="stockBtn" data-stock="1">
                üì¶ <span class="stockTag ${stockOk ? "ok" : "no"}">${stockOk ? "En stock" : "Rupture"}</span>
              </button>

              <button class="addBtn" ${stockOk ? "" : "disabled"} title="${stockOk ? "Ajouter au panier" : "Rupture de stock"}">
                üß∫
              </button>
            </div>
          </div>
        </div>
      `;

      const ph = card.querySelector(".noPhoto");
      ph.style.display = "none";
      setTimeout(()=>{
        const img = card.querySelector(".product-img");
        if(img && (img.style.display==="none" || !img.complete || img.naturalWidth===0)){
          ph.style.display = "flex";
        }
      }, 0);

      card.querySelector('[data-act="minus"]').onclick = ()=>{
        state.qtyPick[pid] = Math.max(0, (state.qtyPick[pid]||0)-1);
        render();
      };
      card.querySelector('[data-act="plus"]').onclick = ()=>{
        state.qtyPick[pid] = (state.qtyPick[pid]||0)+1;
        render();
      };

      card.querySelector(".addBtn").onclick = ()=>{
        const q = state.qtyPick[pid]||0;
        if(q<=0) return;

        if(state.cart[pid]) state.cart[pid].qty += q;
        else state.cart[pid] = { pid, name:it.name, code:it.code, price:it.price, catLabel:it.catLabel, qty:q };

        state.qtyPick[pid] = 0;
        saveCart();
        refreshCartUI({ openAfterAdd: false });
        pulseCart();
      };

      card.querySelector(".stockBtn").onclick = ()=>{
        toggleStock(it.code);
      };

      box.appendChild(card);
    }
  }

  buildCatsHorizontal();
  refreshCartUI({ openAfterAdd: false });
}

/* ===================== CART UI ===================== */
function pulseCart(){
  const cartBtn = $("cartTopBtn");
  cartBtn.animate(
    [{ transform:"scale(1)" }, { transform:"scale(1.06)" }, { transform:"scale(1)" }],
    { duration: 260, easing: "ease-out" }
  );
}

function refreshCartUI({ openAfterAdd }){
  const cartCountValue = cartCount();
  $("cartTopCount").textContent = cartCountValue;
  $("cartMiniInfo").textContent = cartCountValue + " article(s)";

  const list = $("cartList");
  list.innerHTML = "";
  const keys = Object.keys(state.cart);

  if(!keys.length){
    const e = document.createElement("div");
    e.className = "warn";
    e.textContent = "Panier vide. Ajoute des articles üôÇ";
    list.appendChild(e);
  } else {
    for(const pid of keys){
      const it = state.cart[pid];

      const row = document.createElement("div");
      row.className = "cartItem";

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `<div class="t">${it.name}</div><div class="s">Code: ${it.code} ‚Ä¢ ${it.catLabel} ‚Ä¢ ${fmtDT(it.price)}</div>`;

      const right = document.createElement("div");
      right.className = "right";

      const step = document.createElement("div");
      step.className = "stepper";

      const minus = document.createElement("button");
      minus.textContent = "‚àí";
      minus.onclick = ()=>{
        it.qty = Math.max(0, (it.qty||0)-1);
        if(it.qty===0) delete state.cart[pid];
        saveCart();
        refreshCartUI({ openAfterAdd:false });
      };

      const val = document.createElement("span");
      val.textContent = it.qty||0;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.onclick = ()=>{
        it.qty = (it.qty||0)+1;
        saveCart();
        refreshCartUI({ openAfterAdd:false });
      };

      step.appendChild(minus); step.appendChild(val); step.appendChild(plus);

      const lineTotal = document.createElement("div");
      lineTotal.className = "lineTotal";
      lineTotal.textContent = fmtDT((Number(it.price)||0) * (it.qty||0));

      right.appendChild(step);
      right.appendChild(lineTotal);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    }
  }

  $("subTotal").textContent = fmtDT(cartTotal());
  const fee = shippingFee();
  $("shipFee").textContent = fee===null ? "‚Äî" : fmtDT(fee);

  const g = grandTotal();
  if(g===null){
    $("cartTotal").textContent = "Minimum commande 15 dt";
    $("cartTotal").style.color = "var(--danger)";
  } else {
    $("cartTotal").textContent = fmtDT(g);
    $("cartTotal").style.color = "var(--accent)";
  }

  const rule = $("ruleBox");
  const t = cartTotal();
  if(t <= 0){
    rule.innerHTML = `<div style="display:flex; flex-direction:column; gap:3px;">
      <div><strong>üìã Conditions de livraison :</strong></div>
      <div>‚Ä¢ Minimum commande: <strong>15 dt</strong></div>
      <div>‚Ä¢ Frais de livraison: <strong>3 dt</strong></div>
      <div>‚Ä¢ Livraison gratuite √† partir de <strong>30 dt</strong></div>
    </div>`;
    rule.className = "warn";
  } else if(t < MIN_ORDER){
    rule.innerHTML = `<div style="display:flex; flex-direction:column; gap:3px;">
      <div><strong>‚ö†Ô∏è Minimum commande non atteint</strong></div>
      <div>‚Ä¢ Minimum requis: <strong>15 dt</strong></div>
      <div>‚Ä¢ Il manque: <strong>${fmtDT(MIN_ORDER - t)}</strong></div>
      <div>‚Ä¢ Frais livraison: <strong>3 dt</strong></div>
      <div>‚Ä¢ Gratuit √† partir de <strong>30 dt</strong></div>
    </div>`;
    rule.className = "warn bad";
  } else if(t >= FREE_SHIPPING){
    rule.innerHTML = `<div style="display:flex; flex-direction:column; gap:3px;">
      <div><strong>‚úÖ Livraison gratuite !</strong></div>
      <div>‚Ä¢ Total: <strong>${fmtDT(t)}</strong> (‚â• ${FREE_SHIPPING} dt)</div>
      <div>‚Ä¢ Frais livraison: <strong>GRATUIT</strong></div>
    </div>`;
    rule.className = "warn good";
  } else {
    rule.innerHTML = `<div style="display:flex; flex-direction:column; gap:3px;">
      <div><strong>üì¶ Conditions de livraison</strong></div>
      <div>‚Ä¢ Total: <strong>${fmtDT(t)}</strong></div>
      <div>‚Ä¢ Frais livraison: <strong>3 dt</strong></div>
      <div>‚Ä¢ Gratuit √† partir de <strong>30 dt</strong></div>
      <div>‚Ä¢ Il manque: <strong>${fmtDT(FREE_SHIPPING - t)}</strong> pour la gratuit√©</div>
    </div>`;
    rule.className = "warn";
  }

  if(state.pinCart) openDrawer();
}

/* ===================== CLIENT ===================== */
function lockClientUI(locked){
  const fields = ["cName","cTel","cAddr","cLat","cLng"];
  fields.forEach(id => $(id).disabled = !!locked);
  $("saveClientBtn").disabled = !!locked;
  $("gpsBtn").disabled = !!locked;
  $("clientLockTxt").textContent = locked ? "VERROUILL√â" : "";
  $("editClientBtn").style.opacity = locked ? "1" : "1";
}

function fillClientUI(){
  if(!state.client){
    $("cName").value = "";
    $("cTel").value = "";
    $("cAddr").value = "";
    $("cLat").value = "";
    $("cLng").value = "";
    $("clientCode").value = "";
    lockClientUI(false);
    return;
  }
  $("cName").value = state.client.name||"";
  $("cTel").value = state.client.tel||"";
  $("cAddr").value = state.client.addr||"";
  $("cLat").value = state.client.lat||"";
  $("cLng").value = state.client.lng||"";
  $("clientCode").value = state.client.clientCode || "";
  lockClientUI(true);
}

function buildClientCodeFromClient(client){
  const payload = {
    v:1,
    name: client.name||"",
    tel: client.tel||"",
    addr: client.addr||"",
    lat: client.lat||"",
    lng: client.lng||""
  };
  return encodeB64(JSON.stringify(payload));
}

function importClientCode(code){
  try{
    const txt = decodeB64(code.trim());
    const obj = JSON.parse(txt);
    if(!obj || !obj.tel) throw new Error("Code invalide");
    state.client = {
      name: obj.name||"",
      tel: obj.tel||"",
      addr: obj.addr||"",
      lat: obj.lat||"",
      lng: obj.lng||"",
      savedAt: new Date().toISOString(),
      clientCode: code.trim()
    };
    saveClient();
    fillClientUI();
    alert("‚úÖ Client import√© !");
  }catch(e){
    alert("‚ùå Code client invalide.");
  }
}

/* ===================== GPS REVERSE GEOCODING ===================== */
async function getAddressFromCoords(lat, lng) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
    const data = await response.json();
    
    if (data && data.address) {
      const addr = data.address;
      let addressParts = [];
      
      if (addr.road) addressParts.push(addr.road);
      if (addr.suburb) addressParts.push(addr.suburb);
      if (addr.city_district) addressParts.push(addr.city_district);
      if (addr.city) addressParts.push(addr.city);
      
      if (addressParts.length > 0) {
        return addressParts.join(', ');
      }
    }
    return null;
  } catch (error) {
    console.error("Erreur reverse geocoding:", error);
    return null;
  }
}

/* ===================== HISTORY ===================== */
function renderHistory(){
  const history = loadHistory();
  $("histCount").textContent = history.length;

  const tbody = $("histTbody");
  tbody.innerHTML = "";

  if(history.length === 0){
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:var(--muted);padding:16px;">Aucune commande</td></tr>`;
    return;
  }

  history.slice(0, 12).forEach(order=>{
    const tr = document.createElement("tr");
    const d = new Date(order.date).toLocaleString("fr-FR");
    const itemsCount = (order.items||[]).reduce((s,x)=>s+(x.qty||0),0);
    tr.innerHTML = `<td>${d}</td><td><strong>${fmtDT(order.total)}</strong></td><td>${itemsCount}</td>`;
    tbody.appendChild(tr);
  });
}

/* ===================== LOAD DATA ===================== */
async function loadAll(){
  let totalProducts = 0;

  for(const c of CATEGORIES){
    try{
      const r = await fetch(c.file, {cache:"no-store"});
      if(!r.ok){ state.dataByCat.set(c.key, []); continue; }
      const text = await r.text();
      const items = parseCSV(text);
      state.dataByCat.set(c.key, items);
      totalProducts += items.length;
    }catch(e){
      state.dataByCat.set(c.key, []);
    }
  }

  buildCatsHorizontal();
  render();
}

/* ===================== VIDER PANIER APR√àS ENVOI ===================== */
function clearCartAfterSend(){
  state.cart = {};
  saveCart();
  refreshCartUI({ openAfterAdd: false });
}

/* ===================== EVENTS ===================== */
$("clearBtn").onclick = ()=>{ $("q").value=""; state.q=""; state.page=1; render(); };
$("globalBtn").onclick = ()=>{ state.global=true; state.activeCat=null; state.page=1; render(); };
$("q").addEventListener("input", ()=>{ state.q=$("q").value; state.page=1; render(); });

// Pagination en haut
$("prevBtn").onclick = ()=>{ state.page=Math.max(1,state.page-1); render(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
$("nextBtn").onclick = ()=>{
  const total = getVisibleItems().length;
  const totalPages = Math.max(1, Math.ceil(total/state.perPage));
  state.page=Math.min(totalPages,state.page+1);
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// Pagination en bas
$("prevBottomBtn").onclick = ()=>{ 
  state.page=Math.max(1,state.page-1); 
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
};
$("nextBottomBtn").onclick = ()=>{
  const total = getVisibleItems().length;
  const totalPages = Math.max(1, Math.ceil(total/state.perPage));
  state.page=Math.min(totalPages,state.page+1);
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

/* Panier: ouverture manuelle */
$("cartTopBtn").onclick = ()=> openDrawer();
$("closeDrawer").onclick = ()=> closeDrawer(false);
$("backdrop").onclick = ()=> closeDrawer(false);

/* QR Code */
$("qrBtn").onclick = ()=> $("qrModal").classList.add("open");
$("closeQrBtn").onclick = ()=> $("qrModal").classList.remove("open");
$("qrModal").onclick = (e)=> {
  if(e.target.classList.contains("qrModal")) $("qrModal").classList.remove("open");
};

/* Pin cart */
$("pinCart").addEventListener("change", ()=>{
  state.pinCart = $("pinCart").checked;
  savePin();
  if(state.pinCart) openDrawer();
});

/* GPS avec reverse geocoding */
$("gpsBtn").onclick = async ()=>{
  if(!navigator.geolocation){
    alert("GPS non support√© sur cet appareil.");
    return;
  }
  
  // Afficher un message d'attente
  $("gpsBtn").disabled = true;
  $("gpsBtn").innerHTML = "üìç R√©cup√©ration...";
  
  navigator.geolocation.getCurrentPosition(
    async (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      
      // Mettre √† jour les coordonn√©es
      $("cLat").value = lat.toFixed(6);
      $("cLng").value = lng.toFixed(6);
      
      // Essayer de r√©cup√©rer l'adresse
      try {
        const address = await getAddressFromCoords(lat, lng);
        if (address) {
          $("cAddr").value = address;
          alert(`‚úÖ Adresse d√©tect√©e: ${address}`);
        } else {
          alert("‚úÖ Coordonn√©es GPS enregistr√©es. Vous pouvez compl√©ter l'adresse manuellement.");
        }
      } catch (error) {
        alert("‚úÖ Coordonn√©es GPS enregistr√©es. Vous pouvez compl√©ter l'adresse manuellement.");
      }
      
      // R√©initialiser le bouton
      $("gpsBtn").disabled = false;
      $("gpsBtn").innerHTML = "üìç Obtenir adresse GPS";
    },
    (err)=>{
      alert("Impossible d'obtenir la position (autorisation refus√©e ou GPS d√©sactiv√©).");
      $("gpsBtn").disabled = false;
      $("gpsBtn").innerHTML = "üìç Obtenir adresse GPS";
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
};

/* Save client */
$("saveClientBtn").onclick = ()=>{
  const name = $("cName").value.trim();
  const tel  = $("cTel").value.trim();
  const addr = $("cAddr").value.trim();
  const lat  = $("cLat").value.trim();
  const lng  = $("cLng").value.trim();

  if(!name || !tel || !addr){
    alert("Veuillez remplir au moins Nom, T√©l√©phone et Adresse.");
    return;
  }

  const tmp = { name, tel, addr, lat, lng };
  const clientCode = buildClientCodeFromClient(tmp);

  state.client = {
    ...tmp,
    savedAt: new Date().toISOString(),
    clientCode
  };
  saveClient();
  fillClientUI();
  alert("‚úÖ Fiche client enregistr√©e !");
};

/* Edit client */
$("editClientBtn").onclick = ()=>{
  if(!state.client){
    alert("Aucun client enregistr√©.");
    return;
  }
  const ok = confirm("Modifier la fiche client ? (Vous pourrez r√©-enregistrer)");
  if(!ok) return;
  lockClientUI(false);
};

/* G√©n√©rer code client */
$("genCodeBtn").onclick = ()=>{
  if(!state.client){
    alert("Enregistre d'abord la fiche client.");
    return;
  }
  const code = buildClientCodeFromClient(state.client);
  state.client.clientCode = code;
  saveClient();
  $("clientCode").value = code;
  $("clientCode").select();
  document.execCommand("copy");
  alert("‚úÖ Code client copi√© ! (Colle-le sur l'autre appareil via Importer)");
};

/* Importer code client */
$("importCodeBtn").onclick = ()=>{
  const code = prompt("Colle ici le Code client :");
  if(!code) return;
  importClientCode(code);
};

/* Panier */
$("clearCartBtn").onclick = ()=>{
  if(confirm("Vider tout le panier ?")){
    state.cart = {};
    saveCart();
    refreshCartUI({ openAfterAdd:false });
  }
};

/* Envoyer (AVEC VIDAGE AUTOMATIQUE DU PANIER) */
$("sendBtn").onclick = ()=>{
  if(cartCount() === 0){ alert("Panier vide !"); return; }
  if(!state.client){ alert("Veuillez d'abord enregistrer la fiche client."); return; }
  const g = grandTotal();
  if(g === null){ alert(`Minimum commande: ${MIN_ORDER} dt`); return; }

  let summary = `=== COMMANDE MAXI JDC MARKET ===\n`;
  summary += `Date: ${new Date().toLocaleString('fr-FR')}\n`;
  summary += `Client: ${state.client.name}\n`;
  summary += `T√©l: ${state.client.tel}\n`;
  summary += `Adresse: ${state.client.addr}\n`;
  if(state.client.lat && state.client.lng){
    summary += `GPS: ${state.client.lat}, ${state.client.lng}\n`;
  }
  summary += `\n=== ARTICLES ===\n`;

  Object.values(state.cart).forEach(item=>{
    summary += `‚Ä¢ ${item.name} (x${item.qty}) = ${fmtDT(item.price * item.qty)}\n`;
  });

  summary += `\n=== TOTAL ===\n`;
  summary += `Sous-total: ${fmtDT(cartTotal())}\n`;
  const fee = shippingFee();
  summary += `Livraison: ${fee === 0 ? 'GRATUITE' : fmtDT(fee)}\n`;
  summary += `TOTAL: ${fmtDT(g)}\n`;

  // Save history (local)
  const history = loadHistory();
  history.unshift({
    date: new Date().toISOString(),
    tel: state.client.tel,
    total: g,
    items: Object.values(state.cart).map(i=>({ name:i.name, qty:i.qty, price:i.price }))
  });
  saveHistory(history);

  $("orderText").value = summary;
  $("modalBack").classList.add("open");
  renderHistory();
  
  // VIDER LE PANIER APR√àS ENVOI
  setTimeout(clearCartAfterSend, 100);
};

$("closeModal").onclick = ()=> $("modalBack").classList.remove("open");
$("copyBtn").onclick = ()=>{
  $("orderText").select();
  document.execCommand("copy");
  alert("‚úÖ Copi√© !");
};
$("downloadBtn").onclick = ()=>{
  const text = $("orderText").value;
  const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
  const filename = `commande_${(state.client?.name||"client")}_${date}.txt`;
  dlText(filename, text);
};
$("whatsappBtn").onclick = ()=>{
  const text = encodeURIComponent($("orderText").value);
  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${text}`, '_blank');
};

/* Historique */
$("histToggleBtn").onclick = ()=>{
  $("histBox").classList.toggle("open");
  if($("histBox").classList.contains("open")) renderHistory();
};
$("clearMyHistoryBtn").onclick = ()=>{
  if(confirm("Effacer tout l'historique de commandes (cet appareil) ?")){
    saveHistory([]);
    renderHistory();
  }
};

/* ===================== INIT ===================== */
loadLocal();
$("pinCart").checked = state.pinCart;

fillClientUI();
refreshCartUI({ openAfterAdd:false });

if(state.pinCart) openDrawer(); else closeDrawer(true);

loadAll();
</script>
</body>
</html>
