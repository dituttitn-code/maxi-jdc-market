<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAXI JDC MARKET ‚Äî Commandez en ligne</title>

  <style>
    :root{
      --bg:#0c0f14;
      --panel:#121826;
      --panel2:#0f1522;
      --text:#e9eef7;
      --muted:#a9b3c7;
      --border:rgba(255,255,255,.08);
      --green:#2ee66b;
      --green2:#1db954;
      --chip:#1a2234;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #18223a 0%, var(--bg) 60%);
      color:var(--text);
    }
    .container{max-width:1200px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--border);background:rgba(18,24,38,.72);
      border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      position:sticky;top:10px;z-index:50;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px}
    .brand img{width:44px;height:44px;border-radius:999px;object-fit:cover}
    .brand .t1{font-weight:800;letter-spacing:.3px}
    .brand .t2{font-size:12px;color:var(--muted);margin-top:2px}
    .top-right{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(15,21,34,.8);color:var(--text);font-size:13px;
    }
    .pill b{color:var(--green)}
    .btn{
      cursor:pointer;border:1px solid var(--border);background:rgba(26,34,52,.9);
      color:var(--text);padding:10px 12px;border-radius:999px;
      transition:transform .08s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(36,47,72,.95)}
    .btn.primary{background:linear-gradient(180deg,var(--green),var(--green2));border:none;color:#07110a;font-weight:800}
    .btn.ghost{background:transparent}
    .btn.active{outline:2px solid rgba(46,230,107,.35);background:rgba(46,230,107,.10)}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .searchbar{
      margin-top:14px;
      padding:14px 16px;border:1px solid var(--border);background:rgba(18,24,38,.55);
      border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    }
    input[type="search"]{
      flex:1;min-width:240px;
      background:rgba(0,0,0,.25);border:1px solid var(--border);
      color:var(--text);padding:12px 14px;border-radius:999px;
      outline:none;
    }
    .chips{
      margin-top:14px;
      padding:14px 16px;border:1px solid var(--border);background:rgba(18,24,38,.45);
      border-radius:var(--radius);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .chip{
      padding:10px 12px;border-radius:999px;background:var(--chip);
      border:1px solid var(--border);cursor:pointer;font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .chip.active{background:rgba(46,230,107,.14);border-color:rgba(46,230,107,.35)}
    .meta{
      margin-left:auto;color:var(--muted);font-size:13px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }

    /* GRID stable (anti-clignotement) */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns: repeat(4,1fr);} }
    @media (max-width:900px){ .grid{grid-template-columns: repeat(3,1fr);} }
    @media (max-width:640px){ .grid{grid-template-columns: repeat(2,1fr);} }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(18,24,38,.75), rgba(15,21,34,.65));
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,.22);
      display:flex;
      flex-direction:column;
      min-height:320px;
      contain: content; /* aide performance */
    }
    .imgwrap{
      width:100%;
      aspect-ratio: 1 / 1;
      background:rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
      border-bottom:1px solid var(--border);
    }
    .imgwrap img{
      width:100%;
      height:100%;
      object-fit:cover; /* ajuste photo */
      display:block;
    }
    .cbody{padding:12px 12px 10px;display:flex;flex-direction:column;gap:8px;flex:1}
    .name{font-weight:800;line-height:1.15;font-size:13px}
    .sub{color:var(--muted);font-size:12px}
    .price{display:flex;justify-content:space-between;align-items:baseline;margin-top:auto}
    .price .p{font-size:16px;font-weight:900}
    .price .u{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:8px}
    .qty{
      display:flex;align-items:center;gap:8px;border:1px solid var(--border);
      background:rgba(0,0,0,.2);border-radius:999px;padding:6px 10px;
    }
    .qty button{
      width:26px;height:26px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;
    }
    .qty span{min-width:18px;text-align:center;font-weight:800}
    .add{
      flex:1;
      border:none;border-radius:999px;
      background:linear-gradient(180deg,var(--green),var(--green2));
      color:#07110a;font-weight:900;padding:10px 10px;cursor:pointer;
    }

    .footbar{
      margin:16px 0 24px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      color:var(--muted);
    }

    .toast{
      position:fixed;right:18px;bottom:18px;
      background:rgba(18,24,38,.92);
      border:1px solid var(--border);
      border-radius:14px;padding:12px 14px;
      box-shadow:var(--shadow);
      display:none;
      max-width:min(420px, calc(100vw - 36px));
      z-index:99;
    }
    .toast.show{display:block}
    .toast b{color:var(--green)}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <img src="img/logo.png" alt="MAXI JDC MARKET" onerror="this.style.display='none'">
        <div>
          <div class="t1">MAXI JDC MARKET</div>
          <div class="t2">Des prix mini ‚Äî Un MAXI choix</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill">üìç Jardins de Carthage, derri√®re mosqu√©e Essalem</div>
        <div class="pill">üïò 7h ‚Äì 1h du matin</div>
        <div class="pill">üí¨ WhatsApp: <b id="waNum">00216 25 600 978</b></div>
        <button class="btn primary" id="btnWhatsApp">Panier WhatsApp</button>
      </div>
    </header>

    <div class="searchbar">
      <input id="q" type="search" placeholder="Rechercher un produit (nom, cat√©gorie, code)..." autocomplete="off" />
      <button class="btn ghost" id="btnClear">Effacer</button>
      <button class="btn" id="btnAll">Recherche globale</button>
    </div>

    <div class="chips" id="chips">
      <div class="meta">
        <span id="countInfo">Chargement‚Ä¶</span>
        <span id="pageInfo"></span>
        <button class="btn" id="prev">‚óÄ</button>
        <button class="btn" id="next">‚ñ∂</button>
      </div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footbar">
      <div>Conditions: minimum livraison 15 dt ‚Ä¢ Livraison gratuite si total ‚â• 30 dt ‚Ä¢ Sinon frais 5 dt ‚Ä¢ Retrait magasin possible</div>
      <div style="opacity:.9">MAXI JDC MARKET</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
========================= */
const WHATSAPP_NUMBER = "21625600978"; // sans espaces ni +
const PRODUCTS_IMG_DIR = "img/products"; // /img/products/1407.jpg
const CSV_DIR = "data"; // /data/Fromage.CSV

// Noms PRO (style Carrefour)
const CATEGORY_LABELS = {
  "Animaux.CSV": "Produits animaux",
  "B√©b√© et Maman.CSV": "B√©b√© & Maman",
  "Caf√©.CSV": "Caf√© & Capsules",
  "Chips.CSV": "Snacking sal√©",
  "Chocolas et Biscuits.CSV": "√âpicerie sucr√©e",
  "Cuisine du monde.CSV": "Cuisine du monde",
  "Eaux.CSV": "Eaux & Boissons sans sucre",
  "Fromage.CSV": "Fromage & Cr√®merie",
  "Fruits Secs.CSV": "Fruits secs & Graines",
  "Fruits et legumes.CSV": "Fruits & L√©gumes",
  "Hygiene et entretien.CSV": "Hygi√®ne & Entretien",
  "Hygiene et Soins.CSV": "Hygi√®ne & Soins",
  "Jus et Boissons.CSV": "Boissons & Jus",
  "Lait et D√©riv√©s.CSV": "Lait & D√©riv√©s",
  "Pates et Conserves.CSV": "√âpicerie sal√©e",
  "Salami.CSV": "Charcuterie",
  "Surgele.CSV": "Surgel√©s",
  "Vipa.CSV": "√âpicerie healthy"
};

// Liste exacte (comme ta capture)
const CSV_FILES = [
  "Animaux.CSV",
  "B√©b√© et Maman.CSV",
  "Caf√©.CSV",
  "Chips.CSV",
  "Chocolas et Biscuits.CSV",
  "Cuisine du monde.CSV",
  "Eaux.CSV",
  "Fromage.CSV",
  "Fruits Secs.CSV",
  "Fruits et legumes.CSV",
  "Hygiene et entretien.CSV",
  "Hygiene et Soins.CSV",
  "Jus et Boissons.CSV",
  "Lait et D√©riv√©s.CSV",
  "Pates et Conserves.CSV",
  "Salami.CSV",
  "Surgele.CSV",
  "Vipa.CSV"
];

const PAGE_SIZE = 25;

/* =========================
   STATE
========================= */
let allProducts = [];          // [{code, name, price, categoryKey, categoryLabel}]
let activeCategory = "ALL";    // "ALL" ou categoryKey = filename
let query = "";
let page = 1;
let cart = new Map();          // code -> qty
let isRendering = false;

/* =========================
   HELPERS
========================= */
function norm(s){
  return (s ?? "")
    .toString()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase().trim();
}

function moneyDT(v){
  // Support virgule ou point
  let x = (v ?? "").toString().replace(",", ".").trim();
  let n = Number(x);
  if (Number.isNaN(n)) return "";
  // afficher 1 ou 2 d√©cimales selon besoin
  return (Math.round(n * 100) / 100).toFixed(n % 1 === 0 ? 0 : 1) + " dt";
}

function getImgUrl(code){
  // JPG par d√©faut
  return `${PRODUCTS_IMG_DIR}/${encodeURIComponent(code)}.jpg`;
}

function toast(msg){
  const el = document.getElementById("toast");
  el.innerHTML = msg;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=>el.classList.remove("show"), 2300);
}

/* CSV parser simple (virgule ou point-virgule) */
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  if (!lines.length) return [];
  const header = lines[0];
  const sep = header.includes(";") ? ";" : ",";
  const rows = [];
  for (let i=1;i<lines.length;i++){
    const line = lines[i];
    const cols = line.split(sep).map(c => c.trim());
    // attendu: CODE_ARTICLE, DESIGNATION, PV_TTC
    if (cols.length < 3) continue;
    rows.push({
      code: cols[0],
      name: cols[1],
      price: cols[2]
    });
  }
  return rows;
}

async function loadOneCSV(fileName){
  const url = `${CSV_DIR}/${encodeURIComponent(fileName)}`;
  const res = await fetch(url, {cache:"no-store"});
  if (!res.ok) throw new Error(`Impossible de charger ${fileName}`);
  const text = await res.text();
  const rows = parseCSV(text);

  const label = CATEGORY_LABELS[fileName] || fileName.replace(/\.csv$/i,"");
  return rows
    .filter(r => r.code && r.name)
    .map(r => ({
      code: r.code.trim(),
      name: r.name.trim(),
      price: r.price?.trim() ?? "",
      categoryKey: fileName,
      categoryLabel: label
    }));
}

/* =========================
   UI BUILD
========================= */
function buildCategoryChips(){
  const chips = document.getElementById("chips");
  // Garder la zone meta d√©j√† dedans -> on reconstruit proprement
  chips.innerHTML = "";

  // Bouton ALL
  const allChip = document.createElement("div");
  allChip.className = "chip" + (activeCategory==="ALL" ? " active":"");
  allChip.textContent = "Toutes cat√©gories";
  allChip.onclick = () => { activeCategory="ALL"; page=1; render(); };
  chips.appendChild(allChip);

  // Chips cat√©gories
  for (const f of CSV_FILES){
    const c = document.createElement("div");
    c.className = "chip" + (activeCategory===f ? " active":"");
    c.textContent = CATEGORY_LABELS[f] || f;
    c.onclick = () => { activeCategory=f; page=1; render(); };
    chips.appendChild(c);
  }

  // Meta √† droite
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `
    <span id="countInfo"></span>
    <span id="pageInfo"></span>
    <button class="btn" id="prev">‚óÄ</button>
    <button class="btn" id="next">‚ñ∂</button>
  `;
  chips.appendChild(meta);

  document.getElementById("prev").onclick = () => { if(page>1){ page--; render(); } };
  document.getElementById("next").onclick = () => { page++; render(); };
}

function filteredProducts(){
  const qn = norm(query);
  return allProducts.filter(p => {
    if (activeCategory !== "ALL" && p.categoryKey !== activeCategory) return false;
    if (!qn) return true;
    return (
      norm(p.name).includes(qn) ||
      norm(p.categoryLabel).includes(qn) ||
      norm(p.code).includes(qn)
    );
  });
}

/* Render stable anti-clignotement */
function render(){
  if (isRendering) return;
  isRendering = true;

  // Chips active state
  buildCategoryChips();

  const list = filteredProducts();
  const total = list.length;

  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if (page > totalPages) page = totalPages;

  const start = (page-1)*PAGE_SIZE;
  const pageItems = list.slice(start, start + PAGE_SIZE);

  document.getElementById("countInfo").textContent = `${total} article(s)`;
  document.getElementById("pageInfo").textContent = `Page ${page}/${totalPages}`;

  const grid = document.getElementById("grid");

  // IMPORTANT: on √©vite ‚Äúclignotement‚Äù en ne faisant pas d‚Äôanimations et en rempla√ßant d‚Äôun coup
  const frag = document.createDocumentFragment();

  for (const p of pageItems){
    const card = document.createElement("div");
    card.className = "card";

    const imgWrap = document.createElement("div");
    imgWrap.className = "imgwrap";

    const img = document.createElement("img");
    img.loading = "lazy";
    img.alt = p.name;

    // Image fallback si pas trouv√©e
    img.src = getImgUrl(p.code);
    img.onerror = () => {
      img.onerror = null;
      img.src = "img/placeholder.png"; // (optionnel) sinon on cache
      img.style.objectFit = "contain";
      img.style.opacity = ".9";
    };
    imgWrap.appendChild(img);

    const body = document.createElement("div");
    body.className = "cbody";
    body.innerHTML = `
      <div class="name">${escapeHtml(p.name)}</div>
      <div class="sub">${escapeHtml(p.categoryLabel)} ‚Ä¢ ${escapeHtml(p.code)}</div>
      <div class="price">
        <div class="p">${moneyDT(p.price) || ""}</div>
        <div class="u">/ pi√®ce</div>
      </div>
    `;

    const actions = document.createElement("div");
    actions.className = "actions";

    const qty = document.createElement("div");
    qty.className = "qty";

    const minus = document.createElement("button");
    minus.textContent = "‚àí";
    const plus = document.createElement("button");
    plus.textContent = "+";
    const qSpan = document.createElement("span");
    qSpan.textContent = cart.get(p.code) || 1;

    minus.onclick = () => {
      let v = (cart.get(p.code) || 1) - 1;
      if (v < 1) v = 1;
      cart.set(p.code, v);
      qSpan.textContent = v;
    };
    plus.onclick = () => {
      let v = (cart.get(p.code) || 1) + 1;
      cart.set(p.code, v);
      qSpan.textContent = v;
    };

    qty.appendChild(minus);
    qty.appendChild(qSpan);
    qty.appendChild(plus);

    const add = document.createElement("button");
    add.className = "add";
    add.textContent = "Ajouter";
    add.onclick = () => {
      const v = cart.get(p.code) || 1;
      toast(`‚úÖ Ajout√©: <b>${escapeHtml(p.name)}</b> (x${v})`);
    };

    actions.appendChild(qty);
    actions.appendChild(add);

    body.appendChild(actions);

    card.appendChild(imgWrap);
    card.appendChild(body);

    frag.appendChild(card);
  }

  // Swap d‚Äôun coup
  grid.innerHTML = "";
  grid.appendChild(frag);

  isRendering = false;
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   WHATSAPP CART
========================= */
function buildWhatsAppMessage(){
  const list = filteredProducts(); // ou allProducts? -> ici on prend ceux du panier seulement
  const items = [];
  let totalLines = 0;

  // construire depuis cart
  for (const [code, qty] of cart.entries()){
    const p = allProducts.find(x => x.code === code);
    if (!p) continue;
    items.push(`- ${p.name} (Code: ${p.code}) x${qty} ‚Äî ${moneyDT(p.price)}`);
    totalLines++;
  }

  if (!items.length) return "Bonjour MAXI JDC MARKET, je veux passer une commande :";

  return [
    "Bonjour MAXI JDC MARKET, je veux passer une commande :",
    "",
    ...items,
    "",
    "Merci."
  ].join("\n");
}

function openWhatsApp(){
  const msg = buildWhatsAppMessage();
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
}

/* =========================
   INIT
========================= */
async function init(){
  document.getElementById("btnWhatsApp").onclick = openWhatsApp;
  document.getElementById("btnAll").onclick = () => { activeCategory="ALL"; page=1; render(); };

  const qEl = document.getElementById("q");
  qEl.addEventListener("input", () => {
    query = qEl.value;
    page = 1;
    render();
  });

  document.getElementById("btnClear").onclick = () => {
    qEl.value = "";
    query = "";
    page = 1;
    render();
  };

  // Charge tous les CSV
  const loaded = [];
  for (const f of CSV_FILES){
    try{
      const arr = await loadOneCSV(f);
      loaded.push(...arr);
    }catch(e){
      console.warn(e);
    }
  }

  // D√©duplication (au cas o√π)
  const seen = new Set();
  allProducts = loaded.filter(p => {
    const k = `${p.categoryKey}__${p.code}`;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });

  // Tri stable (anti clignotement : ordre constant)
  allProducts.sort((a,b) => {
    if (a.categoryLabel !== b.categoryLabel) return a.categoryLabel.localeCompare(b.categoryLabel);
    return a.name.localeCompare(b.name);
  });

  // D√©part
  render();
}

init();
</script>

</body>
</html>
