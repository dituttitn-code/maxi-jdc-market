<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes"/>
  <title>MAXI JDC MARKET ‚Äî Livraison Rapide</title>

  <style>
    :root{
      --bg0:#0f172a;
      --bg1:#1e293b;
      --card:#334155;
      --card2:#475569;
      --line:rgba(255,255,255,.2);
      --text:#f8fafc;
      --muted:#cbd5e1;
      --accent:#22d3ee;
      --accent2:#06b6d4;
      --danger:#ef4444;
      --success:#10b981;
      --shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
      --radius:16px;
    }
    *{box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent;}
    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 100%);
      min-height:100vh;
      line-height:1.7;
      overflow-x:hidden;
      touch-action: manipulation;
    }
    .wrap{
      max-width:100%;
      margin:0 auto;
      padding:12px 12px 80px;
    }

    /* HEADER PROFESSIONNEL */
    .top{
      background: rgba(15, 23, 42, 0.98);
      border-bottom: 3px solid var(--accent);
      padding: 16px 12px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      margin-bottom: 16px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .logo{
      width:60px;
      height:60px;
      border-radius:14px;
      border:3px solid var(--accent);
      overflow:hidden;
      flex:0 0 auto;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      padding: 4px;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:10px;
      background: white;
    }
    .brandText{
      flex:1;
      min-width:0;
    }
    .brandText h1{
      margin:0;
      font-size:22px;
      font-weight:900;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }
    .brandText p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      font-weight:500;
      max-width: 500px;
    }

    /* BARRE D'INFORMATIONS RAPIDES */
    .infoBar{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      padding: 10px;
      background: rgba(255,255,255,.05);
      border-radius: 12px;
      border: 1px solid var(--line);
    }
    .infoItem{
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(255,255,255,.08);
      border-radius: 10px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      flex: 1;
      min-width: 120px;
    }
    .infoItem strong{
      color: var(--accent);
      font-weight: 700;
    }

    /* RECHERCHE ET FILTRES */
    .searchRow{
      display:flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .searchContainer{
      flex:1;
      min-width: 0;
      display: flex;
      gap: 4px;
    }
    .searchContainer input{
      flex:1;
      height:48px;
      border-radius:12px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.1);
      color: var(--text);
      padding:0 16px;
      outline:none;
      font-size:16px;
      font-weight:500;
      min-width: 0;
    }
    .searchContainer input:focus{ 
      border-color: var(--accent); 
      background: rgba(255,255,255,.15); 
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
    }
    .btn{
      height:48px;
      padding:0 16px;
      border-radius:12px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.12);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition: all 0.2s ease;
      white-space:nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 80px;
    }
    .btn:hover{ background: rgba(255,255,255,.18); border-color: var(--accent); }
    .btn.primary{ 
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border:none;
      color: white;
      font-weight: 800;
    }
    .btn.primary:hover{ opacity: 0.9; transform: translateY(-2px); }

    /* BOUTON PANIER VISIBLE */
    .cartBtn{
      height:48px;
      padding:0 20px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 900;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 120px;
      box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
    }
    .cartBtn:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 211, 238, 0.4);
    }
    .cartCount{
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 900;
    }

    /* CAT√âGORIES HORIZONTALES */
    .catsRow {
      margin: 20px 0;
      padding: 12px 0;
      overflow-x: auto;
      display: flex;
      gap: 8px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .catsRow::-webkit-scrollbar { display: none; }
    
    .catBtn {
      flex: 0 0 auto;
      padding: 12px 20px;
      border-radius: 12px;
      border: 2px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 48px;
    }
    .catBtn:hover { background: rgba(255,255,255,.12); border-color: var(--accent2); }
    .catBtn.active {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(6, 182, 212, 0.2));
      color: var(--accent);
      box-shadow: 0 4px 12px rgba(34, 211, 238, 0.2);
    }
    .catCount {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,.4);
      border: 1px solid rgba(255,255,255,.15);
    }

    /* CONTENU PRINCIPAL */
    .mainContent{
      padding: 0 4px;
    }
    .pageHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .pageHeader h2{
      margin:0;
      font-size:24px;
      font-weight:900;
      color:var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .pageMeta{
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }

    /* PAGINATION */
    .pagination{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:14px;
      white-space:nowrap;
      font-weight:600;
      padding: 12px;
      background: rgba(255,255,255,.05);
      border-radius: 12px;
      margin: 20px 0;
    }
    .pagination button{
      width:44px;
      height:44px;
      border-radius:12px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.1);
      cursor:pointer;
      color:var(--text);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all 0.2s ease;
      font-size:18px;
    }
    .pagination button:hover{ background: rgba(255,255,255,.15); border-color: var(--accent); }
    .pagination button:disabled{
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* PRODUITS - DESIGN MODERNE */
    #products{
      display:grid;
      grid-template-columns:1fr;
      gap:20px;
    }

    .productCard{
      border-radius:var(--radius);
      border:2px solid var(--line);
      background: var(--card);
      overflow:hidden;
      box-shadow:var(--shadow);
      transition: all 0.3s ease;
      display:flex;
      flex-direction:column;
      height: 100%;
    }
    .productCard:hover{ 
      border-color: var(--accent); 
      transform: translateY(-4px); 
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }

    /* IMAGE BIEN AJUST√âE - CROP ET CENTRAGE */
    .productImage{
      width:100%;
      height:220px;
      position:relative;
      overflow:hidden;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }
    .productImage img{
      width:100%;
      height:100%;
      object-fit:cover; /* Crop et centrage */
      display:block;
      transition: transform 0.5s ease;
    }
    .productCard:hover .productImage img{
      transform: scale(1.05);
    }
    .noImage{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      color:#64748b;
      font-weight:800;
      font-size:14px;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      text-align:center;
      padding:20px;
      gap: 8px;
    }
    .noImage::before {
      content: "üì∑";
      font-size: 40px;
      opacity: 0.5;
    }

    /* CONTENU DE LA CARTE */
    .cardContent{
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:16px;
      flex:1;
    }
    
    .productHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      min-width:0;
    }
    .productName{
      font-weight:800;
      font-size:18px;
      line-height:1.4;
      min-width:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      color:var(--text);
      flex:1;
    }
    .productPrice{
      flex:0 0 auto;
      font-weight:900;
      padding:8px 14px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:white;
      font-size:18px;
      white-space:nowrap;
      min-width: 90px;
      text-align: center;
    }

    .productMeta{
      color:var(--muted);
      font-size:14px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-weight:500;
    }
    .metaRow{
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ACTIONS DE LA CARTE */
    .productActions{
      margin-top: auto;
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
    }
    
    /* STEPPER AM√âLIOR√â */
    .stepper{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      padding:6px 10px;
      border-radius:12px;
      border:2px solid var(--line);
      background: rgba(0,0,0,.4);
      min-width: 0;
      width: 130px;
      flex-shrink: 0;
    }
    .stepper button{
      width:40px;
      height:40px;
      border-radius:50%;
      border:2px solid var(--line);
      background: rgba(255,255,255,.15);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all 0.15s ease;
      flex:0 0 auto;
    }
    .stepper button:hover{ border-color: var(--accent); background: rgba(255,255,255,.25); }
    .stepper span{ 
      min-width:30px;
      text-align:center; 
      font-weight:900; 
      color:var(--text); 
      font-size:22px;
    }

    /* STOCK */
    .stockIndicator{
      padding: 8px 12px;
      border-radius:10px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      flex: 1;
      min-width: 0;
      font-weight:600;
    }
    .stockIndicator.inStock{ 
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    .stockIndicator.outOfStock{ 
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* BOUTON AJOUTER */
    .addToCartBtn{
      height:48px;
      padding:0 20px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:white;
      border:none;
      cursor:pointer;
      font-weight:900;
      font-size:15px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
      transition: all 0.15s ease;
      min-width: 0;
      flex-shrink: 0;
      flex: 2;
    }
    .addToCartBtn:hover{ 
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
    }
    .addToCartBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--card2);
      border: 2px solid var(--line);
      color: var(--muted);
      transform: none !important;
      box-shadow: none !important;
    }

    /* PANIER MODAL */
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.85);
      opacity:0;
      pointer-events:none;
      transition: opacity .3s ease;
      z-index:100;
    }
    .backdrop.open{ opacity:1; pointer-events:auto; }

    .cartModal{
      position:fixed;
      top:0;
      right:0;
      height:100%;
      width:100%;
      max-width:500px;
      background: rgba(15, 23, 42, 0.98);
      border-left:3px solid var(--accent);
      box-shadow:-20px 0 60px rgba(0,0,0,.8);
      transform: translateX(100%);
      transition: transform .3s ease;
      z-index:101;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(20px);
      overflow: hidden;
    }
    .cartModal.open{ transform: translateX(0); }

    .cartHeader{
      padding:20px;
      border-bottom:3px solid var(--accent);
      background: rgba(34, 211, 238, 0.1);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-shrink: 0;
    }
    .cartHeader h3{
      margin:0;
      font-size:20px;
      color: var(--accent);
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:900;
    }

    .cartBody{
      flex:1;
      overflow-y:auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:16px;
      -webkit-overflow-scrolling: touch;
    }

    /* MODAL QR CODE */
    .qrModal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.9);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
    }
    .qrModal.open{
      display:flex;
    }
    .qrBox{
      background:var(--card);
      border-radius:20px;
      padding:30px;
      max-width:400px;
      width:100%;
      text-align:center;
      border:3px solid var(--accent);
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
    }
    .qrBox h3{
      margin:0 0 20px;
      color:var(--accent);
      font-size:24px;
      font-weight:900;
    }
    .qrImage{
      width:100%;
      max-width:300px;
      height:auto;
      border-radius:12px;
      margin:0 auto 20px;
      display:block;
      border:2px solid var(--line);
    }
    .qrInfo{
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
      margin-bottom:20px;
    }

    /* RESPONSIVE */
    @media (min-width: 640px){
      #products{grid-template-columns:repeat(2, 1fr);}
      .productImage{height:200px;}
    }
    @media (min-width: 768px){
      .wrap{padding:20px 20px 80px;}
      .top{padding:20px;}
      .brandText h1{font-size:26px;}
      .infoItem{font-size:13px;}
      .searchContainer input{font-size:15px;}
    }
    @media (min-width: 1024px){
      #products{grid-template-columns:repeat(3, 1fr);}
      .productImage{height:180px;}
    }
    @media (min-width: 1280px){
      #products{grid-template-columns:repeat(4, 1fr);}
      .productImage{height:160px;}
    }

    /* Pour iOS */
    input, textarea, select {
      font-size: 16px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- HEADER -->
    <header class="top">
      <div class="brand">
        <div class="logo">
          <img src="logo-maxi-jdc-market.jpg" alt="MAXI JDC MARKET" onerror="this.style.display='none'">
        </div>
        <div class="brandText">
          <h1>MAXI JDC MARKET</h1>
          <p>Votre supermarch√© en ligne ‚Ä¢ Livraison rapide 7j/7 ‚Ä¢ Large choix de produits frais et emball√©s</p>
        </div>
      </div>

      <!-- BARRE D'INFORMATIONS -->
      <div class="infoBar">
        <div class="infoItem">üìç <strong>Zone:</strong> Jardins de Carthage</div>
        <div class="infoItem">üïí <strong>Horaires:</strong> 7h - 1h</div>
        <div class="infoItem">üìû <strong>WhatsApp:</strong> 25 600 978</div>
        <div class="infoItem">üöö <strong>Livraison:</strong> 30-60 min</div>
        <div class="infoItem">üí≥ <strong>Paiement:</strong> √Ä la livraison</div>
      </div>

      <!-- RECHERCHE ET PANIER -->
      <div class="searchRow">
        <div class="searchContainer">
          <input id="searchInput" type="text" placeholder="üîç Rechercher un produit..." />
          <button class="btn" id="clearBtn">Effacer</button>
          <button class="btn primary" id="allProductsBtn">Tous</button>
        </div>
        <button class="cartBtn" id="cartBtn">
          üõí Panier <span id="cartCount">0</span>
        </button>
      </div>

      <!-- QR CODE BOUTON EN HAUT -->
      <div style="text-align:center; margin-top:16px;">
        <button class="btn" id="qrBtn" style="background:rgba(34,211,238,0.15); border-color:var(--accent); color:var(--accent);">
          üì± QR Code du site
        </button>
      </div>
    </header>

    <!-- CAT√âGORIES -->
    <div class="catsRow" id="categories"></div>

    <!-- CONTENU PRINCIPAL -->
    <main class="mainContent">
      <div class="pageHeader">
        <div>
          <h2 id="pageTitle">üéØ Tous les produits</h2>
          <div class="pageMeta" id="pageSubtitle">Commandez vos articles pr√©f√©r√©s en quelques clics</div>
        </div>
        <div style="color:var(--muted); font-size:14px; font-weight:600;">
          <span id="productCount">0</span> produits disponibles
        </div>
      </div>

      <!-- LISTE DES PRODUITS -->
      <div id="products"></div>

      <!-- PAGINATION -->
      <div class="pagination">
        <button id="prevPageBtn" disabled>‚Äπ</button>
        <span id="pageInfo">Page 1/1</span>
        <button id="nextPageBtn" disabled>‚Ä∫</button>
      </div>

      <!-- MESSAGE SI AUCUN PRODUIT -->
      <div id="noProducts" style="display:none; text-align:center; padding:60px 20px;">
        <div style="font-size:48px; margin-bottom:16px;">üòï</div>
        <h3 style="color:var(--text); margin-bottom:8px;">Aucun produit trouv√©</h3>
        <p style="color:var(--muted); max-width:500px; margin:0 auto;">Essayez de modifier vos crit√®res de recherche ou choisissez une autre cat√©gorie</p>
      </div>
    </main>
  </div>

  <!-- MODAL PANIER -->
  <div class="backdrop" id="cartBackdrop"></div>
  <aside class="cartModal" id="cartModal">
    <div class="cartHeader">
      <h3>üìã Votre Commande</h3>
      <button class="btn" id="closeCartBtn">Fermer</button>
    </div>
    <div class="cartBody">
      <div style="text-align:center; padding:20px; color:var(--muted);">
        Votre panier est vide. Ajoutez des produits pour continuer.
      </div>
    </div>
  </aside>

  <!-- MODAL QR CODE -->
  <div class="qrModal" id="qrModal">
    <div class="qrBox">
      <h3>üì± QR Code du Site</h3>
      <img src="qr-maxi-jdc-market.jpg" alt="QR Code MAXI JDC MARKET" class="qrImage" 
           onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://maxi-jdc-market.tn'">
      <div class="qrInfo">
        Scannez ce QR Code pour acc√©der au site MAXI JDC MARKET sur votre t√©l√©phone.<br>
        Partagez-le avec vos amis pour faciliter les commandes !
      </div>
      <button class="btn primary" id="closeQrBtn">Fermer</button>
    </div>
  </div>

<script>
/* ===================== CONFIGURATION ===================== */
const CONFIG = {
  minOrder: 15,
  freeShipping: 30,
  shippingFee: 3,
  whatsapp: "21625600978",
  perPage: 12
};

const CATEGORIES = [
  { key:"animaux_compagnie", label:"üêï Animaux", file:"data/animaux_compagnie.csv" },
  { key:"bebe_maman", label:"üë∂ B√©b√©", file:"data/bebe_maman.csv" },
  { key:"boulangerie_patisserie", label:"ü•ñ Boulangerie", file:"data/boulangerie_patisserie.csv" },
  { key:"cafe", label:"‚òï Caf√©", file:"data/cafe.csv" },
  { key:"chips_snacks", label:"üçø Snacks", file:"data/chips_snacks.csv" },
  { key:"chocolats_biscuits", label:"üç´ Chocolats", file:"data/chocolats_biscuits.csv" },
  { key:"conserves", label:"ü•´ Conserves", file:"data/conserves.csv" },
  { key:"cuisine_monde", label:"üåç Cuisine Monde", file:"data/cuisine_monde.csv" },
  { key:"eaux", label:"üíß Eaux", file:"data/eaux.csv" },
  { key:"epicerie_salee", label:"üßÇ √âpicerie Sal√©e", file:"data/epicerie_salee.csv" },
  { key:"epicerie_sucree", label:"üç¨ √âpicerie Sucr√©e", file:"data/epicerie_sucree.csv" },
  { key:"fromage_charcuterie", label:"üßÄ Fromage", file:"data/fromage_charcuterie.csv" },
  { key:"fruits_legumes", label:"üçé Fruits & L√©gumes", file:"data/fruits_legumes.csv" },
  { key:"fruits_secs_noix", label:"üå∞ Fruits Secs", file:"data/fruits_secs_noix.csv" },
  { key:"hygiene_entretien", label:"üßº Hygi√®ne", file:"data/hygiene_entretien.csv" },
  { key:"hygiene_soins", label:"üß¥ Soins", file:"data/hygiene_soins.csv" },
  { key:"jus_boissons", label:"ü•§ Jus & Boissons", file:"data/jus_boissons.csv" },
  { key:"lait_oeufs_produits_frais", label:"ü•õ Produits Frais", file:"data/lait_oeufs_produits_frais.csv" },
  { key:"pates", label:"üçù P√¢tes", file:"data/pates.csv" },
  { key:"produits_surgeles", label:"‚ùÑÔ∏è Surgel√©s", file:"data/produits_surgeles.csv" },
  { key:"vipa_selections", label:"‚≠ê VIPA", file:"data/vipa_selections.csv" }
];

/* ===================== √âTAT DE L'APPLICATION ===================== */
const state = {
  products: new Map(),
  activeCategory: "cafe",
  showAll: false,
  search: "",
  page: 1,
  quantities: {},
  cart: {},
  stock: JSON.parse(localStorage.getItem("stock") || "{}")
};

/* ===================== UTILITAIRES ===================== */
const $ = (id) => document.getElementById(id);
const formatPrice = (price) => `${Number(price).toFixed(2).replace(".", ",")} dt`;

function saveToStorage() {
  localStorage.setItem("cart", JSON.stringify(state.cart));
  localStorage.setItem("stock", JSON.stringify(state.stock));
}

function loadFromStorage() {
  const cart = localStorage.getItem("cart");
  if (cart) state.cart = JSON.parse(cart);
}

function getCartTotal() {
  return Object.values(state.cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
}

function getCartCount() {
  return Object.values(state.cart).reduce((sum, item) => sum + item.quantity, 0);
}

/* ===================== AFFICHAGE DES PRODUITS ===================== */
function renderProducts() {
  const container = $("products");
  const noProducts = $("noProducts");
  
  // R√©cup√©rer les produits visibles
  let products = [];
  if (state.showAll) {
    CATEGORIES.forEach(cat => {
      const catProducts = state.products.get(cat.key) || [];
      products.push(...catProducts.map(p => ({ ...p, category: cat.label })));
    });
  } else {
    products = state.products.get(state.activeCategory) || [];
  }
  
  // Filtrer par recherche
  if (state.search) {
    const query = state.search.toLowerCase();
    products = products.filter(p => 
      p.name.toLowerCase().includes(query) || 
      p.code.toLowerCase().includes(query)
    );
  }
  
  // Pagination
  const totalPages = Math.ceil(products.length / CONFIG.perPage);
  const start = (state.page - 1) * CONFIG.perPage;
  const end = start + CONFIG.perPage;
  const pageProducts = products.slice(start, end);
  
  // Mettre √† jour les informations
  $("productCount").textContent = products.length;
  $("pageInfo").textContent = `Page ${state.page}/${totalPages}`;
  $("prevPageBtn").disabled = state.page <= 1;
  $("nextPageBtn").disabled = state.page >= totalPages;
  
  if (products.length === 0) {
    container.innerHTML = "";
    noProducts.style.display = "block";
    return;
  }
  
  noProducts.style.display = "none";
  container.innerHTML = "";
  
  pageProducts.forEach(product => {
    const productId = `${product.category}_${product.code}`;
    const quantity = state.quantities[productId] || 0;
    const inStock = state.stock[product.code] !== false;
    
    const card = document.createElement("div");
    card.className = "productCard";
    
    card.innerHTML = `
      <div class="productImage">
        <img src="images/products/${product.code}.jpg" alt="${product.name}"
             onerror="this.style.display='none'; this.parentElement.querySelector('.noImage').style.display='flex';">
        <div class="noImage" style="display:none;">Image non disponible</div>
      </div>
      
      <div class="cardContent">
        <div class="productHeader">
          <div class="productName">${product.name}</div>
          <div class="productPrice">${formatPrice(product.price)}</div>
        </div>
        
        <div class="productMeta">
          <div class="metaRow">üè∑Ô∏è Code: ${product.code}</div>
          <div class="metaRow">üìÅ Cat√©gorie: ${product.category || "G√©n√©ral"}</div>
        </div>
        
        <div class="productActions">
          <div class="stepper">
            <button class="decrease">‚àí</button>
            <span>${quantity}</span>
            <button class="increase">+</button>
          </div>
          
          <button class="stockIndicator ${inStock ? 'inStock' : 'outOfStock'}">
            ${inStock ? '‚úì Disponible' : '‚úó Rupture'}
          </button>
          
          <button class="addToCartBtn" ${quantity === 0 || !inStock ? 'disabled' : ''}>
            üõí ${quantity === 0 ? 'Ajouter' : `Ajouter (${quantity})`}
          </button>
        </div>
      </div>
    `;
    
    // Gestion des √©v√©nements
    const decreaseBtn = card.querySelector('.decrease');
    const increaseBtn = card.querySelector('.increase');
    const addBtn = card.querySelector('.addToCartBtn');
    const stockBtn = card.querySelector('.stockIndicator');
    
    decreaseBtn.onclick = () => {
      if (state.quantities[productId] > 0) {
        state.quantities[productId]--;
        renderProducts();
      }
    };
    
    increaseBtn.onclick = () => {
      state.quantities[productId] = (state.quantities[productId] || 0) + 1;
      renderProducts();
    };
    
    addBtn.onclick = () => {
      const qty = state.quantities[productId];
      if (qty > 0) {
        const cartKey = `${product.code}_${product.name}`;
        if (state.cart[cartKey]) {
          state.cart[cartKey].quantity += qty;
        } else {
          state.cart[cartKey] = {
            name: product.name,
            code: product.code,
            price: product.price,
            category: product.category,
            quantity: qty
          };
        }
        state.quantities[productId] = 0;
        saveToStorage();
        updateCartDisplay();
        animateCartButton();
      }
    };
    
    stockBtn.onclick = () => {
      state.stock[product.code] = !inStock;
      saveToStorage();
      renderProducts();
    };
    
    container.appendChild(card);
  });
}

/* ===================== CAT√âGORIES ===================== */
function renderCategories() {
  const container = $("categories");
  container.innerHTML = "";
  
  // Bouton "Tous"
  const allBtn = document.createElement("button");
  allBtn.className = `catBtn ${state.showAll ? 'active' : ''}`;
  allBtn.innerHTML = `üåê Tous <span class="catCount">${getTotalProductCount()}</span>`;
  allBtn.onclick = () => {
    state.showAll = true;
    state.page = 1;
    updatePageTitle();
    renderProducts();
    renderCategories();
  };
  container.appendChild(allBtn);
  
  // Boutons par cat√©gorie
  CATEGORIES.forEach(cat => {
    const btn = document.createElement("button");
    btn.className = `catBtn ${!state.showAll && state.activeCategory === cat.key ? 'active' : ''}`;
    const count = state.products.get(cat.key)?.length || 0;
    btn.innerHTML = `${cat.label} <span class="catCount">${count}</span>`;
    btn.onclick = () => {
      state.showAll = false;
      state.activeCategory = cat.key;
      state.page = 1;
      updatePageTitle();
      renderProducts();
      renderCategories();
    };
    container.appendChild(btn);
  });
}

function getTotalProductCount() {
  let total = 0;
  CATEGORIES.forEach(cat => {
    total += state.products.get(cat.key)?.length || 0;
  });
  return total;
}

function updatePageTitle() {
  if (state.showAll) {
    $("pageTitle").textContent = "üéØ Tous les produits";
    $("pageSubtitle").textContent = "Parcourez notre catalogue complet";
  } else {
    const cat = CATEGORIES.find(c => c.key === state.activeCategory);
    $("pageTitle").textContent = cat?.label || "Produits";
    $("pageSubtitle").textContent = "Choisissez vos articles pr√©f√©r√©s";
  }
}

/* ===================== PANIER ===================== */
function updateCartDisplay() {
  const count = getCartCount();
  $("cartCount").textContent = count;
  
  // Animation du bouton panier
  if (count > parseInt($("cartCount").textContent)) {
    animateCartButton();
  }
}

function animateCartButton() {
  const btn = $("cartBtn");
  btn.animate([
    { transform: 'scale(1)' },
    { transform: 'scale(1.1)' },
    { transform: 'scale(1)' }
  ], {
    duration: 300,
    easing: 'ease-out'
  });
}

/* ===================== CHARGEMENT DES DONN√âES ===================== */
async function loadProducts() {
  try {
    for (const category of CATEGORIES) {
      const response = await fetch(category.file);
      if (response.ok) {
        const text = await response.text();
        const products = parseCSV(text).map(p => ({
          ...p,
          category: category.label
        }));
        state.products.set(category.key, products);
      }
    }
    renderCategories();
    updatePageTitle();
    renderProducts();
  } catch (error) {
    console.error("Erreur chargement produits:", error);
  }
}

function parseCSV(text) {
  const lines = text.split('\n');
  const products = [];
  
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('CODE_ARTICLE') || trimmed.includes('PRIX')) continue;
    
    const parts = trimmed.split('\t').length > 1 ? trimmed.split('\t') : trimmed.split(';');
    if (parts.length >= 3) {
      const code = parts[0].trim();
      const name = parts[1].trim();
      const price = parseFloat(parts[2].replace(',', '.'));
      
      if (code && name && !isNaN(price)) {
        products.push({ code, name, price });
      }
    }
  }
  
  return products;
}

/* ===================== GESTION DES √âV√âNEMENTS ===================== */
function initEventListeners() {
  // Recherche
  $("searchInput").addEventListener("input", (e) => {
    state.search = e.target.value;
    state.page = 1;
    renderProducts();
  });
  
  $("clearBtn").onclick = () => {
    $("searchInput").value = "";
    state.search = "";
    state.page = 1;
    renderProducts();
  };
  
  $("allProductsBtn").onclick = () => {
    state.showAll = true;
    state.page = 1;
    updatePageTitle();
    renderProducts();
    renderCategories();
  };
  
  // Pagination
  $("prevPageBtn").onclick = () => {
    if (state.page > 1) {
      state.page--;
      renderProducts();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };
  
  $("nextPageBtn").onclick = () => {
    state.page++;
    renderProducts();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  // Panier
  $("cartBtn").onclick = () => {
    $("cartModal").classList.add("open");
    $("cartBackdrop").classList.add("open");
  };
  
  $("closeCartBtn").onclick = () => {
    $("cartModal").classList.remove("open");
    $("cartBackdrop").classList.remove("open");
  };
  
  $("cartBackdrop").onclick = () => {
    $("cartModal").classList.remove("open");
    $("cartBackdrop").classList.remove("open");
  };
  
  // QR Code
  $("qrBtn").onclick = () => {
    $("qrModal").classList.add("open");
  };
  
  $("closeQrBtn").onclick = () => {
    $("qrModal").classList.remove("open");
  };
  
  $("qrModal").onclick = (e) => {
    if (e.target === $("qrModal")) {
      $("qrModal").classList.remove("open");
    }
  };
}

/* ===================== INITIALISATION ===================== */
document.addEventListener('DOMContentLoaded', () => {
  loadFromStorage();
  initEventListeners();
  updateCartDisplay();
  loadProducts();
});
</script>
</body>
</html>
