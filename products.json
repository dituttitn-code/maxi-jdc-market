<!-- tools/generate-json.html -->
<!DOCTYPE html>
<html>
<head>
    <title>G√©n√©rateur products.json</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        h2 { color: #2c3e50; }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            font-size: 16px; 
            border-radius: 5px; 
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover { background: #2980b9; }
        #status { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .loading { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .stats { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <h2>üõ†Ô∏è G√©n√©rateur products.json</h2>
    <p>Cet outil g√©n√®re un fichier JSON √† partir de vos CSV.</p>
    
    <button onclick="generateJSON()">üì¶ G√©n√©rer products.json</button>
    <button onclick="generateTestJSON()">üß™ G√©n√©rer JSON de test (20 produits)</button>
    
    <div id="status"></div>
    <div id="stats" class="stats"></div>
    
    <script>
        // Mapping des cat√©gories
        const categoryMapping = {
            'animaux_compagnie': 'Animaux de Compagnie',
            'cafe': 'Caf√© et Th√©',
            'chips_snacks': 'Chips et Snacks',
            'chocolats_biscuits': 'Chocolats et Biscuits',
            'hygiene_soins': 'Hygi√®ne et Soins',
            'jus_boissons': 'Jus et Boissons',
            'lait_oeufs_produits_frais': 'Lait, ≈íufs et Produits Frais',
            'fruits_legumes': 'Fruits et L√©gumes',
            'epicerie_sucree': '√âpicerie Sucr√©e',
            'epicerie_salee': '√âpicerie Sal√©e',
            'produits_surgeles': 'Produits Surgel√©s',
            'fromage_charcuterie': 'Fromage et Charcuterie',
            'fruits_secs_noix': 'Fruits Secs et Noix',
            'hygiene_entretien': 'Hygi√®ne et Entretien',
            'bebe_maman': 'B√©b√© et Maman',
            'boulangerie_patisserie': 'Boulangerie et P√¢tisserie',
            'conserves': 'Conserves',
            'cuisine_monde': 'Cuisine du Monde',
            'eaux': 'Eaux',
            'pates': 'P√¢tes et Riz',
            'vipa_selections': 'S√©lections VIPA'
        };

        async function generateJSON() {
            const status = document.getElementById('status');
            const stats = document.getElementById('stats');
            
            status.innerHTML = '<div class="loading">‚è≥ Chargement des CSV...</div>';
            stats.innerHTML = '';
            
            try {
                let allProducts = [];
                const csvFiles = Object.keys(categoryMapping);
                
                // Charger chaque fichier CSV
                for (const csvFile of csvFiles) {
                    try {
                        const response = await fetch(`../data/${csvFile}.csv`);
                        if (!response.ok) continue;
                        
                        const csvText = await response.text();
                        const lines = csvText.split('\n');
                        
                        // Parser chaque ligne (sauter l'en-t√™te)
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // S√©parateur : tabulation ou point-virgule
                            const separator = line.includes('\t') ? '\t' : ';';
                            const parts = line.split(separator);
                            
                            if (parts.length >= 3) {
                                const id = parseInt(parts[0].trim()) || Date.now() + i;
                                const name = parts[1].trim();
                                const price = parseFloat(parts[2].trim().replace(',', '.'));
                                
                                if (!isNaN(price) && name) {
                                    allProducts.push({
                                        id: id,
                                        name: name,
                                        category: csvFile,
                                        categoryName: categoryMapping[csvFile],
                                        price: price,
                                        stock: true,
                                        image: `images/${id}.jpg`,
                                        description: name
                                    });
                                }
                            }
                        }
                        
                        console.log(`‚úì ${categoryMapping[csvFile]}: charg√©`);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Erreur avec ${csvFile}:`, error);
                    }
                }
                
                // Statistiques
                const categoriesCount = {};
                allProducts.forEach(p => {
                    categoriesCount[p.categoryName] = (categoriesCount[p.categoryName] || 0) + 1;
                });
                
                // Cr√©er l'objet final
                const data = {
                    total: allProducts.length,
                    lastUpdated: new Date().toISOString(),
                    categories: Object.values(categoryMapping),
                    products: allProducts
                };
                
                // T√©l√©charger
                const jsonStr = JSON.stringify(data, null, 2);
                downloadFile(jsonStr, 'products.json');
                
                // Afficher les stats
                let statsHTML = `<h3>üìä Statistiques :</h3>`;
                statsHTML += `<p><strong>Total produits :</strong> ${allProducts.length}</p>`;
                statsHTML += `<p><strong>Cat√©gories :</strong> ${Object.keys(categoriesCount).length}</p>`;
                statsHTML += `<h4>D√©tail par cat√©gorie :</h4><ul>`;
                for (const [cat, count] of Object.entries(categoriesCount)) {
                    statsHTML += `<li>${cat}: ${count} produits</li>`;
                }
                statsHTML += `</ul>`;
                
                stats.innerHTML = statsHTML;
                status.innerHTML = '<div class="success">‚úÖ products.json g√©n√©r√© avec succ√®s !</div>';
                
            } catch (error) {
                status.innerHTML = `<div class="error">‚ùå Erreur : ${error.message}</div>`;
                console.error(error);
            }
        }

        function generateTestJSON() {
            // Produits de test
            const testProducts = [
                {
                    id: 4731,
                    name: "VANCAT COMPACT LAVENDER 5KG",
                    category: "animaux_compagnie",
                    categoryName: "Animaux de Compagnie",
                    price: 19.4,
                    stock: true,
                    image: "images/4731.jpg",
                    description: "Liti√®re pour chat parfum lavande"
                },
                {
                    id: 1114,
                    name: "NESCAFE CLASSIC 45G",
                    category: "cafe",
                    categoryName: "Caf√© et Th√©",
                    price: 9.5,
                    stock: true,
                    image: "images/1114.jpg",
                    description: "Caf√© soluble Nescaf√© Classic 45g"
                },
                // ... ajoutez 18 autres produits de test
            ];
            
            const data = {
                total: testProducts.length,
                lastUpdated: new Date().toISOString(),
                categories: [...new Set(testProducts.map(p => p.categoryName))],
                products: testProducts
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            downloadFile(jsonStr, 'products-test.json');
            
            document.getElementById('status').innerHTML = 
                '<div class="success">‚úÖ Fichier de test g√©n√©r√© (20 produits)</div>';
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
